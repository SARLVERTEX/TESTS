<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D4AF37">
    <meta name="description" content="Vertex Monaco - Syst√®me de gestion technico-commercial Digital Signage">
    <link rel="manifest" href="manifest.json">
    <title>Vertex Monaco | Digital Signage PRO V2.0</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Darker+Grotesque:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ========== VARIABLES ========== */
        :root { 
            --gold: #D4AF37; 
            --gold-dark: #B8941F;
            --gold-light: #F5E6B3;
            --bg: #000; 
            --card: #121212; 
            --text: #fff; 
            --danger: #ff4d4d; 
            --success: #2ecc71; 
            --border: #282828;
            --warning: #f39c12;
            --info: #3498db;
            --accent: #e74c3c;
            --purple: #9b59b6;
            --shadow: rgba(212, 175, 55, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #fafafa;
            --card: #ffffff;
            --text: #1a1a1a;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        /* ========== RESET & BASE ========== */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Darker Grotesque', sans-serif; 
            line-height: 1.5; 
            overflow-x: hidden; 
            transition: background 0.3s, color 0.3s;
            font-size: 16px;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            padding-bottom: 100px; 
        }
        
        /* ========== TYPOGRAPHY ========== */
        h1, h2, h3 { 
            font-weight: 900; 
            letter-spacing: -0.02em; 
            margin: 0;
        }
        
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }
        
        .mono { 
            font-family: 'Space Mono', monospace; 
            letter-spacing: 0.05em;
        }
        
        /* ========== HEADER ========== */
        .header { 
            text-align: center; 
            padding: 30px 0; 
            border-bottom: 3px solid var(--gold); 
            margin-bottom: 30px; 
            position: relative;
            background: linear-gradient(135deg, var(--card) 0%, var(--bg) 100%);
        }
        
        .header h1 { 
            letter-spacing: 8px; 
            font-size: 24px; 
            color: var(--gold); 
            margin: 0; 
            font-weight: 900;
            text-shadow: 2px 2px 8px var(--shadow);
        }
        
        .header-subtitle {
            font-size: 11px;
            color: var(--gold-light);
            letter-spacing: 3px;
            margin-top: 8px;
            font-weight: 600;
            opacity: 0.8;
        }
        
        .version-badge { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            font-size: 9px; 
            background: var(--gold); 
            color: black; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-weight: bold;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .theme-toggle { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            background: none; 
            border: 2px solid var(--gold); 
            color: var(--gold); 
            padding: 8px 15px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: var(--gold);
            color: black;
            transform: rotate(180deg);
        }
        
        /* ========== INDICATORS ========== */
        .offline-indicator { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--danger); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 30px; 
            font-size: 13px; 
            font-weight: bold; 
            z-index: 10000; 
            display: none;
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.4);
        }
        
        .offline-indicator.active { 
            display: block; 
            animation: pulse 2s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); } 
            50% { opacity: 0.8; transform: translateX(-50%) scale(1.02); } 
        }
        
        .sync-indicator { 
            position: fixed; 
            top: 100px; 
            right: 20px; 
            background: var(--info); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 25px; 
            font-size: 11px; 
            font-weight: bold; 
            z-index: 9999; 
            display: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .sync-indicator.active { 
            display: block; 
            animation: slideInRight 0.3s; 
        }
        
        @keyframes slideInRight {
            from { transform: translateX(150px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ========== TOAST ========== */
        .toast { 
            position: fixed; 
            top: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--success); 
            color: white; 
            padding: 16px 30px; 
            border-radius: 12px; 
            font-size: 14px; 
            font-weight: bold; 
            z-index: 9999; 
            animation: toastSlide 0.3s ease;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }
        
        @keyframes toastSlide { 
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; } 
            to { transform: translateX(-50%) translateY(0); opacity: 1; } 
        }
        
        /* ========== PROGRESS BAR ========== */
        .progress-bar { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 18px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            z-index: 0;
        }
        
        .progress-step { 
            flex: 1; 
            text-align: center; 
            position: relative;
            z-index: 1;
        }
        
        .progress-dot { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: var(--card); 
            border: 3px solid var(--border);
            margin: 0 auto 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: 900;
            transition: all 0.3s;
        }
        
        .progress-step.active .progress-dot { 
            background: var(--gold); 
            color: black; 
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--shadow);
            transform: scale(1.1);
        }
        
        .progress-step.completed .progress-dot { 
            background: var(--success); 
            color: white; 
            border-color: var(--success);
        }
        
        .progress-label { 
            font-size: 11px; 
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* ========== LOADING SPINNER ========== */
        .spinner-container {
            text-align: center;
            padding: 40px 0;
        }
        
        .spinner { 
            border: 4px solid var(--border); 
            border-top: 4px solid var(--gold); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 0.8s linear infinite; 
            margin: 0 auto 15px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .spinner-text {
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }
        
        /* ========== TABS ========== */
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab-btn { 
            flex: 1; 
            min-width: 100px; 
            padding: 14px 20px; 
            background: transparent; 
            border: none;
            color: #666; 
            border-radius: 0;
            font-size: 13px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gold);
            transform: scaleX(0);
            transition: transform 0.3s;
        }
        
        .tab-btn.active { 
            color: var(--gold);
        }
        
        .tab-btn.active::after {
            transform: scaleX(1);
        }
        
        .tab-btn:hover {
            color: var(--gold-light);
        }
        
        /* ========== TYPE CHIPS ========== */
        .type-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        
        .type-chip { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 16px; 
            border-radius: 12px; 
            text-align: center; 
            font-size: 12px; 
            font-weight: 900; 
            color: #666; 
            cursor: pointer; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .type-chip.selected { 
            border-color: var(--gold); 
            color: var(--gold); 
            background: rgba(212, 175, 55, 0.15);
            box-shadow: 0 0 20px var(--shadow);
            transform: translateY(-2px);
        }
        
        .type-chip:hover {
            border-color: var(--gold-light);
            transform: translateY(-2px);
        }
        
        .type-chip:active { 
            transform: scale(0.95); 
        }
        
        /* ========== STAFF GRID ========== */
        .staff-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
        }
        
        .staff-chip { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 14px; 
            border-radius: 10px; 
            font-size: 13px; 
            text-align: center; 
            color: #888; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 700;
        }
        
        .staff-chip.selected { 
            background: var(--gold); 
            color: #000; 
            font-weight: 900; 
            border-color: var(--gold);
            box-shadow: 0 4px 15px var(--shadow);
            transform: translateY(-2px);
        }
        
        .staff-chip:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
        }
        
        .staff-chip:active { 
            transform: scale(0.95); 
        }

        /* ========== CHECKLIST ========== */
        .check-item { 
            display: flex; 
            align-items: center; 
            background: var(--card); 
            padding: 16px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border: 2px solid var(--border); 
            transition: all 0.3s;
        }
        
        .check-item:has(input:checked) { 
            background: rgba(46, 204, 113, 0.15); 
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.2);
        }
        
        .check-item input { 
            width: 24px; 
            height: 24px; 
            margin-right: 15px; 
            accent-color: var(--gold); 
            cursor: pointer;
        }
        
        .check-item label {
            flex: 1;
            cursor: pointer;
            user-select: none;
            margin: 0;
            font-weight: 600;
        }

        /* ========== RECEPTION PRODUIT ========== */
        .reception-section {
            background: var(--card);
            border: 2px solid var(--info);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .reception-section h4 {
            color: var(--info);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 0 0 15px 0;
            font-weight: 900;
        }

        .product-item {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .product-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .product-name {
            font-weight: 900;
            color: var(--gold);
            font-size: 15px;
        }

        .product-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-ok { background: var(--success); color: white; }
        .status-defect { background: var(--danger); color: white; }
        .status-partial { background: var(--warning); color: black; }

        .product-details {
            font-size: 13px;
            color: #888;
            margin-top: 8px;
        }

        .product-tests {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .test-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .test-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: var(--success);
        }

        .test-item label {
            font-size: 12px;
            font-weight: 600;
        }

        /* √Ä suivre dans la partie 2... */
    </style>
</head>
<body>
<!-- Le HTML sera dans la partie 2 -->

<style>
/* ========== SUITE DES STYLES (apr√®s .test-item label) ========== */

/* ========== PHOTO SYSTEM ========== */
.photo-box { 
    background: var(--card); 
    border: 2px solid var(--border); 
    padding: 20px; 
    border-radius: 15px; 
    margin-top: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.photo-box h4 { 
    margin: 0 0 15px 0; 
    font-size: 12px; 
    color: var(--gold); 
    text-transform: uppercase; 
    letter-spacing: 2px;
    font-weight: 900;
}

.photo-gallery { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 15px; 
    margin-top: 15px; 
}

.photo-card { 
    background: var(--bg); 
    padding: 12px; 
    border-radius: 12px; 
    border: 2px solid var(--border); 
    position: relative;
    transition: all 0.3s;
}

.photo-card:hover {
    border-color: var(--gold);
    box-shadow: 0 4px 20px var(--shadow);
}

.photo-card img { 
    width: 100%; 
    border-radius: 8px; 
    margin-bottom: 10px; 
    max-height: 400px; 
    object-fit: contain; 
    cursor: pointer; 
    transition: transform 0.3s;
    background: #1a1a1a;
}

.photo-card img:hover { 
    transform: scale(1.02); 
}

.photo-input { 
    background: var(--bg); 
    border: 1px solid var(--border); 
    color: var(--text); 
    padding: 10px; 
    font-size: 13px; 
    width: 100%; 
    border-radius: 6px; 
    margin-bottom: 8px;
    font-family: 'Darker Grotesque', sans-serif;
    font-weight: 600;
}

.photo-size { 
    font-size: 10px; 
    color: #666; 
    margin-bottom: 8px;
    font-family: 'Space Mono', monospace;
}

.photo-controls { 
    display: flex; 
    gap: 8px; 
    margin-top: 8px;
    flex-wrap: wrap;
}

.photo-controls button { 
    flex: 1; 
    min-width: 80px;
    padding: 8px 12px; 
    font-size: 10px; 
    border-radius: 6px; 
    border: 1px solid var(--border); 
    background: var(--card); 
    color: var(--text); 
    cursor: pointer;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.2s;
}

.photo-controls button:hover {
    border-color: var(--gold);
    background: rgba(212, 175, 55, 0.1);
}

/* ========== ANNOTATION CANVAS ========== */
.annotation-container {
    position: relative;
    margin-bottom: 10px;
    border-radius: 8px;
    overflow: hidden;
}

.annotation-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: crosshair;
    z-index: 10;
}

.annotation-tools {
    display: flex;
    gap: 8px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 8px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.annotation-tool-btn {
    padding: 8px 12px;
    background: var(--card);
    border: 2px solid var(--border);
    color: var(--text);
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 700;
    transition: all 0.2s;
    text-transform: uppercase;
}

.annotation-tool-btn.active {
    background: var(--gold);
    color: black;
    border-color: var(--gold);
}

.color-picker {
    width: 40px;
    height: 36px;
    border: 2px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
}

.measure-input {
    flex: 1;
    min-width: 120px;
    padding: 8px;
    background: var(--card);
    border: 2px solid var(--border);
    color: var(--text);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
}

/* ========== SIGNATURE ========== */
#sig-canvas { 
    background: #fff; 
    border: 3px solid var(--gold); 
    border-radius: 12px; 
    touch-action: none; 
    width: 100%; 
    height: 250px; 
    cursor: crosshair;
    box-shadow: 0 4px 20px var(--shadow);
}

/* ========== BUTTONS ========== */
.btn-gold { 
    width: 100%; 
    padding: 20px; 
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
    color: black; 
    border: none; 
    font-weight: 900; 
    border-radius: 12px; 
    text-transform: uppercase; 
    margin-top: 20px; 
    cursor: pointer; 
    transition: all 0.3s;
    font-size: 15px;
    letter-spacing: 0.1em;
    box-shadow: 0 6px 20px var(--shadow);
}

.btn-gold:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--shadow);
}

.btn-gold:active { 
    transform: scale(0.98); 
}

.btn-gold:disabled { 
    opacity: 0.5; 
    cursor: not-allowed;
    transform: none;
}

.btn-outline { 
    width: 100%; 
    padding: 14px 20px; 
    background: transparent; 
    color: var(--text); 
    border: 2px solid var(--border); 
    border-radius: 10px; 
    margin-top: 10px; 
    cursor: pointer; 
    transition: all 0.3s;
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.btn-outline:hover {
    border-color: var(--gold);
    background: rgba(212, 175, 55, 0.1);
    transform: translateY(-2px);
}

.btn-now { 
    background: var(--card); 
    color: var(--gold); 
    border: 2px solid var(--gold); 
    padding: 10px; 
    border-radius: 8px; 
    font-size: 11px; 
    margin-top: 8px; 
    width: 100%; 
    cursor: pointer; 
    transition: all 0.3s;
    font-weight: 700;
    text-transform: uppercase;
}

.btn-now:hover {
    background: var(--gold);
    color: black;
}

.btn-danger { 
    width: 100%; 
    padding: 14px 20px; 
    background: rgba(255, 77, 77, 0.1); 
    color: var(--danger); 
    border: 2px solid var(--danger); 
    border-radius: 10px; 
    margin-top: 30px; 
    font-size: 12px; 
    font-weight: bold; 
    cursor: pointer; 
    transition: all 0.3s;
    text-transform: uppercase;
}

.btn-danger:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-2px);
}

/* ========== FORM INPUTS ========== */
label { 
    display: block; 
    margin: 20px 0 8px 0; 
    font-size: 12px; 
    font-weight: 900; 
    color: var(--gold); 
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

input:not([type="checkbox"]):not([type="file"]), 
textarea, 
select { 
    width: 100%; 
    padding: 14px; 
    background: var(--card); 
    border: 2px solid var(--border); 
    color: var(--text); 
    border-radius: 10px; 
    font-size: 15px;
    font-family: 'Darker Grotesque', sans-serif;
    font-weight: 600;
    transition: all 0.3s;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 20px var(--shadow);
}

textarea { 
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
}

/* ========== CARDS ========== */
.folder-card { 
    background: var(--card); 
    border: 2px solid var(--border); 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 12px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    cursor: pointer; 
    transition: all 0.3s;
}

.folder-card:hover { 
    border-color: var(--gold); 
    background: rgba(212, 175, 55, 0.08);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow);
}

.folder-info { 
    flex: 1; 
}

.folder-name { 
    font-weight: 900; 
    font-size: 18px; 
    margin-bottom: 6px;
    color: var(--gold);
}

.folder-meta { 
    font-size: 12px; 
    color: #666;
    font-family: 'Space Mono', monospace;
}

.folder-arrow { 
    color: var(--gold); 
    font-size: 28px;
    transition: transform 0.3s;
}

.folder-card:hover .folder-arrow {
    transform: translateX(5px);
}

/* ========== STATS CARDS ========== */
.stats-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
    gap: 12px; 
    margin: 20px 0; 
}

.stat-card { 
    background: var(--card); 
    border: 2px solid var(--border); 
    padding: 20px; 
    border-radius: 12px; 
    text-align: center;
    transition: all 0.3s;
}

.stat-card:hover {
    border-color: var(--gold);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px var(--shadow);
}

.stat-value { 
    font-size: 32px; 
    font-weight: 900; 
    color: var(--gold);
    font-family: 'Space Mono', monospace;
}

.stat-label { 
    font-size: 10px; 
    color: #666; 
    text-transform: uppercase; 
    margin-top: 8px;
    letter-spacing: 0.05em;
    font-weight: 700;
}

/* ========== TIMELINE ========== */
.timeline-item { 
    border-left: 4px solid var(--gold); 
    padding-left: 25px; 
    margin-bottom: 50px; 
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 0;
    width: 12px;
    height: 12px;
    background: var(--gold);
    border-radius: 50%;
    box-shadow: 0 0 15px var(--shadow);
}

.section-block { 
    background: var(--card); 
    padding: 15px; 
    border-radius: 10px; 
    margin-bottom: 10px; 
    border-left: 3px solid var(--border);
    font-size: 14px; 
    border: 2px solid var(--border);
    transition: all 0.3s;
}

.section-block:hover {
    border-left-color: var(--gold);
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
}

/* ========== MODALS ========== */
.modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    background: rgba(0,0,0,0.9); 
    z-index: 10000; 
    align-items: center; 
    justify-content: center; 
    padding: 20px;
    backdrop-filter: blur(10px);
}

.modal.active { 
    display: flex; 
    animation: fadeIn 0.3s; 
}

.modal-content { 
    background: var(--card); 
    border: 3px solid var(--gold); 
    border-radius: 15px; 
    padding: 30px; 
    max-width: 500px; 
    width: 90%; 
    max-height: 80vh; 
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-title { 
    font-size: 20px; 
    font-weight: 900; 
    color: var(--gold); 
    margin-bottom: 20px;
    text-transform: uppercase;
}

.modal-body { 
    font-size: 14px; 
    margin-bottom: 25px; 
    line-height: 1.6;
    font-weight: 600;
}

.modal-actions { 
    display: flex; 
    gap: 12px; 
}

.modal-btn { 
    flex: 1; 
    padding: 14px; 
    border-radius: 10px; 
    border: none; 
    font-weight: 900; 
    cursor: pointer;
    font-size: 13px;
    text-transform: uppercase;
    transition: all 0.3s;
}

.modal-btn.confirm { 
    background: var(--gold); 
    color: black;
    box-shadow: 0 4px 15px var(--shadow);
}

.modal-btn.cancel { 
    background: transparent; 
    color: var(--text); 
    border: 2px solid var(--border); 
}

/* ========== IMAGE MODAL ========== */
.image-modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    background: rgba(0,0,0,0.95); 
    z-index: 10001; 
    align-items: center; 
    justify-content: center; 
    padding: 20px;
    backdrop-filter: blur(10px);
}

.image-modal.active { 
    display: flex; 
    animation: fadeIn 0.3s; 
}

.image-modal img { 
    max-width: 100%; 
    max-height: 90vh; 
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.image-modal-close { 
    position: absolute; 
    top: 30px; 
    right: 30px; 
    background: var(--danger); 
    color: white; 
    border: none; 
    padding: 12px 20px; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: bold;
    font-size: 14px;
    transition: all 0.3s;
}

/* ========== ANIMATIONS ========== */
@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

/* ========== RESPONSIVE ========== */
@media (max-width: 600px) {
    .header h1 {
        font-size: 20px;
        letter-spacing: 4px;
    }
    
    .type-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
}

/* ========== STEP CONTAINER ========== */
.step { 
    display: none; 
    animation: fadeIn 0.3s ease; 
}

.step.active { 
    display: block; 
}

/* ========== UTILITY CLASSES ========== */
.no-print { }
@media print { 
    .no-print { display: none !important; } 
}
</style>

<!-- ========== D√âBUT DU HTML ========== -->


<!-- Indicators -->
<div class="offline-indicator" id="offlineIndicator">üì° MODE HORS LIGNE</div>
<div class="sync-indicator" id="syncIndicator">üîÑ Synchronisation...</div>

<div class="container">
    <!-- Header -->
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        <h1>VERTEX MONACO</h1>
        <p class="header-subtitle">DIGITAL SIGNAGE PRO | V2.0</p>
        <div class="version-badge">v2.0</div>
    </div>

    <!-- HOME / PROJECT LIST -->
    <div class="step active" id="step0">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Projets actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total interventions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-hours">0h</div>
                <div class="stat-label">Total heures</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-month">0</div>
                <div class="stat-label">Ce mois</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('ongoing')">EN COURS</button>
            <button class="tab-btn" onclick="switchTab('done')">ARCHIVES</button>
            <button class="tab-btn" onclick="switchTab('analytics')">STATS</button>
        </div>
        
        <div id="view-list">
            <button class="btn-gold" onclick="showNewProjectOptions()">+ NOUVEAU PROJET</button>
            
            <input type="text" id="searchBar" oninput="filterProjects()" placeholder="üîç Rechercher un projet..." style="margin-top:20px;">
            
            <div id="project-list" style="margin-top:15px;"></div>
            
            <button class="btn-outline" onclick="exportToCSV()" style="margin-top:50px;">üìä EXPORT EXCEL (.CSV)</button>
            <button class="btn-outline" onclick="exportBackup()">üíæ SAUVEGARDER DONN√âES</button>
            <button class="btn-outline" onclick="document.getElementById('import-file').click()">üì• RESTAURER DONN√âES</button>
            <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importBackup(this)">
        </div>

        <div id="view-analytics" style="display:none;">
            <p style="text-align:center; padding:40px 0; color:#666;">Statistiques √† venir...</p>
        </div>
    </div>

    <!-- La suite dans la partie 3 : STEPS 1-5 + JavaScript -->
</div>

<!-- STEP 1: INFO PROJET / R√âCEPTION PRODUIT -->
    <div class="step" id="step1">
        <div class="progress-bar">
            <div class="progress-step active">
                <div class="progress-dot">1</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">2</div>
                <div class="progress-label">Installation</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">3</div>
                <div class="progress-label">Tests</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">4</div>
                <div class="progress-label">Finalisation</div>
            </div>
        </div>

        <h3 id="c-name" style="text-align:center; color:var(--gold); margin-bottom:25px;"></h3>
        
        <label>Type d'intervention *</label>
        <div class="type-grid">
            <div class="type-chip" onclick="selectType(this, 'INSTALLATION')">üñ•Ô∏è INSTALLATION</div>
            <div class="type-chip" onclick="selectType(this, 'MAINTENANCE')">üîß MAINTENANCE</div>
            <div class="type-chip" onclick="selectType(this, 'SAV')">‚ö†Ô∏è SAV</div>
            <div class="type-chip" onclick="selectType(this, 'CONFIGURATION')">‚öôÔ∏è CONFIG</div>
            <div class="type-chip" onclick="selectType(this, 'R√âCEPTION')">üì¶ R√âCEPTION</div>
            <div class="type-chip" onclick="selectType(this, 'AUDIT')">üìä AUDIT SITE</div>
        </div>

        <label>√âquipe sur place *</label>
        <div class="staff-grid">
            <div class="staff-chip" onclick="toggleStaff(this)">Allan</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Pietro</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Marco</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Osvaldo</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Jean-Christophe</div>
        </div>

        <label>Heure d'arriv√©e *</label>
        <input type="time" id="time_in">
        <button class="btn-now" onclick="setTime('time_in')">‚è∞ MAINTENANT</button>

        <div id="gps-info" style="font-size:11px; color: var(--success); margin-top:15px; font-weight:700;"></div>

        <!-- R√âCEPTION PRODUIT (si applicable) -->
        <div id="reception-section" style="display:none;">
            <div class="reception-section">
                <h4>üì¶ R√©ception Mat√©riel</h4>
                <div id="reception-products"></div>
                <button class="btn-outline" onclick="addReceptionProduct()">+ AJOUTER UN PRODUIT</button>
            </div>
        </div>

        <label>Notes / Contexte intervention</label>
        <textarea id="client_context" rows="3" placeholder="Ex: Client souhaite affichage vid√©o wall 3x3, c√¢blage existant, besoin formation utilisateur..."></textarea>

        <button class="btn-gold" onclick="validateStep1()">D√âMARRER L'INTERVENTION</button>
        <button class="btn-outline" onclick="confirmCancel()">ANNULER</button>
    </div>

    <!-- STEP 2: PHOTOS INSTALLATION -->
    <div class="step" id="step2">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">2</div>
                <div class="progress-label">Installation</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">3</div>
                <div class="progress-label">Tests</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">4</div>
                <div class="progress-label">Finalisation</div>
            </div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos AVANT intervention</h4>
            <p style="font-size:12px; color:#888; margin-bottom:10px;">√âtat des lieux initial, ancien mat√©riel, zone d'installation...</p>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'before')" style="display:none;" id="cam-before">
            <button class="btn-outline" onclick="document.getElementById('cam-before').click()">+ AJOUTER PHOTOS AVANT</button>
            <div id="gallery-before" class="photo-gallery"></div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos PENDANT installation</h4>
            <p style="font-size:12px; color:#888; margin-bottom:10px;">C√¢blage, montage, fixations, √©tapes cl√©s...</p>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'during')" style="display:none;" id="cam-during">
            <button class="btn-outline" onclick="document.getElementById('cam-during').click()">+ AJOUTER PHOTOS PENDANT</button>
            <div id="gallery-during" class="photo-gallery"></div>
        </div>

        <button class="btn-gold" onclick="validateStep2()">CONTINUER ‚Üí TESTS</button>
        <button class="btn-outline" onclick="nextStep(1)">‚Üê RETOUR</button>
    </div>

    <!-- STEP 3: TESTS & CONFIGURATION -->
    <div class="step" id="step3">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Installation</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">3</div>
                <div class="progress-label">Tests</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">4</div>
                <div class="progress-label">Finalisation</div>
            </div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos APR√àS installation</h4>
            <p style="font-size:12px; color:#888; margin-bottom:10px;">Installation finale, affichages actifs, r√©sultat...</p>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'after')" style="display:none;" id="cam-after">
            <button class="btn-outline" onclick="document.getElementById('cam-after').click()">+ AJOUTER PHOTOS APR√àS</button>
            <div id="gallery-after" class="photo-gallery"></div>
        </div>

        <label>Mat√©riel install√© / R√©f√©rences *</label>
        <textarea id="task_mat" rows="4" placeholder="Ex:&#10;- √âcran Samsung QM85R-B 85'' 4K (S/N: ABC123456)&#10;- Media Player BrightSign XT1144 (S/N: XYZ789)&#10;- Support mural Chief XTM1U&#10;- C√¢blage HDMI 2.0 Crestron 15m&#10;"></textarea>

        <label>Compte-rendu technique de l'installation *</label>
        <textarea id="task_done" rows="6" placeholder="Ex:&#10;- Installation √©cran 85'' position centrale hall accueil&#10;- Fixation murale renforc√©e (placo + chevilles m√©talliques M12)&#10;- C√¢blage dissimul√© goulotte 50x30mm&#10;- Configuration media player : r√©solution 3840x2160@60Hz, rotation landscape&#10;- Connexion r√©seau Ethernet RJ45 Cat6 sur switch existant VLAN 10&#10;- Configuration CMS BrightAuthor:connected, playlist horaires 8h-20h&#10;- Tests diffusion contenu vid√©o 4K OK"></textarea>

        <label>Configuration r√©seau / Adresses IP</label>
        <textarea id="task_network" rows="3" placeholder="Ex:&#10;Media Player: IP 192.168.1.50 / Masque 255.255.255.0 / Passerelle 192.168.1.1&#10;CMS Cloud: URL https://cms.client.com / Identifiant: display01&#10;Wi-Fi SSID: VERTEX-SIGNAGE / WPA2"></textarea>

        <label>Tests effectu√©s</label>
        <div id="tests-checklist" style="margin-top:10px;">
            <div class="check-item">
                <input type="checkbox" id="test1">
                <label for="test1">Affichage image/vid√©o OK</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="test2">
                <label for="test2">R√©solution et qualit√© conformes</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="test3">
                <label for="test3">Connexion r√©seau stable</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="test4">
                <label for="test4">CMS / Playlist fonctionnel</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="test5">
                <label for="test5">Audio (si applicable)</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="test6">
                <label for="test6">Programmation horaires</label>
            </div>
        </div>

        <button class="btn-gold" onclick="validateStep3()">CONTINUER ‚Üí FINALISATION</button>
        <button class="btn-outline" onclick="nextStep(2)">‚Üê RETOUR PHOTOS</button>
    </div>

    <!-- STEP 4: FINALISATION & SIGNATURE -->
    <div class="step" id="step4">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Installation</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Tests</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">4</div>
                <div class="progress-label">Finalisation</div>
            </div>
        </div>

        <label>Heure de d√©part *</label>
        <input type="time" id="time_out">
        <button class="btn-now" onclick="setTime('time_out')">‚è∞ MAINTENANT</button>

        <label>Pi√®ces d√©tach√©es utilis√©es / Consommables</label>
        <textarea id="task_parts" rows="3" placeholder="Ex: Chevilles M12 x8, C√¢ble HDMI 15m, Connecteurs RJ45 x2..."></textarea>

        <label>Recommandations / Formation client</label>
        <textarea id="task_recommendations" rows="3" placeholder="Ex:&#10;- Formation utilisateur effectu√©e sur interface CMS&#10;- Conseill√© nettoyage √©cran avec chiffon microfibre mensuel&#10;- Pr√©voir renouvellement contenu tous les 3 mois&#10;- RDV maintenance pr√©ventive dans 6 mois"></textarea>

        <label style="margin-top:30px;">Checklist de fin d'intervention *</label>
        <div id="checklist-container">
            <div class="check-item">
                <input type="checkbox" id="check1">
                <label for="check1">Chantier nettoy√© / Emballages √©vacu√©s</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check2">
                <label for="check2">Tests finaux valid√©s client</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check3">
                <label for="check3">Documentation technique remise</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check4">
                <label for="check4">Acc√®s CMS / Codes transmis</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check5">
                <label for="check5">Formation utilisateur effectu√©e</label>
            </div>
            <div class="check-item">
                <input type="checkbox" id="check6">
                <label for="check6">Client inform√© SAV & Contact</label>
            </div>
        </div>

        <label style="margin-top:30px;">Signature client *</label>
        <canvas id="sig-canvas"></canvas>
        <button class="btn-outline" onclick="clearSig()">üóëÔ∏è EFFACER LA SIGNATURE</button>
        
        <div id="save-spinner" style="display:none;">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p class="spinner-text">Enregistrement en cours...</p>
            </div>
        </div>
        
        <button class="btn-gold" id="btn-save" onclick="saveEntry()">‚úì ENREGISTRER L'INTERVENTION</button>
        <button class="btn-outline" onclick="nextStep(3)">‚Üê RETOUR TESTS</button>
    </div>

    <!-- STEP 5: VIEW PROJECT -->
    <div class="step" id="step5">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
            <h2 id="view-n" style="color:var(--gold); margin:0; font-size:22px;"></h2>
            <div id="status-toggle-container"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="project-interventions">0</div>
                <div class="stat-label">Interventions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="project-hours">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="project-screens">0</div>
                <div class="stat-label">√âcrans install√©s</div>
            </div>
        </div>

        <div id="timeline" style="margin-top:30px;"></div>
        
        <div class="no-print">
            <button class="btn-outline" style="color:#2ecc71; border-color:#2ecc71;" onclick="sendProjectMail()">
                ‚úâÔ∏è ENVOYER PAR MAIL
            </button>
            <button class="btn-gold" onclick="newIntervention()">+ NOUVELLE INTERVENTION</button>
            <button class="btn-outline" onclick="exportProjectPDF()">üñ®Ô∏è G√âN√âRER PDF</button>
            <button class="btn-outline" onclick="nextStep(0)">‚Üê RETOUR ACCUEIL</button>
            <button class="btn-danger" onclick="confirmDeleteProject()">‚ö†Ô∏è SUPPRIMER CE PROJET</button>
        </div>
    </div>

</div>

<!-- MODALS -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Confirmation</div>
        <div class="modal-body" id="modalBody">√ätes-vous s√ªr ?</div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal()">Annuler</button>
            <button class="modal-btn confirm" id="modalConfirm" onclick="modalConfirmAction()">Confirmer</button>
        </div>
    </div>
</div>

<div class="modal" id="annotationModal">
    <div class="modal-content" style="max-width:90%; max-height:90vh;">
        <div class="modal-title">‚úèÔ∏è Annoter la photo</div>
        <div class="annotation-tools">
            <button class="annotation-tool-btn active" id="tool-measure" onclick="selectAnnotationTool('measure')">üìè Mesure</button>
            <button class="annotation-tool-btn" id="tool-arrow" onclick="selectAnnotationTool('arrow')">‚Üí Fl√®che</button>
            <button class="annotation-tool-btn" id="tool-text" onclick="selectAnnotationTool('text')">T Texte</button>
            <input type="color" class="color-picker" id="annotation-color" value="#D4AF37">
            <input type="text" class="measure-input" id="measure-value" placeholder="Ex: 2.5m, 180cm">
            <button class="annotation-tool-btn" onclick="undoAnnotation()">‚Ü∂ Annuler</button>
            <button class="annotation-tool-btn" onclick="clearAnnotations()">üóëÔ∏è Tout effacer</button>
        </div>
        <div class="annotation-container" id="annotation-container">
            <img id="annotation-image" src="" style="width:100%; display:block;">
            <canvas class="annotation-canvas" id="annotation-canvas"></canvas>
        </div>
        <div class="modal-actions" style="margin-top:15px;">
            <button class="modal-btn cancel" onclick="closeAnnotationModal()">Annuler</button>
            <button class="modal-btn confirm" onclick="saveAnnotation()">‚úì Enregistrer</button>
        </div>
    </div>
</div>

<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close">‚úï FERMER</button>
    <img id="modalImage" src="" alt="">
</div>

<script>
// ========== CONFIGURATION ==========
const CONFIG = {
    DB_NAME: 'VertexDB_DigitalSignage_V2',
    DB_VERSION: 2,
    MAX_IMAGE_SIZE: 1400,
    IMAGE_QUALITY: 0.75,
    ANNOTATION_LINE_WIDTH: 3,
    ANNOTATION_FONT_SIZE: 16,
};

// ========== STATE ==========
let db = {};
let indexedDB_instance = null;
let cur = null;
let staff = [];
let photosBefore = [];
let photosDuring = [];
let photosAfter = [];
let selectedType = "";
let currentFilter = 'ongoing';
let gpsCoords = null;
let hasUnsavedChanges = false;
let modalCallback = null;
let isOnline = navigator.onLine;
let currentTheme = localStorage.getItem('vertex_theme') || 'dark';
let receptionProducts = [];

// Annotation state
let currentAnnotationPhoto = null;
let currentAnnotationType = 'measure';
let annotationCanvas = null;
let annotationCtx = null;
let isAnnotating = false;
let annotationStartPos = null;
let annotations = [];
let currentAnnotationColor = '#D4AF37';

// ========== INITIALIZATION ==========
window.addEventListener('load', async () => {
    console.log('üöÄ Vertex Monaco Digital Signage V2.0');
    
    await initIndexedDB();
    await loadFromIndexedDB();
    applyTheme(currentTheme);
    requestGeolocation();
    setupNetworkListeners();
    loadList();
    updateStats();
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
    
    console.log('‚úì Syst√®me pr√™t');
});

// ========== INDEXED DB ==========
async function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
        
        request.onerror = () => reject(request.error);
        
        request.onsuccess = () => {
            indexedDB_instance = request.result;
            resolve();
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('projects')) {
                db.createObjectStore('projects', { keyPath: 'id' });
            }
        };
    });
}

async function loadFromIndexedDB() {
    try {
        const transaction = indexedDB_instance.transaction(['projects'], 'readonly');
        const store = transaction.objectStore('projects');
        const request = store.getAll();
        
        request.onsuccess = () => {
            db = {};
            request.result.forEach(project => {
                db[project.id] = project.data;
            });
        };
    } catch (e) {
        const stored = localStorage.getItem('vertex_v2_db');
        if (stored) db = JSON.parse(stored);
    }
}

async function saveToIndexedDB() {
    try {
        const transaction = indexedDB_instance.transaction(['projects'], 'readwrite');
        const store = transaction.objectStore('projects');
        await store.clear();
        
        for (const [id, data] of Object.entries(db)) {
            if (id !== '_version') {
                await store.put({ id, data });
            }
        }
        
        localStorage.setItem('vertex_v2_db', JSON.stringify(db));
        hasUnsavedChanges = false;
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
        showToast('Erreur de sauvegarde', 'error');
    }
}

// ========== THEME ==========
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    applyTheme(currentTheme);
    localStorage.setItem('vertex_theme', currentTheme);
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
}

// ========== NETWORK ==========
function setupNetworkListeners() {
    window.addEventListener('online', () => {
        isOnline = true;
        document.getElementById('offlineIndicator').classList.remove('active');
        showToast('‚úì Connexion r√©tablie', 'success');
    });
    
    window.addEventListener('offline', () => {
        isOnline = false;
        document.getElementById('offlineIndicator').classList.add('active');
        showToast('üì° Mode hors ligne', 'warning');
    });
    
    if (!isOnline) {
        document.getElementById('offlineIndicator').classList.add('active');
    }
}

// Suite dans un commentaire pour la longueur...
// Le JavaScript continue avec toutes les fonctions : photos, annotation, signature, navigation, etc.



// ========== TOAST & MODALS ==========
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'toastSlide 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showModal(title, body, confirmText, callback) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').textContent = body;
    document.getElementById('modalConfirm').textContent = confirmText;
    modalCallback = callback;
    document.getElementById('confirmModal').classList.add('active');
}

function closeModal() {
    document.getElementById('confirmModal').classList.remove('active');
    modalCallback = null;
}

function modalConfirmAction() {
    if (modalCallback) modalCallback();
    closeModal();
}

// ========== NAVIGATION ==========
function nextStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
    
    if (n === 4) {
        setTimeout(resizeCanvas, 200);
    }
    if (n === 1) {
        document.getElementById('c-name').textContent = cur;
        resetForm();
        hasUnsavedChanges = true;
        
        // Show/hide reception section based on type
        const receptionSection = document.getElementById('reception-section');
        if (selectedType === 'R√âCEPTION') {
            receptionSection.style.display = 'block';
        }
    }
    if (n === 5) {
        document.getElementById('view-n').textContent = cur;
        showTimeline();
        hasUnsavedChanges = false;
    }
    if (n === 0) {
        hasUnsavedChanges = false;
        switchTab(currentFilter);
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function confirmCancel() {
    if (hasUnsavedChanges) {
        showModal(
            'Annuler l\'intervention',
            'Les donn√©es non enregistr√©es seront perdues. Continuer ?',
            'Oui, annuler',
            () => nextStep(0)
        );
    } else {
        nextStep(0);
    }
}

// ========== TABS ==========
function switchTab(tab) {
    currentFilter = tab;
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    if (tab === 'ongoing' || tab === 'done') {
        document.querySelectorAll('.tab-btn')[tab === 'ongoing' ? 0 : 1].classList.add('active');
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-analytics').style.display = 'none';
        loadList();
    } else if (tab === 'analytics') {
        document.querySelectorAll('.tab-btn')[2].classList.add('active');
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-analytics').style.display = 'block';
    }
}

// ========== STEP 1 FUNCTIONS ==========
function setTime(id) {
    const n = new Date();
    document.getElementById(id).value = n.getHours().toString().padStart(2, '0') + ':' + 
                                        n.getMinutes().toString().padStart(2, '0');
    showToast('‚è∞ Heure enregistr√©e', 'info');
}

function selectType(el, type) {
    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedType = type;
    
    // Show/hide reception section
    const receptionSection = document.getElementById('reception-section');
    if (type === 'R√âCEPTION') {
        receptionSection.style.display = 'block';
        if (receptionProducts.length === 0) {
            addReceptionProduct();
        }
    } else {
        receptionSection.style.display = 'none';
    }
}

function toggleStaff(el) {
    el.classList.toggle('selected');
    staff = Array.from(document.querySelectorAll('.staff-chip.selected')).map(c => c.textContent);
}

function requestGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                gpsCoords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                const gpsInfo = document.getElementById('gps-info');
                if (gpsInfo) {
                    gpsInfo.textContent = `üìç GPS: ${gpsCoords.lat.toFixed(5)}, ${gpsCoords.lng.toFixed(5)}`;
                }
            },
            () => {}
        );
    }
}

function validateStep1() {
    if (!selectedType) {
        showToast('‚ö†Ô∏è S√©lectionnez un type d\'intervention', 'error');
        return;
    }
    if (staff.length === 0) {
        showToast('‚ö†Ô∏è S√©lectionnez au moins un membre de l\'√©quipe', 'error');
        return;
    }
    if (!document.getElementById('time_in').value) {
        showToast('‚ö†Ô∏è Indiquez l\'heure d\'arriv√©e', 'error');
        return;
    }
    nextStep(2);
}

function validateStep2() {
    nextStep(3);
}

function validateStep3() {
    const taskMat = document.getElementById('task_mat').value.trim();
    const taskDone = document.getElementById('task_done').value.trim();
    if (!taskMat || !taskDone) {
        showToast('‚ö†Ô∏è Remplissez le mat√©riel et le compte-rendu', 'error');
        return;
    }
    nextStep(4);
}

// ========== RECEPTION PRODUIT ==========
let productCounter = 0;

function addReceptionProduct() {
    const id = productCounter++;
    const container = document.getElementById('reception-products');
    
    const productDiv = document.createElement('div');
    productDiv.className = 'product-item';
    productDiv.id = `product-${id}`;
    productDiv.innerHTML = `
        <div class="product-item-header">
            <input type="text" placeholder="R√©f√©rence produit (ex: Samsung QM85R-B)" 
                   id="product-ref-${id}" class="photo-input" style="margin:0; flex:1; margin-right:10px;">
            <select id="product-status-${id}" class="photo-input" style="width:auto; margin:0;">
                <option value="ok">‚úì OK</option>
                <option value="defect">‚úó D√©faut</option>
                <option value="partial">‚óê Partiel</option>
            </select>
        </div>
        <input type="text" placeholder="Num√©ro de s√©rie" id="product-sn-${id}" class="photo-input" style="margin:8px 0 0 0;">
        <textarea placeholder="Remarques / D√©fauts constat√©s" id="product-notes-${id}" class="photo-input" 
                  rows="2" style="margin:8px 0 0 0; min-height:60px;"></textarea>
        <div class="product-tests">
            <div style="font-size:11px; font-weight:900; color:var(--info); margin-bottom:8px; text-transform:uppercase;">Tests r√©ception</div>
            <div class="test-item">
                <input type="checkbox" id="test-visual-${id}">
                <label for="test-visual-${id}">√âtat physique OK (pas de dommage)</label>
            </div>
            <div class="test-item">
                <input type="checkbox" id="test-power-${id}">
                <label for="test-power-${id}">Allumage / Mise sous tension OK</label>
            </div>
            <div class="test-item">
                <input type="checkbox" id="test-display-${id}">
                <label for="test-display-${id}">Affichage / Image OK (pas de pixels morts)</label>
            </div>
            <div class="test-item">
                <input type="checkbox" id="test-accessories-${id}">
                <label for="test-accessories-${id}">Accessoires complets (c√¢bles, t√©l√©commande...)</label>
            </div>
        </div>
        <button class="btn-outline" onclick="removeReceptionProduct(${id})" 
                style="margin-top:10px; padding:8px; font-size:11px; border-color:var(--danger); color:var(--danger);">
            üóëÔ∏è Retirer ce produit
        </button>
    `;
    
    container.appendChild(productDiv);
    
    receptionProducts.push({
        id: id,
        ref: '',
        sn: '',
        status: 'ok',
        notes: '',
        tests: {}
    });
}

function removeReceptionProduct(id) {
    document.getElementById(`product-${id}`).remove();
    receptionProducts = receptionProducts.filter(p => p.id !== id);
}

function getReceptionData() {
    return receptionProducts.map(p => {
        return {
            ref: document.getElementById(`product-ref-${p.id}`)?.value || '',
            sn: document.getElementById(`product-sn-${p.id}`)?.value || '',
            status: document.getElementById(`product-status-${p.id}`)?.value || 'ok',
            notes: document.getElementById(`product-notes-${p.id}`)?.value || '',
            tests: {
                visual: document.getElementById(`test-visual-${p.id}`)?.checked || false,
                power: document.getElementById(`test-power-${p.id}`)?.checked || false,
                display: document.getElementById(`test-display-${p.id}`)?.checked || false,
                accessories: document.getElementById(`test-accessories-${p.id}`)?.checked || false
            }
        };
    }).filter(p => p.ref); // Only keep products with a reference
}

// ========== PHOTO MANAGEMENT ==========
function handlePhotos(input, type) {
    const files = Array.from(input.files);
    if (files.length === 0) return;
    
    showToast(`üì∏ Traitement de ${files.length} photo(s)...`, 'info');
    
    files.forEach(file => {
        compressImage(file, (compressedDataUrl, originalSize, compressedSize) => {
            const imgObj = {
                src: compressedDataUrl,
                note: "",
                originalSize: originalSize,
                compressedSize: compressedSize,
                rotation: 0,
                annotations: []
            };
            
            if (type === 'before') photosBefore.push(imgObj);
            else if (type === 'during') photosDuring.push(imgObj);
            else photosAfter.push(imgObj);
            
            renderGalleries();
        });
    });
    
    showToast(`‚úì ${files.length} photo(s) ajout√©e(s)`, 'success');
    hasUnsavedChanges = true;
    input.value = '';
}

function compressImage(file, callback) {
    const reader = new FileReader();
    const originalSize = file.size;
    
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > CONFIG.MAX_IMAGE_SIZE || height > CONFIG.MAX_IMAGE_SIZE) {
                if (width > height) {
                    height = Math.round((height * CONFIG.MAX_IMAGE_SIZE) / width);
                    width = CONFIG.MAX_IMAGE_SIZE;
                } else {
                    width = Math.round((width * CONFIG.MAX_IMAGE_SIZE) / height);
                    height = CONFIG.MAX_IMAGE_SIZE;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Watermark
            ctx.font = 'bold 14px "Darker Grotesque"';
            ctx.fillStyle = 'rgba(212, 175, 55, 0.8)';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
            ctx.shadowBlur = 4;
            ctx.fillText(`Vertex Monaco - ${new Date().toLocaleDateString('fr-FR')}`, 15, height - 15);
            
            const compressedDataUrl = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
            const compressedSize = Math.round((compressedDataUrl.length * 3) / 4);
            
            callback(compressedDataUrl, originalSize, compressedSize);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function renderGalleries() {
    renderGallery('before', photosBefore);
    renderGallery('during', photosDuring);
    renderGallery('after', photosAfter);
}

function renderGallery(type, photos) {
    const container = document.getElementById(`gallery-${type}`);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (photos.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666; padding:20px 0; font-size:13px;">Aucune photo</p>';
        return;
    }
    
    photos.forEach((p, i) => {
        const sizeInfo = `${(p.compressedSize / 1024).toFixed(1)} KB`;
        const hasAnnotations = p.annotations && p.annotations.length > 0;
        
        container.innerHTML += `
            <div class="photo-card">
                <img src="${escapeHtml(p.src)}" 
                     style="transform: rotate(${p.rotation}deg);"
                     onclick="openImageModal('${type}', ${i})"
                     alt="Photo ${type}">
                <div class="photo-size">
                    üì¶ ${sizeInfo} 
                    ${hasAnnotations ? `| ‚úèÔ∏è ${p.annotations.length} mesure(s)` : ''}
                </div>
                <input type="text" class="photo-input" placeholder="L√©gende..." 
                       oninput="photos${type.charAt(0).toUpperCase() + type.slice(1)}[${i}].note=this.value" 
                       value="${escapeHtml(p.note)}">
                <div class="photo-controls">
                    <button onclick="rotatePhoto('${type}', ${i})">üîÑ</button>
                    <button onclick="openAnnotationModal('${type}', ${i})" style="border-color:var(--gold); color:var(--gold);">
                        ‚úèÔ∏è Annoter
                    </button>
                    <button onclick="removePhoto('${type}', ${i})" style="border-color:var(--danger); color:var(--danger);">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
    });
}

function rotatePhoto(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    photoArray[index].rotation = (photoArray[index].rotation + 90) % 360;
    renderGalleries();
    hasUnsavedChanges = true;
}

function removePhoto(type, index) {
    showModal(
        'Supprimer la photo',
        '√ätes-vous s√ªr ?',
        'Supprimer',
        () => {
            if (type === 'before') photosBefore.splice(index, 1);
            else if (type === 'during') photosDuring.splice(index, 1);
            else photosAfter.splice(index, 1);
            
            renderGalleries();
            showToast('‚úì Photo supprim√©e', 'success');
            hasUnsavedChanges = true;
        }
    );
}

function openImageModal(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    if (photoArray[index]) {
        document.getElementById('modalImage').src = photoArray[index].src;
        document.getElementById('imageModal').classList.add('active');
    }
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

// ========== ANNOTATION SYSTEM ==========
function openAnnotationModal(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    const photo = photoArray[index];
    
    currentAnnotationPhoto = { type, index };
    annotations = photo.annotations || [];
    
    const modal = document.getElementById('annotationModal');
    const img = document.getElementById('annotation-image');
    const canvas = document.getElementById('annotation-canvas');
    
    img.src = photo.src;
    
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.style.width = img.offsetWidth + 'px';
        canvas.style.height = img.offsetHeight + 'px';
        
        annotationCanvas = canvas;
        annotationCtx = canvas.getContext('2d');
        
        redrawAnnotations();
        setupAnnotationListeners();
    };
    
    modal.classList.add('active');
    selectAnnotationTool('measure');
}

function selectAnnotationTool(tool) {
    currentAnnotationType = tool;
    
    document.querySelectorAll('.annotation-tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const toolBtn = document.getElementById(`tool-${tool}`);
    if (toolBtn) toolBtn.classList.add('active');
}

function setupAnnotationListeners() {
    const canvas = annotationCanvas;
    
    canvas.removeEventListener('mousedown', startAnnotation);
    canvas.removeEventListener('mousemove', drawAnnotation);
    canvas.removeEventListener('mouseup', endAnnotation);
    canvas.removeEventListener('touchstart', startAnnotation);
    canvas.removeEventListener('touchmove', drawAnnotation);
    canvas.removeEventListener('touchend', endAnnotation);
    
    canvas.addEventListener('mousedown', startAnnotation);
    canvas.addEventListener('mousemove', drawAnnotation);
    canvas.addEventListener('mouseup', endAnnotation);
    canvas.addEventListener('touchstart', startAnnotation, { passive: false });
    canvas.addEventListener('touchmove', drawAnnotation, { passive: false });
    canvas.addEventListener('touchend', endAnnotation);
}

function getAnnotationPos(e) {
    const canvas = annotationCanvas;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
    };
}

function startAnnotation(e) {
    e.preventDefault();
    isAnnotating = true;
    annotationStartPos = getAnnotationPos(e);
    currentAnnotationColor = document.getElementById('annotation-color').value;
}

function drawAnnotation(e) {
    if (!isAnnotating) return;
    e.preventDefault();
    
    const pos = getAnnotationPos(e);
    const ctx = annotationCtx;
    
    redrawAnnotations();
    
    ctx.strokeStyle = currentAnnotationColor;
    ctx.fillStyle = currentAnnotationColor;
    ctx.lineWidth = CONFIG.ANNOTATION_LINE_WIDTH;
    ctx.font = `bold ${CONFIG.ANNOTATION_FONT_SIZE}px "Darker Grotesque"`;
    
    if (currentAnnotationType === 'measure') {
        ctx.beginPath();
        ctx.moveTo(annotationStartPos.x, annotationStartPos.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.arc(annotationStartPos.x, annotationStartPos.y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 4, 0, Math.PI * 2);
        ctx.fill();
        
        const measureValue = document.getElementById('measure-value').value || '?';
        const midX = (annotationStartPos.x + pos.x) / 2;
        const midY = (annotationStartPos.y + pos.y) / 2;
        
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        const textWidth = ctx.measureText(measureValue).width;
        ctx.fillRect(midX - textWidth / 2 - 8, midY - CONFIG.ANNOTATION_FONT_SIZE - 4, 
                    textWidth + 16, CONFIG.ANNOTATION_FONT_SIZE + 8);
        
        ctx.fillStyle = currentAnnotationColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(measureValue, midX, midY);
    } else if (currentAnnotationType === 'arrow') {
        drawArrow(ctx, annotationStartPos.x, annotationStartPos.y, pos.x, pos.y);
    }
}

function drawArrow(ctx, x1, y1, x2, y2) {
    const headLength = 15;
    const angle = Math.atan2(y2 - y1, x2 - x1);
    
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), 
               y2 - headLength * Math.sin(angle - Math.PI / 6));
    ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), 
               y2 - headLength * Math.sin(angle + Math.PI / 6));
    ctx.closePath();
    ctx.fill();
}

function endAnnotation(e) {
    if (!isAnnotating) return;
    e.preventDefault();
    
    const pos = getAnnotationPos(e);
    const measureValue = document.getElementById('measure-value').value || '';
    
    const annotation = {
        type: currentAnnotationType,
        start: annotationStartPos,
        end: pos,
        color: currentAnnotationColor,
        measure: measureValue
    };
    
    annotations.push(annotation);
    isAnnotating = false;
    
    redrawAnnotations();
}

function redrawAnnotations() {
    const ctx = annotationCtx;
    ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
    
    annotations.forEach(ann => {
        ctx.strokeStyle = ann.color;
        ctx.fillStyle = ann.color;
        ctx.lineWidth = CONFIG.ANNOTATION_LINE_WIDTH;
        ctx.font = `bold ${CONFIG.ANNOTATION_FONT_SIZE}px "Darker Grotesque"`;
        
        if (ann.type === 'measure') {
            ctx.beginPath();
            ctx.moveTo(ann.start.x, ann.start.y);
            ctx.lineTo(ann.end.x, ann.end.y);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(ann.start.x, ann.start.y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(ann.end.x, ann.end.y, 4, 0, Math.PI * 2);
            ctx.fill();
            
            const midX = (ann.start.x + ann.end.x) / 2;
            const midY = (ann.start.y + ann.end.y) / 2;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            const textWidth = ctx.measureText(ann.measure).width;
            ctx.fillRect(midX - textWidth / 2 - 8, midY - CONFIG.ANNOTATION_FONT_SIZE - 4, 
                        textWidth + 16, CONFIG.ANNOTATION_FONT_SIZE + 8);
            
            ctx.fillStyle = ann.color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(ann.measure, midX, midY);
        } else if (ann.type === 'arrow') {
            drawArrow(ctx, ann.start.x, ann.start.y, ann.end.x, ann.end.y);
        }
    });
}

function undoAnnotation() {
    if (annotations.length > 0) {
        annotations.pop();
        redrawAnnotations();
        showToast('Annotation annul√©e', 'info');
    }
}

function clearAnnotations() {
    if (annotations.length > 0) {
        showModal(
            'Effacer les annotations',
            '√ätes-vous s√ªr ?',
            'Effacer',
            () => {
                annotations = [];
                redrawAnnotations();
                showToast('Annotations effac√©es', 'success');
            }
        );
    }
}

function saveAnnotation() {
    if (!currentAnnotationPhoto) return;
    
    const { type, index } = currentAnnotationPhoto;
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    
    photoArray[index].annotations = [...annotations];
    
    const tempCanvas = document.createElement('canvas');
    const img = document.getElementById('annotation-image');
    tempCanvas.width = img.naturalWidth;
    tempCanvas.height = img.naturalHeight;
    
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.drawImage(img, 0, 0);
    
    const scaleX = tempCanvas.width / annotationCanvas.width;
    const scaleY = tempCanvas.height / annotationCanvas.height;
    
    annotations.forEach(ann => {
        tempCtx.strokeStyle = ann.color;
        tempCtx.fillStyle = ann.color;
        tempCtx.lineWidth = CONFIG.ANNOTATION_LINE_WIDTH * Math.max(scaleX, scaleY);
        tempCtx.font = `bold ${CONFIG.ANNOTATION_FONT_SIZE * Math.max(scaleX, scaleY)}px "Darker Grotesque"`;
        
        const startX = ann.start.x * scaleX;
        const startY = ann.start.y * scaleY;
        const endX = ann.end.x * scaleX;
        const endY = ann.end.y * scaleY;
        
        if (ann.type === 'measure') {
            tempCtx.beginPath();
            tempCtx.moveTo(startX, startY);
            tempCtx.lineTo(endX, endY);
            tempCtx.stroke();
            
            tempCtx.beginPath();
            tempCtx.arc(startX, startY, 6 * Math.max(scaleX, scaleY), 0, Math.PI * 2);
            tempCtx.fill();
            tempCtx.beginPath();
            tempCtx.arc(endX, endY, 6 * Math.max(scaleX, scaleY), 0, Math.PI * 2);
            tempCtx.fill();
            
            const midX = (startX + endX) / 2;
            const midY = (startY + endY) / 2;
            
            tempCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            const textWidth = tempCtx.measureText(ann.measure).width;
            const fontSize = CONFIG.ANNOTATION_FONT_SIZE * Math.max(scaleX, scaleY);
            tempCtx.fillRect(midX - textWidth / 2 - 10, midY - fontSize - 5, 
                            textWidth + 20, fontSize + 10);
            
            tempCtx.fillStyle = ann.color;
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(ann.measure, midX, midY);
        } else if (ann.type === 'arrow') {
            drawArrow(tempCtx, startX, startY, endX, endY);
        }
    });
    
    photoArray[index].src = tempCanvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
    photoArray[index].compressedSize = Math.round((photoArray[index].src.length * 3) / 4);
    
    renderGalleries();
    closeAnnotationModal();
    showToast(`‚úì Photo annot√©e avec ${annotations.length} mesure(s)`, 'success');
    hasUnsavedChanges = true;
}

function closeAnnotationModal() {
    document.getElementById('annotationModal').classList.remove('active');
    currentAnnotationPhoto = null;
    annotations = [];
    isAnnotating = false;
}

// √Ä SUIVRE dans le prochain fichier (signature, save, export, etc.)

// ========== SIGNATURE ==========
const canvas = document.getElementById('sig-canvas');
if (canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        tempCtx.drawImage(canvas, 0, 0);
        
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        ctx.drawImage(tempCanvas, 0, 0);
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDrawing(e) {
        drawing = true;
        const p = getPos(e);
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        e.preventDefault();
    }

    function draw(e) {
        if (!drawing) return;
        const p = getPos(e);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        e.preventDefault();
    }

    function stopDrawing() {
        drawing = false;
    }

    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);

    window.resizeCanvas = resizeCanvas;
}

function clearSig() {
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    showToast('‚úì Signature effac√©e', 'success');
}

function isCanvasBlank(canvas) {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
}

// ========== SAVE ENTRY ==========
function saveEntry() {
    if (!selectedType || !staff.length) {
        showToast('‚ö†Ô∏è Type et √âquipe requis', 'error');
        return;
    }
    
    if (!document.getElementById('time_out').value) {
        showToast('‚ö†Ô∏è Indiquez l\'heure de d√©part', 'error');
        return;
    }
    
    const checks = Array.from(document.querySelectorAll('#checklist-container input[type="checkbox"]'));
    if (!checks.every(c => c.checked)) {
        showToast('‚ö†Ô∏è Validez tous les points de la checklist', 'error');
        return;
    }
    
    const canvas = document.getElementById('sig-canvas');
    if (isCanvasBlank(canvas)) {
        showToast('‚ö†Ô∏è Signature client requise', 'error');
        return;
    }
    
    document.getElementById('save-spinner').style.display = 'block';
    document.getElementById('btn-save').disabled = true;
    
    setTimeout(async () => {
        try {
            const testsChecked = Array.from(document.querySelectorAll('#tests-checklist input[type="checkbox"]'))
                .map((checkbox, i) => ({
                    label: checkbox.nextElementSibling.textContent,
                    checked: checkbox.checked
                }));

            const entry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('fr-FR'),
                timestamp: new Date().toISOString(),
                type: selectedType,
                in: document.getElementById('time_in').value,
                out: document.getElementById('time_out').value,
                staff: staff.join(', '),
                context: document.getElementById('client_context')?.value || '',
                mat: document.getElementById('task_mat').value,
                done: document.getElementById('task_done').value,
                network: document.getElementById('task_network')?.value || '',
                parts: document.getElementById('task_parts')?.value || '',
                recommendations: document.getElementById('task_recommendations')?.value || '',
                tests: testsChecked,
                before: [...photosBefore],
                during: [...photosDuring],
                after: [...photosAfter],
                sig: canvas.toDataURL('image/png', 0.5),
                gps: gpsCoords ? { lat: gpsCoords.lat, lng: gpsCoords.lng } : null,
                reception: selectedType === 'R√âCEPTION' ? getReceptionData() : null
            };
            
            db[cur].entries.push(entry);
            await saveToIndexedDB();
            
            document.getElementById('save-spinner').style.display = 'none';
            document.getElementById('btn-save').disabled = false;
            
            showToast('‚úÖ Intervention enregistr√©e !', 'success');
            nextStep(5);
        } catch (e) {
            document.getElementById('save-spinner').style.display = 'none';
            document.getElementById('btn-save').disabled = false;
            showToast('‚ùå Erreur lors de l\'enregistrement', 'error');
            console.error(e);
        }
    }, 500);
}

// ========== RESET FORM ==========
function resetForm() {
    staff = [];
    photosBefore = [];
    photosDuring = [];
    photosAfter = [];
    selectedType = '';
    receptionProducts = [];
    productCounter = 0;
    
    document.querySelectorAll('.type-chip, .staff-chip').forEach(c => c.classList.remove('selected'));
    document.getElementById('task_done').value = '';
    document.getElementById('task_mat').value = '';
    if (document.getElementById('task_network')) document.getElementById('task_network').value = '';
    if (document.getElementById('task_parts')) document.getElementById('task_parts').value = '';
    if (document.getElementById('task_recommendations')) document.getElementById('task_recommendations').value = '';
    if (document.getElementById('client_context')) document.getElementById('client_context').value = '';
    document.getElementById('time_in').value = '';
    document.getElementById('time_out').value = '';
    
    if (document.getElementById('reception-products')) {
        document.getElementById('reception-products').innerHTML = '';
    }
    
    renderGalleries();
    clearSig();
}

// ========== TIMELINE & PROJECT VIEW ==========
function showTimeline() {
    const t = document.getElementById('timeline');
    t.innerHTML = '';
    
    const isDone = db[cur].status === 'done';
    document.getElementById('status-toggle-container').innerHTML = `
        <button class="status-pill ${isDone ? 'status-done' : 'status-ongoing'}" 
                onclick="toggleStatus()" style="padding:8px 16px; border-radius:25px; font-size:11px; cursor:pointer; border:none;">
            ${isDone ? 'üì¶ ARCHIV√â' : '‚úÖ ACTIF'}
        </button>
    `;
    
    const entries = db[cur].entries;
    document.getElementById('project-interventions').textContent = entries.length;
    
    let totalMinutes = 0;
    let totalScreens = 0;
    
    entries.forEach(e => {
        if (e.in && e.out) {
            const [inH, inM] = e.in.split(':').map(Number);
            const [outH, outM] = e.out.split(':').map(Number);
            const minutes = (outH * 60 + outM) - (inH * 60 + inM);
            if (minutes > 0) totalMinutes += minutes;
        }
        
        // Estimate screens from material description
        const matText = (e.mat || '').toLowerCase();
        const screenMatch = matText.match(/(\d+)\s*(?:√©cran|screen|display)/i);
        if (screenMatch) totalScreens += parseInt(screenMatch[1]);
        else if (matText.includes('√©cran') || matText.includes('screen')) totalScreens += 1;
    });
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('project-hours').textContent = `${hours}h${minutes > 0 ? minutes.toString().padStart(2, '0') : ''}`;
    document.getElementById('project-screens').textContent = totalScreens;
    
    [...entries].reverse().forEach(e => {
        const gpsInfo = e.gps ? `üìç ${e.gps.lat.toFixed(5)}, ${e.gps.lng.toFixed(5)}` : '';
        const duration = calculateDuration(e.in, e.out);
        
        let testsHTML = '';
        if (e.tests && e.tests.length > 0) {
            testsHTML = '<div class="section-block" style="border-left-color:var(--success)"><strong>Tests effectu√©s:</strong><br>';
            e.tests.forEach(test => {
                testsHTML += `${test.checked ? '‚úì' : '‚úó'} ${escapeHtml(test.label)}<br>`;
            });
            testsHTML += '</div>';
        }
        
        let receptionHTML = '';
        if (e.reception && e.reception.length > 0) {
            receptionHTML = '<div class="reception-section" style="margin:15px 0;"><h4>üì¶ R√©ception Produits</h4>';
            e.reception.forEach(prod => {
                const statusClass = prod.status === 'ok' ? 'status-ok' : prod.status === 'defect' ? 'status-defect' : 'status-partial';
                const statusText = prod.status === 'ok' ? '‚úì OK' : prod.status === 'defect' ? '‚úó D√©faut' : '‚óê Partiel';
                receptionHTML += `
                    <div class="product-item">
                        <div class="product-item-header">
                            <div class="product-name">${escapeHtml(prod.ref)}</div>
                            <div class="product-status ${statusClass}">${statusText}</div>
                        </div>
                        ${prod.sn ? `<div class="product-details">S/N: ${escapeHtml(prod.sn)}</div>` : ''}
                        ${prod.notes ? `<div class="product-details" style="margin-top:8px;">${escapeHtml(prod.notes)}</div>` : ''}
                        <div class="product-tests">
                            <div style="font-size:10px; color:#888; margin-top:8px;">
                                ${prod.tests.visual ? '‚úì' : '‚úó'} √âtat physique | 
                                ${prod.tests.power ? '‚úì' : '‚úó'} Allumage | 
                                ${prod.tests.display ? '‚úì' : '‚úó'} Affichage | 
                                ${prod.tests.accessories ? '‚úì' : '‚úó'} Accessoires
                            </div>
                        </div>
                    </div>
                `;
            });
            receptionHTML += '</div>';
        }
        
        t.innerHTML += `
            <div class="timeline-item">
                <div style="font-size:11px; font-weight:900; color:var(--gold); margin-bottom:8px; text-transform:uppercase;">
                    ${escapeHtml(e.date)} | ${escapeHtml(e.type)}
                </div>
                <div class="section-block">
                    <strong>√âquipe:</strong> ${escapeHtml(e.staff)}<br>
                    <strong>Horaires:</strong> ${escapeHtml(e.in)} ‚Üí ${escapeHtml(e.out)} ${duration ? `(${duration})` : ''}
                    ${gpsInfo ? `<br><span style="font-size:10px; color:#888;">${gpsInfo}</span>` : ''}
                </div>
                ${e.context ? `<div class="section-block" style="border-left-color:var(--info);">
                    <strong>üìù Contexte:</strong><br>${escapeHtml(e.context).replace(/\n/g, '<br>')}
                </div>` : ''}
                ${receptionHTML}
                <div class="section-block">
                    <strong>üîß Travaux:</strong><br>${escapeHtml(e.done).replace(/\n/g, '<br>')}
                </div>
                <div class="section-block" style="border-left-color:var(--warning);">
                    <strong>üñ•Ô∏è Mat√©riel install√©:</strong><br>${escapeHtml(e.mat).replace(/\n/g, '<br>')}
                </div>
                ${e.network ? `<div class="section-block" style="border-left-color:var(--info);">
                    <strong>üåê Configuration r√©seau:</strong><br>${escapeHtml(e.network).replace(/\n/g, '<br>')}
                </div>` : ''}
                ${e.parts ? `<div class="section-block">
                    <strong>üì¶ Pi√®ces/Consommables:</strong><br>${escapeHtml(e.parts).replace(/\n/g, '<br>')}
                </div>` : ''}
                ${e.recommendations ? `<div class="section-block" style="border-left-color:var(--success);">
                    <strong>üí° Recommandations:</strong><br>${escapeHtml(e.recommendations).replace(/\n/g, '<br>')}
                </div>` : ''}
                ${testsHTML}
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:15px 0;">
                    <div>
                        <div style="font-size:10px; font-weight:700; color:#e67e22; margin-bottom:5px;">AVANT (${e.before.length})</div>
                        ${e.before.map(p => renderPhotoInTimeline(p, '#e67e22')).join('')}
                    </div>
                    <div>
                        <div style="font-size:10px; font-weight:700; color:#3498db; margin-bottom:5px;">PENDANT (${(e.during || []).length})</div>
                        ${(e.during || []).map(p => renderPhotoInTimeline(p, '#3498db')).join('')}
                    </div>
                    <div>
                        <div style="font-size:10px; font-weight:700; color:#2ecc71; margin-bottom:5px;">APR√àS (${e.after.length})</div>
                        ${e.after.map(p => renderPhotoInTimeline(p, '#2ecc71')).join('')}
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                    <img src="${escapeHtml(e.sig)}" 
                         style="width:140px; background:white; border-radius:6px; padding:5px; border:2px solid #ddd;">
                    <button class="no-print" 
                            style="color:var(--danger); border:1px solid var(--danger); background:rgba(255,77,77,0.1); font-size:11px; cursor:pointer; padding:8px 12px; border-radius:6px; font-weight:700;" 
                            onclick="confirmDeleteEntry(${e.id})">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        `;
    });
    
    if (entries.length === 0) {
        t.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0;">Aucune intervention</p>';
    }
}

function calculateDuration(timeIn, timeOut) {
    if (!timeIn || !timeOut) return '';
    const [inH, inM] = timeIn.split(':').map(Number);
    const [outH, outM] = timeOut.split(':').map(Number);
    const minutes = (outH * 60 + outM) - (inH * 60 + inM);
    if (minutes <= 0) return '';
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h}h${m > 0 ? m.toString().padStart(2, '0') : ''}`;
}

function renderPhotoInTimeline(photo, borderColor) {
    const hasAnnotations = photo.annotations && photo.annotations.length > 0;
    return `
        <img src="${escapeHtml(photo.src)}" 
             style="width:100%; border:2px solid ${borderColor}; border-radius:6px; margin-bottom:8px; transform: rotate(${photo.rotation || 0}deg); cursor:pointer;"
             onclick="openImageModal('', 0)" alt="Photo">
        ${hasAnnotations ? `<div style="font-size:9px; color:${borderColor}; margin-bottom:5px;">‚úèÔ∏è ${photo.annotations.length} mesure(s)</div>` : ''}
        ${photo.note ? `<div style="font-size:10px; color:#888; margin-bottom:10px;">${escapeHtml(photo.note)}</div>` : ''}
    `;
}

function confirmDeleteEntry(id) {
    showModal(
        'Supprimer l\'intervention',
        'Action irr√©versible. Continuer ?',
        'Supprimer',
        () => deleteEntry(id)
    );
}

function deleteEntry(id) {
    db[cur].entries = db[cur].entries.filter(e => e.id !== id);
    saveToIndexedDB();
    showTimeline();
    updateStats();
    showToast('‚úì Intervention supprim√©e', 'success');
}

function newIntervention() {
    nextStep(1);
}

function toggleStatus() {
    db[cur].status = (db[cur].status === 'done' ? 'ongoing' : 'done');
    saveToIndexedDB();
    showTimeline();
    loadList();
    updateStats();
    showToast(`‚úì Projet ${db[cur].status === 'done' ? 'archiv√©' : 'r√©activ√©'}`, 'success');
}

function confirmDeleteProject() {
    showModal(
        '‚ö†Ô∏è Supprimer le projet',
        `Toutes les interventions pour "${cur}" seront supprim√©es. Irr√©versible.`,
        'Supprimer',
        deleteFullProject
    );
}

function deleteFullProject() {
    delete db[cur];
    saveToIndexedDB();
    updateStats();
    showToast('‚úì Projet supprim√©', 'success');
    nextStep(0);
}

// ========== LIST & STATS ==========
function filterProjects() {
    const query = document.getElementById('searchBar').value.toLowerCase();
    loadList(query);
}

function loadList(query = '') {
    const list = document.getElementById('project-list');
    list.innerHTML = '';
    
    const projects = Object.keys(db)
        .filter(key => key !== '_version')
        .sort((a, b) => {
            const aDate = db[a].entries.length > 0 ? new Date(db[a].entries[db[a].entries.length - 1].timestamp) : new Date(db[a].created);
            const bDate = db[b].entries.length > 0 ? new Date(db[b].entries[db[b].entries.length - 1].timestamp) : new Date(db[b].created);
            return bDate - aDate;
        });
    
    let displayedCount = 0;
    
    projects.forEach(id => {
        const project = db[id];
        
        if (project.status !== currentFilter) return;
        if (query && !id.toLowerCase().includes(query)) return;
        
        const lastEntry = project.entries[project.entries.length - 1];
        const lastDate = lastEntry ? lastEntry.date : 'Aucune intervention';
        const entryCount = project.entries.length;
        
        list.innerHTML += `
            <div class="folder-card" onclick="cur='${escapeHtml(id)}';nextStep(5);">
                <div class="folder-info">
                    <div class="folder-name">${escapeHtml(id)}</div>
                    <div class="folder-meta">
                        ${entryCount} intervention${entryCount > 1 ? 's' : ''} ‚Ä¢ ${escapeHtml(lastDate)}
                    </div>
                </div>
                <div class="folder-arrow">‚ùØ</div>
            </div>
        `;
        displayedCount++;
    });
    
    if (displayedCount === 0) {
        list.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0;">Aucun projet</p>';
    }
}

function updateStats() {
    let activeCount = 0;
    let totalInterventions = 0;
    let totalMinutes = 0;
    let thisMonth = 0;
    
    const now = new Date();
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    Object.keys(db).forEach(key => {
        if (key === '_version') return;
        const project = db[key];
        
        if (project.status === 'ongoing') activeCount++;
        totalInterventions += project.entries.length;
        
        project.entries.forEach(e => {
            if (e.in && e.out) {
                const [inH, inM] = e.in.split(':').map(Number);
                const [outH, outM] = e.out.split(':').map(Number);
                const minutes = (outH * 60 + outM) - (inH * 60 + inM);
                if (minutes > 0) totalMinutes += minutes;
            }
            
            const entryDate = new Date(e.timestamp || e.date);
            if (entryDate >= thisMonthStart) thisMonth++;
        });
    });
    
    document.getElementById('stat-active').textContent = activeCount;
    document.getElementById('stat-total').textContent = totalInterventions;
    
    const hours = Math.floor(totalMinutes / 60);
    document.getElementById('stat-hours').textContent = `${hours}h`;
    document.getElementById('stat-month').textContent = thisMonth;
}

// ========== PROJECT MANAGEMENT ==========
function showNewProjectOptions() {
    const name = prompt('üìÅ Nom du projet / client :');
    if (!name) return;
    
    const trimmed = name.trim();
    if (!trimmed) {
        showToast('‚ö†Ô∏è Le nom ne peut pas √™tre vide', 'error');
        return;
    }
    
    if (db[trimmed]) {
        showToast('‚ö†Ô∏è Ce projet existe d√©j√†', 'error');
        return;
    }
    
    db[trimmed] = {
        entries: [],
        status: 'ongoing',
        created: new Date().toISOString()
    };
    
    saveToIndexedDB();
    loadList();
    showToast('‚úì Nouveau projet cr√©√©', 'success');
}

// ========== EXPORT FUNCTIONS ==========
function exportToCSV() {
    let csv = '\uFEFFProjet;Date;Type;Equipe;Arrivee;Depart;Duree;Materiel;Travaux;Reseau;GPS_Lat;GPS_Lng\n';
    
    Object.keys(db).forEach(client => {
        if (client === '_version') return;
        
        db[client].entries.forEach(e => {
            const gpsLat = e.gps ? e.gps.lat : '';
            const gpsLng = e.gps ? e.gps.lng : '';
            const duration = calculateDuration(e.in, e.out);
            csv += `"${escapeCSV(client)}";`;
            csv += `"${escapeCSV(e.date)}";`;
            csv += `"${escapeCSV(e.type)}";`;
            csv += `"${escapeCSV(e.staff)}";`;
            csv += `"${escapeCSV(e.in)}";`;
            csv += `"${escapeCSV(e.out)}";`;
            csv += `"${escapeCSV(duration)}";`;
            csv += `"${escapeCSV(e.mat)}";`;
            csv += `"${escapeCSV(e.done)}";`;
            csv += `"${escapeCSV(e.network || '')}";`;
            csv += `"${escapeCSV(gpsLat)}";`;
            csv += `"${escapeCSV(gpsLng)}"\n`;
        });
    });
    
    downloadFile(csv, `Vertex_Export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
    showToast('‚úÖ Export CSV g√©n√©r√©', 'success');
}

function exportBackup() {
    const backup = {
        version: CONFIG.DB_VERSION,
        appVersion: '2.0',
        exportDate: new Date().toISOString(),
        data: db
    };
    
    const json = JSON.stringify(backup, null, 2);
    downloadFile(json, `Vertex_Backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    showToast('‚úÖ Sauvegarde g√©n√©r√©e', 'success');
}

function importBackup(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.data || !backup.version) {
                throw new Error('Format invalide');
            }
            
            showModal(
                'Restaurer les donn√©es',
                `${Object.keys(backup.data).length} projets seront import√©s. Continuer ?`,
                'Restaurer',
                () => {
                    db = backup.data;
                    saveToIndexedDB();
                    loadList();
                    updateStats();
                    showToast('‚úÖ Donn√©es restaur√©es', 'success');
                }
            );
        } catch (err) {
            showToast('‚ùå Fichier invalide', 'error');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function exportProjectPDF() {
    showToast('üñ®Ô∏è G√©n√©ration PDF...', 'info');
    setTimeout(() => window.print(), 500);
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename);
    link.click();
}

function sendProjectMail() {
    const entries = db[cur].entries;
    if (!entries.length) return;
    
    const lastEntry = entries[entries.length - 1];
    
    const subject = encodeURIComponent(`Rapport Vertex - ${cur} - ${lastEntry.date}`);
    let body = `PROJET: ${cur}\n\n`;
    body += `TYPE: ${lastEntry.type}\n`;
    body += `DATE: ${lastEntry.date}\n`;
    body += `√âQUIPE: ${lastEntry.staff}\n`;
    body += `HORAIRES: ${lastEntry.in} - ${lastEntry.out}\n\n`;
    body += `MAT√âRIEL:\n${lastEntry.mat}\n\n`;
    body += `TRAVAUX:\n${lastEntry.done}\n\n`;
    if (lastEntry.network) body += `R√âSEAU:\n${lastEntry.network}\n\n`;
    if (lastEntry.recommendations) body += `RECOMMANDATIONS:\n${lastEntry.recommendations}\n\n`;
    if (lastEntry.gps) body += `GPS: ${lastEntry.gps.lat}, ${lastEntry.gps.lng}\n`;
    body += `\n--- Vertex Monaco Digital Signage ---`;
    
    window.location.href = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
}

// ========== UTILITIES ==========
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeCSV(text) {
    if (!text) return '';
    return text.toString().replace(/"/g, '""').replace(/\n/g, ' ');
}

window.onresize = () => {
    if (document.getElementById('step4')?.classList.contains('active')) {
        resizeCanvas();
    }
};

console.log('‚úÖ Vertex Monaco Digital Signage V2.0 - Syst√®me charg√©');

console.log('‚úÖ Vertex Monaco Digital Signage System Loaded');
</script>

</body>
</html>
