<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vertex Monaco | Précision Certifiée</title>
    <style>
        :root { --gold: #D4AF37; --gold-dark: #B8860B; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        
        #video-preview { position: absolute; width: 100%; height: 100%; object-fit: cover; }

        /* HUD Supérieur */
        .hud-top {
            position: absolute; top: 0; width: 100%; padding: 30px 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            text-align: center; z-index: 10;
        }
        .data-stream { font-family: monospace; font-size: 10px; color: var(--gold); letter-spacing: 1px; }

        /* Niveau à Bulle Gold */
        .level-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150px; height: 150px; border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%; pointer-events: none; z-index: 5;
        }
        #bubble {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            background: var(--gold); border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 15px var(--gold); transition: all 0.1s ease-out;
        }
        .center-target {
            position: absolute; top: 50%; left: 50%; width: 30px; height: 30px;
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);
        }

        /* Bouton dynamique */
        .btn-vertex {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: black; border: none;
            padding: 18px 40px; border-radius: 4px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 2px; cursor: pointer;
            z-index: 100; opacity: 0.3; pointer-events: none; transition: 0.3s;
        }
        .active { opacity: 1 !important; pointer-events: auto !important; box-shadow: 0 0 20px var(--gold); }

        /* Panel Résultat */
        #result-panel {
            position: absolute; bottom: 0; width: 100%; background: white; color: black;
            padding: 35px; transform: translateY(100%); transition: 0.6s; z-index: 200;
            border-radius: 20px 20px 0 0; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <video id="video-preview" autoplay playsinline></video>

    <div class="hud-top">
        <div class="data-stream">ACCEL: <span id="accel-val">0.00</span> | GYRO: <span id="gyro-val">0.00</span></div>
        <div id="instruction" style="margin-top: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">Stabilisez l'appareil</div>
    </div>

    <div class="level-container">
        <div class="center-target"></div>
        <div id="bubble"></div>
    </div>

    <button id="action-btn" class="btn-vertex">Marquer Point A</button>

    <div id="result-panel">
        <h2 style="color:var(--gold-dark); margin:0;">DIAGNOSTIC VERTEX</h2>
        <p id="final-measure" style="font-size: 24px; font-weight: bold; margin: 20px 0;">Surface : ---</p>
        <button onclick="location.reload()" style="width:100%; padding:15px; background:black; color:white; border:none; border-radius:5px;">NOUVELLE ANALYSE</button>
    </div>

    <script>
        const bubble = document.getElementById('bubble');
        const btn = document.getElementById('action-btn');
        const accelLabel = document.getElementById('accel-val');
        const gyroLabel = document.getElementById('gyro-val');
        const instr = document.getElementById('instruction');

        let isLevel = false;
        let step = 0;
        let angleA = 0;

        // Demander l'autorisation pour les capteurs (iOS 13+)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            btn.innerText = "ACTIVER CAPTEURS";
            btn.classList.add('active');
            btn.onclick = () => {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') location.reload();
                });
            };
        }

        window.addEventListener('deviceorientation', (event) => {
            const beta = event.beta;  // Inclinaison avant/arrière
            const gamma = event.gamma; // Inclinaison gauche/droite

            // Mise à jour visuelle du niveau à bulle
            const moveX = Math.min(Math.max(gamma, -60), 60);
            const moveY = Math.min(Math.max(beta - 70, -60), 60); // 70° est l'angle de lecture naturel
            
            bubble.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
            
            accelLabel.innerText = beta.toFixed(2);
            gyroLabel.innerText = gamma.toFixed(2);

            // Vérifier si le téléphone est droit
            if (Math.abs(gamma) < 3 && Math.abs(beta - 85) < 10) {
                isLevel = true;
                bubble.style.background = "#00FF88";
                if(step < 2) btn.classList.add('active');
                if(step === 0) instr.innerText = "Appareil stable. Marquez le bord gauche.";
            } else {
                isLevel = false;
                bubble.style.background = "var(--gold)";
                btn.classList.remove('active');
                instr.innerText = "Ajustez l'inclinaison";
            }
        });

        btn.addEventListener('click', () => {
            step++;
            if (step === 1) {
                angleA = parseFloat(gyroLabel.innerText);
                btn.innerText = "Marquer Point B";
                instr.innerText = "Pivotez vers le bord droit";
            } else if (step === 2) {
                const angleB = parseFloat(gyroLabel.innerText);
                const diff = Math.abs(angleB - angleA);
                
                // Calcul trigonométrique simplifié (distance supposée de 2m pour l'exemple)
                const width = (2 * Math.tan(diff * Math.PI / 180)).toFixed(2);
                
                document.getElementById('final-measure').innerText = `Largeur : ${width} m`;
                document.getElementById('result-panel').style.transform = "translateY(0)";
                btn.style.display = "none";
            }
        });
    </script>
</body>
</html>
