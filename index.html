<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vertex Monaco | Unified Field Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --gold-dark: #B8860B; --bg: #000000; --card: #121212; --text: #ffffff; --danger: #e74c3c; --success: #2ecc71; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: 0 auto; padding: 10px 20px 100px 20px; }
        
        /* Header & Utils */
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(212, 175, 55, 0.2); margin-bottom: 20px; }
        .header h1 { letter-spacing: 5px; font-size: 14px; color: var(--gold); margin: 0; }
        .reset-link { text-align: right; margin-bottom: 10px; }
        .reset-link button { background: none; border: none; color: var(--danger); font-size: 10px; cursor: pointer; opacity: 0.6; }

        /* Steps */
        .step { display: none; animation: fadeIn 0.4s ease; }
        .step.active { display: block; }

        /* Form Elements */
        .field-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        
        input, select, textarea { 
            width: 100%; padding: 15px; background: var(--card); border: 1px solid #222; 
            color: white; border-radius: 4px; font-size: 15px; box-sizing: border-box; outline: none;
        }
        input:focus { border-color: var(--gold); }
        
        .checkbox-group { display: flex; align-items: center; margin-bottom: 10px; background: #161616; padding: 12px; border-radius: 4px; cursor: pointer; }
        .checkbox-group input { width: auto; margin-right: 15px; transform: scale(1.3); }

        /* Diagnostic Tools */
        .diag-panel { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #222; margin-bottom: 20px; }
        .diag-status { font-size: 10px; color: var(--gold); font-family: monospace; margin-top: 10px; }

        /* Photo & Signature */
        .media-box { width: 100%; min-height: 180px; background: #000; border: 1px dashed #444; margin-bottom: 10px; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .media-box img { width: 100%; height: 100%; object-fit: contain; }
        #sig-canvas { background: white; width: 100%; height: 150px; touch-action: none; border-radius: 4px; }

        /* Buttons */
        .btn-gold { width: 100%; padding: 20px; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: black; border: none; font-weight: 900; letter-spacing: 2px; cursor: pointer; border-radius: 4px; text-transform: uppercase; }
        .btn-outline { width: 100%; padding: 12px; background: transparent; color: white; border: 1px solid #333; margin-top: 5px; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .btn-outline:active { background: var(--gold); color: black; }

        /* Report View */
        .summary-card { background: var(--card); padding: 15px; border-left: 3px solid var(--gold); margin-bottom: 8px; font-size: 14px; }
        .summary-card strong { color: var(--gold); display: block; font-size: 11px; margin-bottom: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .btn-gold, .btn-outline, .reset-link { display: none; } body { background: white; color: black; } .summary-card { border: 1px solid #ddd; } }
    </style>
</head>
<body>

<div class="container">
    <div class="reset-link">
        <button onclick="clearStorage()">Ã— RÃ‰INITIALISER LE FORMULAIRE</button>
    </div>

    <div class="header">
        <h1>VERTEX MONACO</h1>
        <p style="font-size: 9px; opacity: 0.5; letter-spacing: 2px;">FIELD SURVEY & DIAGNOSTIC SYSTEM</p>
    </div>

    <div class="step active" id="step1">
        <div class="field-group">
            <label>Type d'intervention</label>
            <select id="mission_type" onchange="toggleMissionFields()">
                <option value="installation">Installation Neuve</option>
                <option value="audit">Audit / RelevÃ© de cotes</option>
                <option value="SAV">RÃ©paration / SAV</option>
                <option value="maintenance">Maintenance PrÃ©ventive</option>
            </select>
        </div>
        <div class="field-group">
            <label>Projet / Client</label>
            <input type="text" id="client_name" placeholder="ex: Monaco Yacht Club">
        </div>
        <div class="field-group">
            <label>Intervenant Vertex</label>
            <input type="text" id="staff_name" placeholder="Nom du technicien">
        </div>
        <button class="btn-gold" onclick="nextStep(2)">DÃ‰MARRER</button>
    </div>

    <div class="step" id="step2">
        <div class="diag-panel">
            <label>Outils de Terrain Vertex</label>
            <div style="display: flex; gap: 8px;">
                <button class="btn-outline" style="flex:1" onclick="checkConnection()">TEST RÃ‰SEAU</button>
                <button class="btn-outline" style="flex:1" onclick="getVertexLocation()">GEO-TAG GPS</button>
            </div>
            <div id="diag_display" class="diag-status">Diagnostic : PrÃªt</div>
        </div>

        <div class="field-group">
            <label>Dimensions Emplacement (L x H en cm)</label>
            <input type="text" id="dimensions" placeholder="ex: 125 x 210">
        </div>
        
        <label>Infrastructure</label>
        <div class="checkbox-group"><input type="checkbox" id="check_elec"><span>Alimentation Ã©lectrique OK</span></div>
        <div class="checkbox-group"><input type="checkbox" id="check_net"><span>Prise RJ45 / Wi-Fi OK</span></div>
        <div class="checkbox-group"><input type="checkbox" id="check_nacelle"><span>Besoin Nacelle / AccÃ¨s spÃ©cial</span></div>

        <div id="install-only" class="field-group" style="margin-top:20px;">
            <label>LuminositÃ© requise (NITS)</label>
            <input type="range" id="nits" min="500" max="5000" step="500" value="2500" oninput="this.nextElementSibling.value = this.value + ' NITS'">
            <output style="display:block; text-align:center; font-weight:900; color:var(--gold); margin-top:5px;">2500 NITS</output>
        </div>

        <button class="btn-gold" onclick="nextStep(3)">SUIVANT</button>
        <button class="btn-outline" style="width:100%" onclick="nextStep(1)">RETOUR</button>
    </div>

    <div class="step" id="step3">
        <div id="sav-only" style="display:none;">
            <label style="color:var(--danger)">Rapport de Panne</label>
            <textarea id="sav_diag" rows="4" placeholder="SymptÃ´mes constatÃ©s..."></textarea>
            <div class="checkbox-group"><input type="checkbox" id="check_reboot"><span>RedÃ©marrage effectuÃ©</span></div>
        </div>

        <div class="field-group">
            <label>MatÃ©riel concernÃ© (ModÃ¨le)</label>
            <input type="text" id="model_ref" placeholder="ex: Double-Face 55 pouces">
        </div>

        <div class="field-group">
            <label>Observations GÃ©nÃ©rales</label>
            <textarea id="obs" rows="4" placeholder="Notes techniques, environnement..."></textarea>
        </div>

        <button class="btn-gold" onclick="nextStep(4)">PHOTOS & SIGNATURE</button>
        <button class="btn-outline" style="width:100%" onclick="nextStep(2)">RETOUR</button>
    </div>

    <div class="step" id="step4">
        <label>Photo de l'intervention</label>
        <div class="media-box">
            <img id="img_prev" style="display:none;">
            <span id="img_msg">PAS DE PHOTO CAPTURÃ‰E</span>
        </div>
        <input type="file" id="cam" accept="image/*" capture="environment" style="display:none;">
        <button class="btn-outline" onclick="document.getElementById('cam').click()" style="color:var(--gold); border-color:var(--gold); margin-bottom:30px; width:100%; font-size: 14px; padding: 15px;">ðŸ“¸ CAPTURER PHOTO</button>

        <label>Signature Client / Validation</label>
        <canvas id="sig-canvas"></canvas>
        <button class="btn-outline" onclick="clearSig()" style="font-size: 10px; padding: 5px; margin-top: 5px;">EFFACER LA SIGNATURE</button>

        <button class="btn-gold" style="margin-top:40px;" onclick="generateFinalReport()">GÃ‰NÃ‰RER LE RAPPORT</button>
        <button class="btn-outline" style="width:100%" onclick="nextStep(3)">RETOUR</button>
    </div>

    <div class="step" id="step5">
        <h2 style="color:var(--gold); margin:0 0 20px 0;">RAPPORT D'INTERVENTION</h2>
        <div id="report_output"></div>
        
        <div class="btn-group" style="display:flex; gap:10px; margin-top:30px;">
            <button class="btn-gold" style="flex:2;" onclick="sendMail()">ENVOYER PAR EMAIL</button>
            <button class="btn-outline" style="flex:1;" onclick="window.print()">PDF</button>
        </div>
        <button class="btn-outline" onclick="clearStorage()" style="width:100%; margin-top:10px;">NOUVELLE MISSION</button>
    </div>
</div>

<script>
    let photoData = "";
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let currentGeo = "Non gÃ©olocalisÃ©";

    // --- NAVIGATION ---
    function nextStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        window.scrollTo(0,0);
        if(n === 4) resizeCanvas();
    }

    function toggleMissionFields() {
        const type = document.getElementById('mission_type').value;
        document.getElementById('sav-only').style.display = (type === 'SAV') ? 'block' : 'none';
        document.getElementById('install-only').style.display = (type === 'installation') ? 'block' : 'none';
    }

    // --- DIAGNOSTIC TOOLS ---
    function checkConnection() {
        const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        let info = "RÃ©seau : ConnectÃ©";
        if (conn) {
            info = `RÃ©seau : ${conn.effectiveType.toUpperCase()} (~${conn.rtt}ms latence)`;
        }
        document.getElementById('diag_display').innerText = info;
        document.getElementById('obs').value += `\n[Diagnostic RÃ©seau : ${info}]`;
    }

    function getVertexLocation() {
        if (navigator.geolocation) {
            document.getElementById('diag_display').innerText = "Recherche satellite GPS...";
            navigator.geolocation.getCurrentPosition((pos) => {
                currentGeo = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                document.getElementById('diag_display').innerText = `GPS OK : ${currentGeo}`;
                document.getElementById('obs').value += `\n[Validation GPS : ${currentGeo}]`;
            }, () => {
                document.getElementById('diag_display').innerText = "GPS : AccÃ¨s refusÃ©";
            });
        }
    }

    // --- SAUVEGARDE AUTO (LocalStorage) ---
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            const data = {};
            inputs.forEach(i => {
                data[i.id] = i.type === 'checkbox' ? i.checked : i.value;
            });
            localStorage.setItem('vertex_elite_backup', JSON.stringify(data));
        });
    });

    window.addEventListener('load', () => {
        const backup = localStorage.getItem('vertex_elite_backup');
        if (backup) {
            const data = JSON.parse(backup);
            Object.keys(data).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === 'checkbox') el.checked = data[id];
                    else el.value = data[id];
                }
            });
            toggleMissionFields();
        }
    });

    function clearStorage() {
        if(confirm("Action irrÃ©versible : Effacer les donnÃ©es et rÃ©initialiser ?")) {
            localStorage.removeItem('vertex_elite_backup');
            location.reload();
        }
    }

    // --- GESTION PHOTO ---
    document.getElementById('cam').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                photoData = event.target.result;
                document.getElementById('img_prev').src = photoData;
                document.getElementById('img_prev').style.display = 'block';
                document.getElementById('img_msg').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    // --- SIGNATURE CANVAS ---
    function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
    }
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function start(e) { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
    function draw(e) { if(!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }
    function stop() { drawing = false; }
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', stop);
    canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stop);
    function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    // --- RAPPORT FINAL ---
    function generateFinalReport() {
        const now = new Date();
        const data = {
            "CLIENT": document.getElementById('client_name').value,
            "TYPE MISSION": document.getElementById('mission_type').value.toUpperCase(),
            "TECHNICIEN": document.getElementById('staff_name').value,
            "DIMENSIONS": document.getElementById('dimensions').value,
            "MODÃˆLE Ã‰CRAN": document.getElementById('model_ref').value,
            "LUMINOSITÃ‰": document.getElementById('nits').value + " NITS",
            "NOTES": document.getElementById('obs').value,
            "DATE & HEURE": now.toLocaleString('fr-FR'),
            "LOCALISATION": currentGeo
        };

        let html = "";
        for (const [key, val] of Object.entries(data)) {
            html += `<div class="summary-card"><strong>${key}</strong>${val || '---'}</div>`;
        }

        if(photoData) html += `<div class="summary-card"><strong>PHOTO CAPTURÃ‰E</strong><img src="${photoData}" style="width:100%; border-radius:4px; margin-top:5px;"></div>`;
        
        const sigData = canvas.toDataURL();
        html += `<div class="summary-card" style="background:white; color:black;"><strong>SIGNATURE VALIDÃ‰E</strong><img src="${sigData}" style="width:100%; margin-top:5px;"></div>`;

        document.getElementById('report_output').innerHTML = html;
        nextStep(5);
    }

    // --- EMAIL ---
    function sendMail() {
        const client = document.getElementById('client_name').value || "Client";
        const subject = encodeURIComponent(`Vertex Monaco Rapport - ${client}`);
        const body = encodeURIComponent(`Bonjour,\n\nVeuillez trouver ci-joint le rapport Vertex Monaco.\n\nProjet: ${client}\nTechnicien: ${document.getElementById('staff_name').value}\nDate: ${new Date().toLocaleString()}\n\nNote: Le rapport complet avec photos et signatures est disponible en version PDF via l'outil.`);
        window.location.href = `mailto:contact@votre-domaine.com?subject=${subject}&body=${body}`;
    }
</script>

</body>
</html>
