<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D4AF37">
    <meta name="description" content="Vertex Monaco - Syst√®me de gestion d'interventions techniques professionnel">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA7AAAAOwBeShxvQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAIcSURBVFiFxZe/axRBFMc/M3t7t7eXS3KJiYqIYGER0MJCsFAQbPwDLCz8A2wsBEELCyurbWwEwUKwsBEUBEWwUFDQQkQQRTQxJnfZ3Z2Zx8yevdvb3CTqwYNl5+2b7/d9M+/NPJBSSimllFJKKaX/ScYYtNbYto1t2xiGcd5rT1Gr1ahWq7TbbQCMMViWheu6OI6DbdvnAnG6Uq/XqdVqRFFEGIYopVBKYZomlmXheR6+7+N5HpZlnRnkqQLNZpNGo0Gr1SKKIoIgQGuNMQbDMDAMA9M08X0fz/MoFAp4nofruniet2+I3wqEYUiz2aTRaNBqtYiiiFQqRRRFJxpzXZd0Ok0mk8H3ffL5PIVCAcdxjgU5ViAIAlqtFo1Gg3a7TRAEKKXQWZ8oigiCAK01bOA4DplMhnQ6jeM45HI5CoUC+XyedDp9cAClFO12m1qtxs7ODmEYYpomURQRhiFRFKG1RilFEARxVjKZDJlMhnQ6jeu65HI5stks2WwW27YPCxiGQbvdplKp0Gw2iaKIdDod/08xCCEwTTNut23jeR6ZTAbf9/F9n2w2SyaTwXGcgwK2bbO7u8vW1ha1Wo0oikilUiilCMPw0LjOQD6fp1gsksvlyOVyZLPZQwKe57G5ucna2hq1Wo0oivA8jyiK4h04ynVdisUihUKBYrFIJpOJWzEhYNs2m5ub/Pz5k0ajQavVot1uH3sqXdclm82Sz+cpFouUSiVKpRKe5x28hZRSSimllFL6X/4C9gfhI6xNdH0AAAAASUVORK5CYII=">
    <title>Vertex Monaco | V14 ULTRA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #D4AF37; 
            --bg: #000; 
            --card: #121212; 
            --text: #fff; 
            --danger: #ff4d4d; 
            --success: #2ecc71; 
            --border: #282828;
            --warning: #f39c12;
            --info: #3498db;
        }
        
        [data-theme="light"] {
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #000;
            --border: #ddd;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; line-height: 1.4; overflow-x: hidden; transition: background 0.3s, color 0.3s; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        
        .header { text-align: center; padding: 15px 0; border-bottom: 2px solid var(--gold); margin-bottom: 20px; position: relative; }
        .header h1 { letter-spacing: 4px; font-size: 16px; color: var(--gold); margin: 0; font-weight: 900; }
        .version-badge { position: absolute; top: 10px; right: 10px; font-size: 8px; background: var(--gold); color: black; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
        .theme-toggle { position: absolute; top: 10px; left: 10px; background: none; border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        
        .offline-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 8px 15px; border-radius: 20px; font-size: 11px; font-weight: bold; z-index: 10000; display: none; }
        .offline-indicator.active { display: block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .sync-indicator { position: fixed; top: 80px; right: 20px; background: var(--info); color: white; padding: 8px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; z-index: 9999; display: none; }
        .sync-indicator.active { display: block; animation: fadeIn 0.3s; }

        /* Toast notifications */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 15px 25px; border-radius: 8px; font-size: 13px; font-weight: bold; z-index: 9999; animation: slideDown 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }
        @keyframes slideDown { from { transform: translateX(-50%) translateY(-100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

        /* Progress indicator */
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .progress-step { flex: 1; text-align: center; position: relative; }
        .progress-step::before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--border); z-index: -1; }
        .progress-step:first-child::before { left: 50%; }
        .progress-step:last-child::before { right: 50%; }
        .progress-dot { width: 30px; height: 30px; border-radius: 50%; background: var(--border); margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .progress-step.active .progress-dot { background: var(--gold); color: black; }
        .progress-step.completed .progress-dot { background: var(--success); color: white; }
        .progress-label { font-size: 9px; color: #666; }

        .step { display: none; animation: fadeIn 0.2s ease; }
        .step.active { display: block; }

        /* Loading spinner */
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--gold); border-radius: 50%; width: 30px; height: 30px; animation: spin 0.8s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tabs & Types */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { flex: 1; min-width: 80px; padding: 12px; background: var(--card); border: 1px solid var(--border); color: #666; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .tab-btn:active { transform: scale(0.98); }

        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .type-chip { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 8px; text-align: center; font-size: 10px; font-weight: bold; color: #666; cursor: pointer; transition: all 0.2s; }
        .type-chip.selected { border-color: var(--gold); color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        .type-chip:active { transform: scale(0.95); }

        .staff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .staff-chip { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 6px; font-size: 11px; text-align: center; color: #888; cursor: pointer; transition: all 0.2s; }
        .staff-chip.selected { background: var(--gold); color: #000; font-weight: 800; border-color: var(--gold); }
        .staff-chip:active { transform: scale(0.95); }

        /* Checklist */
        .check-item { display: flex; align-items: center; background: var(--card); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); transition: all 0.2s; }
        .check-item:has(input:checked) { background: rgba(46, 204, 113, 0.1); border-color: var(--success); }
        .check-item input { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--gold); cursor: pointer; }

        /* Photos */
        .photo-box { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-top: 15px; }
        .photo-box h4 { margin: 0 0 10px 0; font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .photo-gallery { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .photo-card { background: var(--card); padding: 8px; border-radius: 8px; border: 1px solid var(--border); position: relative; }
        .photo-card img { width: 100%; border-radius: 4px; margin-bottom: 8px; max-height: 300px; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
        .photo-card img:hover { transform: scale(1.02); }
        .photo-input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px; font-size: 12px; width: 100%; border-radius: 4px; margin-bottom: 5px; }
        .photo-size { font-size: 9px; color: #666; margin-bottom: 5px; }
        .photo-controls { display: flex; gap: 5px; margin-top: 5px; }
        .photo-controls button { flex: 1; padding: 6px; font-size: 9px; border-radius: 4px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; }

        /* Image modal */
        .image-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10001; align-items: center; justify-content: center; padding: 20px; }
        .image-modal.active { display: flex; animation: fadeIn 0.3s; }
        .image-modal img { max-width: 100%; max-height: 90vh; border-radius: 8px; }
        .image-modal-close { position: absolute; top: 20px; right: 20px; background: var(--danger); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Signature */
        #sig-canvas { background: #fff; border: 2px solid var(--gold); border-radius: 8px; touch-action: none; width: 100%; height: 200px; cursor: crosshair; }

        /* Buttons */
        .btn-gold { width: 100%; padding: 18px; background: var(--gold); color: black; border: none; font-weight: 900; border-radius: 10px; text-transform: uppercase; margin-top: 15px; cursor: pointer; transition: all 0.2s; }
        .btn-gold:active { transform: scale(0.98); }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { width: 100%; padding: 12px; background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; cursor: pointer; transition: all 0.2s; }
        .btn-outline:active { transform: scale(0.98); }
        .btn-now { background: var(--card); color: var(--gold); border: 1px solid var(--gold); padding: 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; width: 100%; cursor: pointer; transition: all 0.2s; }
        .btn-now:active { transform: scale(0.95); }
        .btn-danger { width: 100%; padding: 12px; background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); border-radius: 8px; margin-top: 20px; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-danger:active { transform: scale(0.98); }

        label { display: block; margin: 15px 0 5px 0; font-size: 10px; font-weight: 700; color: var(--gold); text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 15px; }
        textarea { font-family: 'Inter', sans-serif; resize: vertical; }

        .timeline-item { border-left: 3px solid var(--gold); padding-left: 15px; margin-bottom: 40px; position: relative; }
        .section-block { background: var(--card); padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 2px solid #444; font-size: 13px; border: 1px solid var(--border); }

        /* Folder cards */
        .folder-card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
        .folder-card:hover { border-color: var(--gold); background: rgba(212, 175, 55, 0.05); }
        .folder-card:active { transform: scale(0.98); }
        .folder-info { flex: 1; }
        .folder-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .folder-meta { font-size: 10px; color: #666; }
        .folder-arrow { color: var(--gold); font-size: 20px; }

        /* Stats cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 900; color: var(--gold); }
        .stat-label { font-size: 9px; color: #666; text-transform: uppercase; margin-top: 5px; }

        /* Charts */
        .chart-container { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin: 15px 0; }
        .chart-title { font-size: 11px; font-weight: bold; color: var(--gold); margin-bottom: 10px; text-transform: uppercase; }
        .chart-bar { background: var(--border); height: 30px; border-radius: 4px; margin-bottom: 8px; position: relative; overflow: hidden; }
        .chart-bar-fill { background: var(--gold); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; padding-left: 10px; font-size: 11px; font-weight: bold; color: black; }
        .chart-bar-label { font-size: 10px; margin-bottom: 3px; }

        /* Advanced search */
        .search-filters { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-top: 10px; }
        .filter-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

        /* Status pill */
        .status-pill { padding: 6px 12px; border-radius: 20px; font-size: 9px; font-weight: bold; cursor: pointer; border: none; transition: all 0.2s; }
        .status-ongoing { background: var(--success); color: white; }
        .status-done { background: #666; color: white; }
        .status-pill:active { transform: scale(0.95); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: var(--card); border: 1px solid var(--gold); border-radius: 10px; padding: 25px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 16px; font-weight: 900; color: var(--gold); margin-bottom: 15px; }
        .modal-body { font-size: 13px; margin-bottom: 20px; line-height: 1.6; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .modal-btn.confirm { background: var(--gold); color: black; }
        .modal-btn.cancel { background: transparent; color: var(--text); border: 1px solid var(--border); }

        /* Templates */
        .template-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .template-card:hover { border-color: var(--gold); }
        .template-card h4 { margin: 0 0 5px 0; font-size: 13px; color: var(--gold); }
        .template-card p { margin: 0; font-size: 11px; color: #666; }

        /* Voice recording */
        .voice-recorder { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-top: 10px; }
        .voice-btn.recording { background: var(--danger); color: white; animation: pulse 1s infinite; }

        /* Weather widget */
        .weather-widget { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin: 10px 0; display: flex; align-items: center; gap: 10px; }
        .weather-icon { font-size: 30px; }
        .weather-info { flex: 1; }
        .weather-temp { font-size: 18px; font-weight: bold; color: var(--gold); }
        .weather-desc { font-size: 11px; color: #666; }

        /* Calendar */
        .calendar { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin: 15px 0; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); }
        .calendar-day.today { background: var(--gold); color: black; font-weight: bold; }
        .calendar-day.has-event { background: rgba(46, 204, 113, 0.2); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media print { .no-print { display: none; } body { background: white; color: black; } }
        
        /* Install prompt */
        .install-prompt { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--gold); color: black; padding: 15px 20px; border-radius: 10px; font-size: 12px; font-weight: bold; z-index: 10000; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .install-prompt.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateX(-50%) translateY(100px); } to { transform: translateX(-50%) translateY(0); } }
        .install-prompt button { margin-left: 10px; padding: 8px 15px; background: black; color: var(--gold); border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="offline-indicator" id="offlineIndicator">üì° MODE HORS LIGNE</div>
<div class="sync-indicator" id="syncIndicator">üîÑ Synchronisation...</div>

<div class="container">
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        <h1>VERTEX MONACO</h1>
        <p style="font-size: 9px; color: var(--gold); letter-spacing: 2px;">V14 ULTRA | ENTERPRISE EDITION</p>
        <div class="version-badge">v14.0</div>
    </div>

    <!-- HOME / PROJECT LIST -->
    <div class="step active" id="step0">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total missions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-hours">0h</div>
                <div class="stat-label">Total heures</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-month">0</div>
                <div class="stat-label">Ce mois</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="tab-active" onclick="switchTab('ongoing')">EN COURS</button>
            <button class="tab-btn" id="tab-archived" onclick="switchTab('done')">ARCHIVES</button>
            <button class="tab-btn" id="tab-analytics" onclick="switchTab('analytics')">STATS</button>
            <button class="tab-btn" id="tab-calendar" onclick="switchTab('calendar')">PLANNING</button>
        </div>
        
        <div id="view-list">
            <button class="btn-gold" onclick="showNewProjectOptions()">+ NOUVEAU CLIENT</button>
            
            <input type="text" id="searchBar" oninput="filterProjects()" placeholder="üîç Rechercher un dossier..." style="margin-top:15px;">
            
            <div class="search-filters" id="advancedFilters" style="display:none;">
                <div class="filter-row">
                    <select id="filterType" onchange="filterProjects()">
                        <option value="">Tous types</option>
                        <option value="INSTALLATION">Installation</option>
                        <option value="MAINTENANCE">Maintenance</option>
                        <option value="D√âPANNAGE">D√©pannage</option>
                        <option value="AUDIT">Audit</option>
                    </select>
                    <select id="filterStaff" onchange="filterProjects()">
                        <option value="">Toute √©quipe</option>
                        <option value="Allan">Allan</option>
                        <option value="Pietro">Pietro</option>
                        <option value="Marco">Marco</option>
                        <option value="Osvaldo">Osvaldo</option>
                        <option value="Jean-Christophe">Jean-Christophe</option>
                    </select>
                </div>
                <div class="filter-row">
                    <input type="date" id="filterDateFrom" onchange="filterProjects()">
                    <input type="date" id="filterDateTo" onchange="filterProjects()">
                </div>
            </div>
            
            <button class="btn-outline" onclick="toggleAdvancedFilters()" style="margin-top:10px; font-size:10px;">
                üîé FILTRES AVANC√âS
            </button>
            
            <div id="project-list" style="margin-top:10px;"></div>
            
            <button class="btn-outline" onclick="exportToCSV()" style="margin-top:40px;">üìä EXPORT EXCEL (.CSV)</button>
            <button class="btn-outline" onclick="exportPDFReport()">üìÑ RAPPORT PDF GLOBAL</button>
            <button class="btn-outline" onclick="exportBackup()">üíæ SAUVEGARDER DONN√âES</button>
            <button class="btn-outline" onclick="document.getElementById('import-file').click()">üì• RESTAURER DONN√âES</button>
            <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importBackup(this)">
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" style="display:none;">
            <div class="chart-container">
                <div class="chart-title">üìà Interventions par type</div>
                <div id="chart-by-type"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üë• Interventions par technicien</div>
                <div id="chart-by-staff"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üìÖ √âvolution mensuelle</div>
                <div id="chart-by-month"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avg-duration">0h</div>
                    <div class="stat-label">Dur√©e moyenne</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="top-client">-</div>
                    <div class="stat-label">Top client</div>
                </div>
            </div>

            <button class="btn-outline" onclick="exportAnalyticsPDF()">üìä EXPORTER STATS PDF</button>
        </div>

        <!-- Calendar View -->
        <div id="view-calendar" style="display:none;">
            <div class="calendar" id="calendar-widget"></div>
            <button class="btn-gold" onclick="scheduleIntervention()">+ PLANIFIER INTERVENTION</button>
            <div id="scheduled-list" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- STEP 1: MISSION INFO -->
    <div class="step" id="step1">
        <div class="progress-bar">
            <div class="progress-step active">
                <div class="progress-dot">1</div>
                <div class="progress-label">Mission</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">2</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">3</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <h3 id="c-name" style="text-align:center; color:var(--gold);"></h3>
        
        <label>Charger un template</label>
        <button class="btn-outline" onclick="showTemplates()">üìã TEMPLATES DISPONIBLES</button>
        
        <label>Type de mission *</label>
        <div class="type-grid">
            <div class="type-chip" onclick="selectType(this, 'INSTALLATION')">INSTALLATION</div>
            <div class="type-chip" onclick="selectType(this, 'MAINTENANCE')">MAINTENANCE</div>
            <div class="type-chip" onclick="selectType(this, 'D√âPANNAGE')">D√âPANNAGE</div>
            <div class="type-chip" onclick="selectType(this, 'AUDIT')">AUDIT</div>
        </div>

        <label>√âquipe sur place *</label>
        <div class="staff-grid">
            <div class="staff-chip" onclick="toggleStaff(this)">Allan</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Pietro</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Marco</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Osvaldo</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Jean-Christophe</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <div>
                <label>Arriv√©e *</label>
                <input type="time" id="time_in">
                <button class="btn-now" onclick="setTime('time_in')">MAINTENANT</button>
            </div>
            <div>
                <label>D√©part</label>
                <input type="time" id="time_out">
                <button class="btn-now" onclick="setTime('time_out')">MAINTENANT</button>
            </div>
        </div>

        <div class="weather-widget" id="weather-widget" style="display:none;">
            <div class="weather-icon">üå§Ô∏è</div>
            <div class="weather-info">
                <div class="weather-temp">--¬∞C</div>
                <div class="weather-desc">Chargement...</div>
            </div>
        </div>

        <div id="gps-info" style="font-size:10px; color: var(--success); margin-top:10px;"></div>

        <button class="btn-gold" onclick="validateStep1()">SUIVANT : PHOTOS & RAPPORT</button>
        <button class="btn-outline" onclick="confirmCancel()">ANNULER</button>
    </div>

    <!-- STEP 2: PHOTOS & REPORT -->
    <div class="step" id="step2">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Mission</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">2</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">3</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos AVANT l'intervention</h4>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'before')" style="display:none;" id="cam-before">
            <button class="btn-outline" onclick="document.getElementById('cam-before').click()">+ AJOUTER AVANT</button>
            <div id="gallery-before" class="photo-gallery"></div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos PENDANT l'intervention</h4>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'during')" style="display:none;" id="cam-during">
            <button class="btn-outline" onclick="document.getElementById('cam-during').click()">+ AJOUTER PENDANT</button>
            <div id="gallery-during" class="photo-gallery"></div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos APR√àS l'intervention</h4>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'after')" style="display:none;" id="cam-after">
            <button class="btn-outline" onclick="document.getElementById('cam-after').click()">+ AJOUTER APR√àS</button>
            <div id="gallery-after" class="photo-gallery"></div>
        </div>

        <label>Compte-rendu des travaux *</label>
        <textarea id="task_done" rows="5" placeholder="Description technique d√©taill√©e de l'intervention..."></textarea>
        
        <div class="voice-recorder">
            <button class="btn-outline" onclick="toggleVoiceRecording()" id="voice-btn">üé§ NOTES VOCALES</button>
            <div id="voice-status" style="font-size:11px; color:#666; margin-top:5px;"></div>
        </div>
        
        <label>Points de vigilance / Mat√©riel</label>
        <textarea id="task_mat" rows="2" placeholder="SAV, mat√©riel install√©, recommandations..."></textarea>

        <label>Pi√®ces d√©tach√©es / R√©f√©rences</label>
        <textarea id="task_parts" rows="2" placeholder="R√©f√©rences mat√©riel, num√©ros de s√©rie..."></textarea>

        <button class="btn-gold" onclick="validateStep2()">SUIVANT : S√âCURIT√â & SIGNATURE</button>
        <button class="btn-outline" onclick="nextStep(1)">RETOUR</button>
    </div>

    <!-- STEP 3: CHECKLIST & SIGNATURE -->
    <div class="step" id="step3">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Mission</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">3</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <label>Checklist de fin de mission *</label>
        <div id="checklist-container"></div>

        <label style="margin-top:20px;">Signature client (tactile ou souris) *</label>
        <canvas id="sig-canvas"></canvas>
        <button class="btn-outline" onclick="clearSig()">EFFACER LA SIGNATURE</button>
        
        <div id="save-spinner" style="display:none;">
            <div class="spinner"></div>
            <p style="text-align:center; font-size:12px; color:#666;">Enregistrement en cours...</p>
        </div>
        
        <button class="btn-gold" id="btn-save" onclick="saveEntry()">‚úì ENREGISTRER FINAL</button>
        <button class="btn-outline" onclick="nextStep(2)">RETOUR</button>
    </div>

    <!-- STEP 4: VIEW PROJECT -->
    <div class="step" id="step4">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="view-n" style="color:var(--gold); margin:0; font-size:18px;"></h2>
            <div id="status-toggle-container"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="project-interventions">0</div>
                <div class="stat-label">Interventions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="project-hours">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
        </div>

        <div id="timeline" style="margin-top:20px;"></div>
        
        <div class="no-print">
            <button class="btn-outline" style="color:#2ecc71; border-color:#2ecc71;" onclick="sendProjectMail()">‚úâÔ∏è ENVOYER PAR MAIL</button>
            <button class="btn-outline" style="color:#3498db; border-color:#3498db;" onclick="shareWhatsApp()">üí¨ PARTAGER WHATSAPP</button>
            <button class="btn-gold" onclick="newIntervention()">+ NOUVELLE INTERVENTION</button>
            <button class="btn-outline" onclick="exportProjectPDF()">üñ®Ô∏è G√âN√âRER PDF D√âTAILL√â</button>
            <button class="btn-outline" onclick="duplicateLastIntervention()">üìã DUPLIQUER DERNI√àRE</button>
            <button class="btn-outline" onclick="nextStep(0)">RETOUR ACCUEIL</button>
            <button class="btn-danger" onclick="confirmDeleteProject()">‚ö†Ô∏è SUPPRIMER CE CLIENT</button>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Confirmation</div>
        <div class="modal-body" id="modalBody">√ätes-vous s√ªr ?</div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal()">Annuler</button>
            <button class="modal-btn confirm" id="modalConfirm" onclick="modalConfirmAction()">Confirmer</button>
        </div>
    </div>
</div>

<div class="modal" id="templatesModal">
    <div class="modal-content">
        <div class="modal-title">Choisir un template</div>
        <div id="templates-list"></div>
        <button class="btn-outline" onclick="closeModal('templatesModal')" style="margin-top:15px;">Fermer</button>
    </div>
</div>

<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close">‚úï FERMER</button>
    <img id="modalImage" src="" alt="">
</div>

<div class="install-prompt" id="installPrompt">
    üì± Installer Vertex Monaco sur votre appareil
    <button onclick="installPWA()">Installer</button>
    <button onclick="dismissInstall()" style="background:transparent; color:black; border:1px solid black;">Plus tard</button>
</div>

<!-- ========================================= -->
<!-- VERTEX MONACO V14 ULTRA - PARTIE 2       -->
<!-- JAVASCRIPT - √Ä INS√âRER AVANT </body>     -->
<!-- ========================================= -->

<script>
// ========== CONFIGURATION ==========
const CONFIG = {
    DB_NAME: 'VertexDB',
    DB_VERSION: 3,
    MAX_IMAGE_SIZE: 1200,
    IMAGE_QUALITY: 0.7,
    WEATHER_API_KEY: 'demo',
    ENABLE_CLOUD_SYNC: false,
    AUTO_SAVE_INTERVAL: 30000,
};

// ========== STATE ==========
let db = {};
let indexedDB_instance = null;
let cur = null;
let staff = [];
let photosBefore = [];
let photosDuring = [];
let photosAfter = [];
let selectedType = "";
let currentFilter = 'ongoing';
let currentView = 'list';
let gpsCoords = null;
let hasUnsavedChanges = false;
let modalCallback = null;
let isOnline = navigator.onLine;
let syncQueue = [];
let deferredPrompt = null;
let mediaRecorder = null;
let audioChunks = [];
let currentTheme = localStorage.getItem('vertex_theme') || 'dark';

// Templates
const TEMPLATES = {
    'installation_standard': {
        name: 'Installation Standard',
        type: 'INSTALLATION',
        checklist: ['Chantier nettoy√© / Propret√©', 'Tests de diffusion OK', 'Alimentation & Baie verrouill√©es', 'Client pr√©venu du d√©part', 'Documentation technique remise'],
        taskTemplate: 'Installation compl√®te du syst√®me audio/vid√©o comprenant :\n- Pose du mat√©riel\n- C√¢blage et raccordements\n- Configuration initiale\n- Tests de fonctionnement'
    },
    'maintenance_preventive': {
        name: 'Maintenance Pr√©ventive',
        type: 'MAINTENANCE',
        checklist: ['V√©rification c√¢blage', 'Nettoyage √©quipements', 'Tests syst√®mes', 'Mise √† jour firmware', 'Client pr√©venu du d√©part'],
        taskTemplate: 'Maintenance pr√©ventive incluant :\n- V√©rification √©tat g√©n√©ral\n- Nettoyage des connectiques\n- Tests de performance\n- Recommandations'
    },
    'depannage_urgent': {
        name: 'D√©pannage Urgent',
        type: 'D√âPANNAGE',
        checklist: ['Diagnostic effectu√©', 'Panne r√©solue', 'Tests OK', 'Client form√©', 'SAV planifi√© si n√©cessaire'],
        taskTemplate: 'Intervention de d√©pannage :\n- Diagnostic panne\n- R√©paration effectu√©e\n- Tests validation\n- Conseils client'
    }
};

// ========== INITIALIZATION ==========
window.addEventListener('load', async () => {
    await initIndexedDB();
    await loadFromIndexedDB();
    applyTheme(currentTheme);
    checkStorageSpace();
    requestGeolocation();
    setupBeforeUnload();
    setupNetworkListeners();
    loadList();
    updateStats();
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        setTimeout(() => {
            if (!localStorage.getItem('pwa_dismissed')) {
                document.getElementById('installPrompt').classList.add('active');
            }
        }, 5000);
    });
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
    
    setInterval(autoSave, CONFIG.AUTO_SAVE_INTERVAL);
    getWeather();
});

// ========== INDEXED DB ==========
async function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            indexedDB_instance = request.result;
            resolve();
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            if (!db.objectStoreNames.contains('projects')) {
                db.createObjectStore('projects', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('images')) {
                db.createObjectStore('images', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }
        };
    });
}

async function loadFromIndexedDB() {
    try {
        const transaction = indexedDB_instance.transaction(['projects'], 'readonly');
        const store = transaction.objectStore('projects');
        const request = store.getAll();
        
        request.onsuccess = () => {
            db = {};
            request.result.forEach(project => {
                db[project.id] = project.data;
            });
        };
    } catch (e) {
        console.error('IndexedDB error:', e);
        const stored = localStorage.getItem('vertex_v14_db');
        if (stored) db = JSON.parse(stored);
    }
}

async function saveToIndexedDB() {
    try {
        const transaction = indexedDB_instance.transaction(['projects'], 'readwrite');
        const store = transaction.objectStore('projects');
        
        await store.clear();
        
        for (const [id, data] of Object.entries(db)) {
            if (id !== '_version') {
                await store.put({ id, data });
            }
        }
        
        localStorage.setItem('vertex_v14_db', JSON.stringify(db));
    } catch (e) {
        console.error('Save error:', e);
        showToast('Erreur de sauvegarde', 'error');
    }
}

function autoSave() {
    if (hasUnsavedChanges) {
        saveToIndexedDB();
        showToast('Sauvegarde automatique', 'info');
    }
}

// ========== THEME ==========
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    applyTheme(currentTheme);
    localStorage.setItem('vertex_theme', currentTheme);
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
}

// ========== NETWORK ==========
function setupNetworkListeners() {
    window.addEventListener('online', () => {
        isOnline = true;
        document.getElementById('offlineIndicator').classList.remove('active');
        showToast('Connexion r√©tablie', 'success');
        syncOfflineData();
    });
    
    window.addEventListener('offline', () => {
        isOnline = false;
        document.getElementById('offlineIndicator').classList.add('active');
        showToast('Mode hors ligne activ√©', 'warning');
    });
    
    if (!isOnline) {
        document.getElementById('offlineIndicator').classList.add('active');
    }
}

function syncOfflineData() {
    if (syncQueue.length > 0 && CONFIG.ENABLE_CLOUD_SYNC) {
        document.getElementById('syncIndicator').classList.add('active');
        setTimeout(() => {
            syncQueue = [];
            document.getElementById('syncIndicator').classList.remove('active');
            showToast('Synchronisation termin√©e', 'success');
        }, 2000);
    }
}

// ========== TOAST ==========
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ========== MODAL ==========
function showModal(title, body, confirmText, callback, modalId = 'confirmModal') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').textContent = body;
    document.getElementById('modalConfirm').textContent = confirmText;
    modalCallback = callback;
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId = 'confirmModal') {
    document.getElementById(modalId).classList.remove('active');
    modalCallback = null;
}

function modalConfirmAction() {
    if (modalCallback) modalCallback();
    closeModal();
}

// ========== NAVIGATION ==========
function nextStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
    
    if (n === 3) {
        setTimeout(resizeCanvas, 200);
        loadChecklist();
    }
    if (n === 1) {
        document.getElementById('c-name').textContent = cur;
        resetForm();
        hasUnsavedChanges = true;
    }
    if (n === 4) {
        document.getElementById('view-n').textContent = cur;
        showTimeline();
        hasUnsavedChanges = false;
    }
    if (n === 0) {
        hasUnsavedChanges = false;
        switchTab(currentFilter);
    }
    
    window.scrollTo(0, 0);
}

function confirmCancel() {
    if (hasUnsavedChanges) {
        showModal(
            'Annuler la mission',
            'Les donn√©es non enregistr√©es seront perdues. Continuer ?',
            'Oui, annuler',
            () => nextStep(0)
        );
    } else {
        nextStep(0);
    }
}

function setupBeforeUnload() {
    window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });
}

function checkStorageSpace() {
    if (navigator.storage && navigator.storage.estimate) {
        navigator.storage.estimate().then(estimate => {
            const percentUsed = estimate.usage / estimate.quota;
            if (percentUsed > 0.8) {
                showToast(`Stockage √† ${Math.round(percentUsed * 100)}% - Pensez √† exporter !`, 'warning');
            }
        });
    }
}

// ========== TABS & VIEWS ==========
function switchTab(tab) {
    currentFilter = tab;
    currentView = tab;
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    if (tab === 'ongoing' || tab === 'done') {
        document.getElementById('tab-active').classList.toggle('active', tab === 'ongoing');
        document.getElementById('tab-archived').classList.toggle('active', tab === 'done');
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-analytics').style.display = 'none';
        document.getElementById('view-calendar').style.display = 'none';
        loadList();
    } else if (tab === 'analytics') {
        document.getElementById('tab-analytics').classList.add('active');
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-analytics').style.display = 'block';
        document.getElementById('view-calendar').style.display = 'none';
        loadAnalytics();
    } else if (tab === 'calendar') {
        document.getElementById('tab-calendar').classList.add('active');
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-analytics').style.display = 'none';
        document.getElementById('view-calendar').style.display = 'block';
        loadCalendar();
    }
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advancedFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// ========== STEP 1: MISSION INFO ==========
function setTime(id) {
    const n = new Date();
    document.getElementById(id).value = n.getHours().toString().padStart(2, '0') + ':' + n.getMinutes().toString().padStart(2, '0');
}

function selectType(el, type) {
    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedType = type;
}

function toggleStaff(el) {
    el.classList.toggle('selected');
    staff = Array.from(document.querySelectorAll('.staff-chip.selected')).map(c => c.textContent);
}

function requestGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                gpsCoords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                const gpsInfo = document.getElementById('gps-info');
                if (gpsInfo) {
                    gpsInfo.textContent = `üìç Position enregistr√©e (${gpsCoords.lat.toFixed(5)}, ${gpsCoords.lng.toFixed(5)})`;
                }
            },
            () => {}
        );
    }
}

function validateStep1() {
    if (!selectedType) {
        showToast('Veuillez s√©lectionner un type de mission', 'error');
        return;
    }
    if (staff.length === 0) {
        showToast('Veuillez s√©lectionner au moins un membre de l\'√©quipe', 'error');
        return;
    }
    if (!document.getElementById('time_in').value) {
        showToast('Veuillez indiquer l\'heure d\'arriv√©e', 'error');
        return;
    }
    nextStep(2);
}

// ========== TEMPLATES ==========
function showTemplates() {
    const list = document.getElementById('templates-list');
    list.innerHTML = '';
    
    Object.entries(TEMPLATES).forEach(([id, template]) => {
        list.innerHTML += `
            <div class="template-card" onclick="loadTemplate('${id}')">
                <h4>${template.name}</h4>
                <p>Type: ${template.type}</p>
            </div>
        `;
    });
    
    document.getElementById('templatesModal').classList.add('active');
}

function loadTemplate(id) {
    const template = TEMPLATES[id];
    
    selectedType = template.type;
    document.querySelectorAll('.type-chip').forEach(chip => {
        if (chip.textContent === template.type) {
            chip.classList.add('selected');
        } else {
            chip.classList.remove('selected');
        }
    });
    
    document.getElementById('task_done').value = template.taskTemplate;
    
    closeModal('templatesModal');
    showToast('Template charg√©', 'success');
}

function loadChecklist() {
    const container = document.getElementById('checklist-container');
    const template = Object.values(TEMPLATES).find(t => t.type === selectedType);
    const checklist = template ? template.checklist : ['Chantier nettoy√© / Propret√©', 'Tests de diffusion OK', 'Alimentation & Baie verrouill√©es', 'Client pr√©venu du d√©part'];
    
    container.innerHTML = '';
    checklist.forEach((item, i) => {
        container.innerHTML += `
            <div class="check-item">
                <input type="checkbox" id="check${i}">
                <span>${item}</span>
            </div>
        `;
    });
}

// ========== PROJECT MANAGEMENT ==========
function showNewProjectOptions() {
    const name = prompt('Nom du client :');
    if (!name) return;
    startNewProjectWithName(name);
}

function startNewProjectWithName(name) {
    if (db[name]) {
        showToast('Ce client existe d√©j√†', 'error');
        return;
    }
    
    db[name] = {
        entries: [],
        status: 'ongoing',
        created: new Date().toISOString()
    };
    
    saveToIndexedDB();
    loadList();
    showToast('Nouveau client cr√©√©', 'success');
}

// ========== WEATHER ==========
async function getWeather() {
    if (!gpsCoords) return;
    
    setTimeout(() => {
        const widget = document.getElementById('weather-widget');
        if (widget) {
            widget.style.display = 'flex';
            widget.querySelector('.weather-temp').textContent = '18¬∞C';
            widget.querySelector('.weather-desc').textContent = 'Partiellement nuageux';
        }
    }, 1000);
}

// ========== VOICE NOTES ==========
function toggleVoiceRecording() {
    const btn = document.getElementById('voice-btn');
    const status = document.getElementById('voice-status');
    
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    status.textContent = '‚úì Note vocale enregistr√©e';
                    btn.classList.remove('recording');
                };
                
                mediaRecorder.start();
                btn.classList.add('recording');
                btn.textContent = '‚èπÔ∏è ARR√äTER';
                status.textContent = 'üé§ Enregistrement en cours...';
            })
            .catch(() => {
                showToast('Microphone non disponible', 'error');
            });
    } else {
        mediaRecorder.stop();
        btn.textContent = 'üé§ NOTES VOCALES';
    }
}

// ========== PHOTOS ==========
let photosProcessed = 0;
let photosTotal = 0;

function handlePhotos(input, type) {
    const files = Array.from(input.files);
    photosTotal = files.length;
    photosProcessed = 0;
    
    files.forEach(file => {
        compressImage(file, (compressedDataUrl, originalSize, compressedSize) => {
            const imgObj = {
                src: compressedDataUrl,
                note: "",
                originalSize: originalSize,
                compressedSize: compressedSize,
                rotation: 0
            };
            
            if (type === 'before') {
                photosBefore.push(imgObj);
            } else if (type === 'during') {
                photosDuring.push(imgObj);
            } else {
                photosAfter.push(imgObj);
            }
            
            photosProcessed++;
            if (photosProcessed === photosTotal) {
                renderGalleries();
                showToast(`${photosTotal} photo(s) ajout√©e(s)`, 'success');
            }
        });
    });
    
    input.value = '';
}

function compressImage(file, callback) {
    const reader = new FileReader();
    const originalSize = file.size;
    
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > CONFIG.MAX_IMAGE_SIZE || height > CONFIG.MAX_IMAGE_SIZE) {
                if (width > height) {
                    height = Math.round((height * CONFIG.MAX_IMAGE_SIZE) / width);
                    width = CONFIG.MAX_IMAGE_SIZE;
                } else {
                    width = Math.round((width * CONFIG.MAX_IMAGE_SIZE) / height);
                    height = CONFIG.MAX_IMAGE_SIZE;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            ctx.font = '12px Inter';
            ctx.fillStyle = 'rgba(212, 175, 55, 0.7)';
            ctx.fillText(`Vertex Monaco - ${new Date().toLocaleDateString()}`, 10, height - 10);
            
            const compressedDataUrl = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
            const compressedSize = Math.round((compressedDataUrl.length * 3) / 4);
            
            callback(compressedDataUrl, originalSize, compressedSize);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function renderGalleries() {
    renderGallery('before', photosBefore);
    renderGallery('during', photosDuring);
    renderGallery('after', photosAfter);
}

function renderGallery(type, photos) {
    const container = document.getElementById(`gallery-${type}`);
    container.innerHTML = '';
    
    photos.forEach((p, i) => {
        const sizeInfo = `${(p.compressedSize / 1024).toFixed(1)} KB`;
        container.innerHTML += `
            <div class="photo-card">
                <img src="${escapeHtml(p.src)}" 
                     style="transform: rotate(${p.rotation}deg);"
                     onclick="openImageModal('${type}', ${i})">
                <div class="photo-size">üì¶ ${sizeInfo}</div>
                <input type="text" class="photo-input" placeholder="L√©gende..." 
                       oninput="photos${type.charAt(0).toUpperCase() + type.slice(1)}[${i}].note=this.value" 
                       value="${escapeHtml(p.note)}">
                <div class="photo-controls">
                    <button onclick="rotatePhoto('${type}', ${i})">üîÑ Rotation</button>
                    <button onclick="removePhoto('${type}', ${i})">üóëÔ∏è Suppr.</button>
                </div>
            </div>
        `;
    });
}

function rotatePhoto(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    photoArray[index].rotation = (photoArray[index].rotation + 90) % 360;
    renderGalleries();
}

function removePhoto(type, index) {
    if (type === 'before') photosBefore.splice(index, 1);
    else if (type === 'during') photosDuring.splice(index, 1);
    else photosAfter.splice(index, 1);
    renderGalleries();
    showToast('Photo supprim√©e', 'success');
}

function openImageModal(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    document.getElementById('modalImage').src = photoArray[index].src;
    document.getElementById('imageModal').classList.add('active');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

function validateStep2() {
    const taskDone = document.getElementById('task_done').value.trim();
    if (!taskDone) {
        showToast('Veuillez remplir le compte-rendu des travaux', 'error');
        return;
    }
    nextStep(3);
}

// ========== SIGNATURE ==========
const canvas = document.getElementById('sig-canvas');
const ctx = canvas.getContext('2d');
let drawing = false;

function resizeCanvas() {
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    tempCtx.drawImage(canvas, 0, 0);
    
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    
    ctx.drawImage(tempCanvas, 0, 0);
}

function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
}

function startDrawing(e) {
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    e.preventDefault();
}

function draw(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    e.preventDefault();
}

function stopDrawing() {
    drawing = false;
}

canvas.addEventListener('touchstart', startDrawing, { passive: false });
canvas.addEventListener('touchmove', draw, { passive: false });
canvas.addEventListener('touchend', stopDrawing);
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseleave', stopDrawing);

function clearSig() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    showToast('Signature effac√©e', 'success');
}

function isCanvasBlank(canvas) {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
}

// ========== SAVE ENTRY ==========
function saveEntry() {
    if (!selectedType || !staff.length) {
        showToast('Type et √âquipe requis !', 'error');
        return;
    }
    
    const checks = Array.from(document.querySelectorAll('#checklist-container input[type="checkbox"]'));
    if (!checks.every(c => c.checked)) {
        showToast('Veuillez valider tous les points de la checklist', 'error');
        return;
    }
    
    if (isCanvasBlank(canvas)) {
        showToast('Veuillez faire signer le client', 'error');
        return;
    }
    
    document.getElementById('save-spinner').style.display = 'block';
    document.getElementById('btn-save').disabled = true;
    
    setTimeout(async () => {
        try {
            const entry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('fr-FR'),
                timestamp: new Date().toISOString(),
                type: selectedType,
                in: document.getElementById('time_in').value,
                out: document.getElementById('time_out').value,
                staff: staff.join(', '),
                done: document.getElementById('task_done').value,
                mat: document.getElementById('task_mat').value,
                parts: document.getElementById('task_parts').value,
                before: [...photosBefore],
                during: [...photosDuring],
                after: [...photosAfter],
                sig: canvas.toDataURL('image/png', 0.5),
                gps: gpsCoords ? { lat: gpsCoords.lat, lng: gpsCoords.lng } : null
            };
            
            db[cur].entries.push(entry);
            await saveToIndexedDB();
            
            document.getElementById('save-spinner').style.display = 'none';
            document.getElementById('btn-save').disabled = false;
            
            showToast('‚úì Mission enregistr√©e avec succ√®s', 'success');
            nextStep(4);
        } catch (e) {
            document.getElementById('save-spinner').style.display = 'none';
            document.getElementById('btn-save').disabled = false;
            showToast('Erreur lors de l\'enregistrement', 'error');
        }
    }, 500);
}

// ========== PROJECT VIEW ==========
function showTimeline() {
    const t = document.getElementById('timeline');
    t.innerHTML = '';
    
    const isDone = db[cur].status === 'done';
    document.getElementById('status-toggle-container').innerHTML = `
        <button class="status-pill ${isDone ? 'status-done' : 'status-ongoing'}" 
                onclick="toggleStatus()">
            ${isDone ? 'üì¶ ARCHIV√â' : '‚úì ACTIF'}
        </button>
    `;
    
    const entries = db[cur].entries;
    document.getElementById('project-interventions').textContent = entries.length;
    
    let totalMinutes = 0;
    entries.forEach(e => {
        if (e.in && e.out) {
            const [inH, inM] = e.in.split(':').map(Number);
            const [outH, outM] = e.out.split(':').map(Number);
            const minutes = (outH * 60 + outM) - (inH * 60 + inM);
            if (minutes > 0) totalMinutes += minutes;
        }
    });
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('project-hours').textContent = `${hours}h${minutes > 0 ? minutes : ''}`;
    
    [...entries].reverse().forEach(e => {
        const gpsInfo = e.gps ? `üìç ${e.gps.lat.toFixed(5)}, ${e.gps.lng.toFixed(5)}` : '';
        
        t.innerHTML += `
            <div class="timeline-item">
                <div style="font-size:10px; font-weight:900; color:var(--gold); margin-bottom:5px;">
                    ${escapeHtml(e.date)} | ${escapeHtml(e.type)}
                </div>
                <div class="section-block">
                    <strong>√âquipe:</strong> ${escapeHtml(e.staff)} (${escapeHtml(e.in)} - ${escapeHtml(e.out)})
                    ${gpsInfo ? `<br><span style="font-size:9px; color:#888;">${gpsInfo}</span>` : ''}
                    <br><strong>Travaux:</strong> ${escapeHtml(e.done)}
                </div>
                ${e.mat ? `<div class="section-block" style="border-left-color:var(--success)">
                    <strong>Mat√©riel/SAV:</strong> ${escapeHtml(e.mat)}
                </div>` : ''}
                ${e.parts ? `<div class="section-block" style="border-left-color:var(--info)">
                    <strong>Pi√®ces:</strong> ${escapeHtml(e.parts)}
                </div>` : ''}
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin:10px 0;">
                    <div>
                        ${e.before.map(p => renderPhotoInTimeline(p, '#e67e22')).join('')}
                    </div>
                    <div>
                        ${(e.during || []).map(p => renderPhotoInTimeline(p, '#3498db')).join('')}
                    </div>
                    <div>
                        ${e.after.map(p => renderPhotoInTimeline(p, '#2ecc71')).join('')}
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:10px;">
                    <img src="${escapeHtml(e.sig)}" 
                         style="width:120px; background:white; border-radius:4px; padding:3px; border:1px solid #ddd;">
                    <button class="no-print" 
                            style="color:var(--danger); border:none; background:none; font-size:10px; cursor:pointer; padding:5px;" 
                            onclick="confirmDeleteEntry(${e.id})">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        `;
    });
}

function renderPhotoInTimeline(photo, borderColor) {
    return `
        <img src="${escapeHtml(photo.src)}" 
             style="width:100%; border:2px solid ${borderColor}; border-radius:4px; margin-bottom:5px; transform: rotate(${photo.rotation || 0}deg);">
        ${photo.note ? `<div style="font-size:9px; color:#888; margin-bottom:10px;">${escapeHtml(photo.note)}</div>` : ''}
    `;
}

function confirmDeleteEntry(id) {
    showModal(
        'Supprimer l\'intervention',
        'Cette action est irr√©versible. Continuer ?',
        'Supprimer',
        () => deleteEntry(id)
    );
}

function deleteEntry(id) {
    db[cur].entries = db[cur].entries.filter(e => e.id !== id);
    saveToIndexedDB();
    showTimeline();
    showToast('Intervention supprim√©e', 'success');
}

function newIntervention() {
    nextStep(1);
}

function duplicateLastIntervention() {
    const last = db[cur].entries[db[cur].entries.length - 1];
    if (!last) return;
    
    selectedType = last.type;
    staff = last.staff.split(', ');
    document.getElementById('task_done').value = last.done;
    document.getElementById('task_mat').value = last.mat || '';
    
    document.querySelectorAll('.type-chip').forEach(chip => {
        if (chip.textContent === last.type) {
            chip.classList.add('selected');
        }
    });
    
    document.querySelectorAll('.staff-chip').forEach(chip => {
        if (staff.includes(chip.textContent)) {
            chip.classList.add('selected');
        }
    });
    
    nextStep(1);
    showToast('Derni√®re intervention dupliqu√©e', 'success');
}

function toggleStatus() {
    db[cur].status = (db[cur].status === 'done' ? 'ongoing' : 'done');
    saveToIndexedDB();
    showTimeline();
    loadList();
    showToast(`Client ${db[cur].status === 'done' ? 'archiv√©' : 'r√©activ√©'}`, 'success');
}

function confirmDeleteProject() {
    showModal(
        'Supprimer le client',
        `Toutes les interventions pour "${cur}" seront d√©finitivement supprim√©es. Cette action est irr√©versible.`,
        'Supprimer d√©finitivement',
        deleteFullProject
    );
}

function deleteFullProject() {
    delete db[cur];
    saveToIndexedDB();
    showToast('Client supprim√©', 'success');
    nextStep(0);
}

// ========== LIST & FILTERS ==========
function filterProjects() {
    const query = document.getElementById('searchBar').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const filterStaff = document.getElementById('filterStaff').value;
    const filterDateFrom = document.getElementById('filterDateFrom').value;
    const filterDateTo = document.getElementById('filterDateTo').value;
    
    loadList(query, filterType, filterStaff, filterDateFrom, filterDateTo);
}

function loadList(query = '', filterType = '', filterStaff = '', dateFrom = '', dateTo = '') {
    const list = document.getElementById('project-list');
    list.innerHTML = '';
    
    const projects = Object.keys(db)
        .filter(key => key !== '_version')
        .sort();
    
    projects.forEach(id => {
        const project = db[id];
        
        if (project.status !== currentFilter) return;
        if (query && !id.toLowerCase().includes(query)) return;
        
        if (filterType || filterStaff || dateFrom || dateTo) {
            const matchesFilters = project.entries.some(e => {
                const typeMatch = !filterType || e.type === filterType;
                const staffMatch = !filterStaff || e.staff.includes(filterStaff);
                
                let dateMatch = true;
                if (dateFrom || dateTo) {
                    const entryDate = new Date(e.timestamp || e.date);
                    if (dateFrom) dateMatch = dateMatch && entryDate >= new Date(dateFrom);
                    if (dateTo) dateMatch = dateMatch && entryDate <= new Date(dateTo);
                }
                
                return typeMatch && staffMatch && dateMatch;
            });
            
            if (!matchesFilters) return;
        }
        
        const lastEntry = project.entries[project.entries.length - 1];
        const lastDate = lastEntry ? lastEntry.date : 'Aucune intervention';
        const entryCount = project.entries.length;
        
        list.innerHTML += `
            <div class="folder-card" onclick="cur='${escapeHtml(id)}';nextStep(4);">
                <div class="folder-info">
                    <div class="folder-name">${escapeHtml(id)}</div>
                    <div class="folder-meta">
                        ${entryCount} intervention${entryCount > 1 ? 's' : ''} ‚Ä¢ Derni√®re: ${escapeHtml(lastDate)}
                    </div>
                </div>
                <div class="folder-arrow">‚ùØ</div>
            </div>
        `;
    });
    
    if (list.innerHTML === '') {
        list.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0;">Aucun dossier trouv√©</p>';
    }
}

// ========== STATS ==========
function updateStats() {
    let activeCount = 0;
    let totalInterventions = 0;
    let totalMinutes = 0;
    let thisMonth = 0;
    
    const now = new Date();
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    Object.keys(db).forEach(key => {
        if (key === '_version') return;
        const project = db[key];
        
        if (project.status === 'ongoing') activeCount++;
        totalInterventions += project.entries.length;
        
        project.entries.forEach(e => {
            if (e.in && e.out) {
                const [inH, inM] = e.in.split(':').map(Number);
                const [outH, outM] = e.out.split(':').map(Number);
                const minutes = (outH * 60 + outM) - (inH * 60 + inM);
                if (minutes > 0) totalMinutes += minutes;
            }
            
            const entryDate = new Date(e.timestamp || e.date);
            if (entryDate >= thisMonthStart) thisMonth++;
        });
    });
    
    document.getElementById('stat-active').textContent = activeCount;
    document.getElementById('stat-total').textContent = totalInterventions;
    
    const hours = Math.floor(totalMinutes / 60);
    document.getElementById('stat-hours').textContent = `${hours}h`;
    document.getElementById('stat-month').textContent = thisMonth;
}

// ========== ANALYTICS ==========
function loadAnalytics() {
    const typeCount = {};
    const staffCount = {};
    const monthCount = {};
    let totalDuration = 0;
    let entryCount = 0;
    const clientCount = {};
    
    Object.keys(db).forEach(key => {
        if (key === '_version') return;
        
        db[key].entries.forEach(e => {
            typeCount[e.type] = (typeCount[e.type] || 0) + 1;
            
            e.staff.split(', ').forEach(s => {
                staffCount[s] = (staffCount[s] || 0) + 1;
            });
            
            const month = new Date(e.timestamp || e.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' });
            monthCount[month] = (monthCount[month] || 0) + 1;
            
            if (e.in && e.out) {
                const [inH, inM] = e.in.split(':').map(Number);
                const [outH, outM] = e.out.split(':').map(Number);
                const minutes = (outH * 60 + outM) - (inH * 60 + inM);
                if (minutes > 0) {
                    totalDuration += minutes;
                    entryCount++;
                }
            }
            
            clientCount[key] = (clientCount[key] || 0) + 1;
        });
    });
    
    renderChart('chart-by-type', typeCount);
    renderChart('chart-by-staff', staffCount);
    renderChart('chart-by-month', monthCount);
    
    const avgMinutes = entryCount > 0 ? Math.round(totalDuration / entryCount) : 0;
    const avgHours = Math.floor(avgMinutes / 60);
    const avgMins = avgMinutes % 60;
    document.getElementById('avg-duration').textContent = `${avgHours}h${avgMins > 0 ? avgMins : ''}`;
    
    const topClient = Object.entries(clientCount).sort((a, b) => b[1] - a[1])[0];
    document.getElementById('top-client').textContent = topClient ? topClient[0].substring(0, 15) : '-';
}

function renderChart(containerId, data) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    const max = Math.max(...Object.values(data));
    
    Object.entries(data)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .forEach(([label, value]) => {
            const percent = (value / max) * 100;
            container.innerHTML += `
                <div class="chart-bar-label">${escapeHtml(label)}</div>
                <div class="chart-bar">
                    <div class="chart-bar-fill" style="width: ${percent}%;">
                        ${value}
                    </div>
                </div>
            `;
        });
}

// ========== CALENDAR ==========
function loadCalendar() {
    const calendar = document.getElementById('calendar-widget');
    const now = new Date();
    
    calendar.innerHTML = `
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">‚óÄ</button>
            <span style="font-weight:bold;">${now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</span>
            <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>
        <div class="calendar-grid" id="calendar-days"></div>
    `;
    
    renderCalendarDays(now);
}

function renderCalendarDays(date) {
    const grid = document.getElementById('calendar-days');
    if (!grid) return;
    grid.innerHTML = '';
    
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    ['L', 'M', 'M', 'J', 'V', 'S', 'D'].forEach(d => {
        grid.innerHTML += `<div style="font-weight:bold; font-size:10px; text-align:center;">${d}</div>`;
    });
    
    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += '<div></div>';
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
        const classes = isToday ? 'calendar-day today' : 'calendar-day';
        grid.innerHTML += `<div class="${classes}">${day}</div>`;
    }
}

function changeMonth(delta) {
    showToast('Navigation calendrier √† venir', 'info');
}

function scheduleIntervention() {
    showToast('Planification √† venir', 'info');
}

// ========== EXPORT ==========
function exportToCSV() {
    let csv = '\uFEFFClient;Date;Type;Equipe;Arrivee;Depart;Travaux;Materiel;Pieces;GPS\n';
    
    Object.keys(db).forEach(client => {
        if (client === '_version') return;
        
        db[client].entries.forEach(e => {
            const gps = e.gps ? `${e.gps.lat},${e.gps.lng}` : '';
            csv += `"${escapeCSV(client)}";`;
            csv += `"${escapeCSV(e.date)}";`;
            csv += `"${escapeCSV(e.type)}";`;
            csv += `"${escapeCSV(e.staff)}";`;
            csv += `"${escapeCSV(e.in)}";`;
            csv += `"${escapeCSV(e.out)}";`;
            csv += `"${escapeCSV(e.done)}";`;
            csv += `"${escapeCSV(e.mat)}";`;
            csv += `"${escapeCSV(e.parts || '')}";`;
            csv += `"${escapeCSV(gps)}"\n`;
        });
    });
    
    downloadFile(csv, `Vertex_Export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
    showToast('Export CSV g√©n√©r√©', 'success');
}

function exportBackup() {
    const backup = {
        version: CONFIG.DB_VERSION,
        exportDate: new Date().toISOString(),
        data: db
    };
    
    const json = JSON.stringify(backup, null, 2);
    downloadFile(json, `Vertex_Backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    showToast('Sauvegarde compl√®te g√©n√©r√©e', 'success');
}

function importBackup(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.data || !backup.version) {
                throw new Error('Format invalide');
            }
            
            showModal(
                'Restaurer les donn√©es',
                'Cette action remplacera toutes les donn√©es actuelles. Continuer ?',
                'Restaurer',
                () => {
                    db = backup.data;
                    saveToIndexedDB();
                    loadList();
                    updateStats();
                    showToast('Donn√©es restaur√©es avec succ√®s', 'success');
                }
            );
        } catch (err) {
            showToast('Erreur: fichier invalide', 'error');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function exportProjectPDF() {
    showToast('G√©n√©ration PDF...', 'info');
    setTimeout(() => window.print(), 500);
}

function exportPDFReport() {
    showToast('Rapport PDF global en cours...', 'info');
    setTimeout(() => window.print(), 500);
}

function exportAnalyticsPDF() {
    showToast('Export statistiques PDF...', 'info');
    setTimeout(() => window.print(), 500);
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename);
    link.click();
}

// ========== SHARING ==========
function sendProjectMail() {
    const entries = db[cur].entries;
    if (!entries.length) return;
    
    const lastEntry = entries[entries.length - 1];
    
    const subject = encodeURIComponent(`Rapport Vertex - ${cur} - ${lastEntry.date}`);
    let body = `CLIENT: ${cur}\n\n`;
    body += `TYPE: ${lastEntry.type}\n`;
    body += `DATE: ${lastEntry.date}\n`;
    body += `√âQUIPE: ${lastEntry.staff}\n`;
    body += `HORAIRES: ${lastEntry.in} - ${lastEntry.out}\n\n`;
    body += `TRAVAUX R√âALIS√âS:\n${lastEntry.done}\n\n`;
    if (lastEntry.mat) body += `MAT√âRIEL/SAV:\n${lastEntry.mat}\n\n`;
    if (lastEntry.parts) body += `PI√àCES:\n${lastEntry.parts}\n\n`;
    if (lastEntry.gps) body += `POSITION GPS: ${lastEntry.gps.lat}, ${lastEntry.gps.lng}\n`;
    body += `\n--- Rapport g√©n√©r√© par Vertex Monaco V14 Ultra ---`;
    
    window.location.href = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
}

function shareWhatsApp() {
    const entries = db[cur].entries;
    if (!entries.length) return;
    
    const lastEntry = entries[entries.length - 1];
    let text = `*Rapport Vertex - ${cur}*\n\n`;
    text += `üìÖ ${lastEntry.date}\n`;
    text += `üîß ${lastEntry.type}\n`;
    text += `üë• ${lastEntry.staff}\n`;
    text += `‚è∞ ${lastEntry.in} - ${lastEntry.out}\n\n`;
    text += `*Travaux:*\n${lastEntry.done}`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

// ========== UTILITIES ==========
function resetForm() {
    staff = [];
    photosBefore = [];
    photosDuring = [];
    photosAfter = [];
    selectedType = '';
    
    document.querySelectorAll('.type-chip, .staff-chip').forEach(c => c.classList.remove('selected'));
    document.getElementById('task_done').value = '';
    document.getElementById('task_mat').value = '';
    document.getElementById('task_parts').value = '';
    document.getElementById('time_in').value = '';
    document.getElementById('time_out').value = '';
    
    renderGalleries();
    clearSig();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeCSV(text) {
    if (!text) return '';
    return text.replace(/"/g, '""');
}

// ========== PWA ==========
function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult => {
            if (choiceResult.outcome === 'accepted') {
                showToast('Application install√©e !', 'success');
            }
            deferredPrompt = null;
            document.getElementById('installPrompt').classList.remove('active');
        });
    }
}

function dismissInstall() {
    document.getElementById('installPrompt').classList.remove('active');
    localStorage.setItem('pwa_dismissed', 'true');
}

window.onresize = () => {
    if (document.getElementById('step3').classList.contains('active')) {
        resizeCanvas();
    }
};
</script>

</body>
</html>
