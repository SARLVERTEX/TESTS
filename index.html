<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D4AF37">
    <title>VERTEX MONACO | V5.0 DELUXE ‚ú®</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Darker+Grotesque:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #D4AF37; 
            --gold-glow: rgba(212, 175, 55, 0.3);
            --bg: #000; 
            --card: #121212; 
            --text: #fff; 
            --success: #2ecc71; 
            --danger: #ff4d4d; 
            --warning: #f39c12;
            --info: #3498db;
            --purple: #9b59b6;
            --pink: #e91e63;
            --border: #282828;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Darker Grotesque', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* ========== SATISFYING ANIMATIONS ========== */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--gold-glow); }
            50% { box-shadow: 0 0 40px var(--gold-glow), 0 0 60px var(--gold-glow); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        /* ========== CONTAINER ========== */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            padding-bottom: 100px; 
        }
        
        /* ========== HEADER ========== */
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 3px solid var(--gold);
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
            animation: slideUp 0.6s ease;
        }
        
        .header h1 {
            letter-spacing: 8px;
            font-size: 24px;
            color: var(--gold);
            font-weight: 900;
            text-shadow: 0 0 20px var(--gold-glow);
            animation: glow 3s infinite;
        }
        
        .header-subtitle {
            font-size: 11px;
            color: var(--gold);
            letter-spacing: 3px;
            margin-top: 8px;
            opacity: 0.9;
            animation: float 3s ease-in-out infinite;
        }
        
        /* ========== NAVIGATION ========== */
        .main-nav {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .nav-card {
            background: var(--card);
            border: 3px solid var(--border);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease;
            animation-fill-mode: backwards;
        }
        
        .nav-card:nth-child(1) { animation-delay: 0.1s; }
        .nav-card:nth-child(2) { animation-delay: 0.2s; }
        .nav-card:nth-child(3) { animation-delay: 0.3s; }
        .nav-card:nth-child(4) { animation-delay: 0.4s; }
        
        .nav-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(212, 175, 55, 0.1),
                transparent
            );
            transform: rotate(45deg);
            transition: all 0.6s;
        }
        
        .nav-card:hover::before {
            left: 100%;
        }
        
        .nav-card:hover {
            border-color: var(--gold);
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px var(--gold-glow);
        }
        
        .nav-card:active {
            transform: translateY(-8px) scale(0.98);
            animation: pop 0.3s ease;
        }
        
        .nav-icon { 
            font-size: 48px; 
            margin-bottom: 10px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        .nav-title { 
            font-size: 18px; 
            font-weight: 900; 
            color: var(--gold); 
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .nav-subtitle { font-size: 12px; color: #888; }
        
        /* ========== BUTTONS ========== */
        .btn-gold {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--gold) 0%, #B8941F 100%);
            color: black;
            border: none;
            font-weight: 900;
            border-radius: 12px;
            text-transform: uppercase;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--gold-glow);
        }
        
        .btn-gold::before {
            content: '‚ú®';
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .btn-gold:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--gold-glow);
        }
        
        .btn-gold:hover::before {
            left: 20px;
            opacity: 1;
        }
        
        .btn-gold:active {
            transform: translateY(-3px) scale(0.98);
            animation: pop 0.3s ease;
        }
        
        .btn-outline {
            width: 100%;
            padding: 14px 20px;
            background: transparent;
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .btn-outline:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-outline:active {
            animation: pop 0.2s ease;
        }
        
        /* ========== PHOTO ANNOTATION EDITOR ========== */
        .annotation-editor {
            background: var(--card);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            animation: slideUp 0.4s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .annotation-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .tool-btn {
            padding: 12px 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        
        .tool-btn:hover {
            transform: translateY(-3px) scale(1.05);
            border-color: var(--gold);
            box-shadow: 0 5px 20px var(--gold-glow);
        }
        
        .tool-btn.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
            animation: pop 0.3s ease;
            box-shadow: 0 0 30px var(--gold-glow);
        }
        
        .tool-btn:active {
            transform: translateY(-3px) scale(0.95);
        }
        
        .color-picker {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        
        .color-btn:hover {
            transform: scale(1.2) rotate(10deg);
            box-shadow: 0 5px 20px currentColor;
        }
        
        .color-btn.active {
            border-color: white;
            transform: scale(1.3);
            animation: pop 0.3s ease;
            box-shadow: 0 0 30px currentColor;
        }
        
        .color-btn:active {
            animation: pop 0.2s ease;
        }
        
        .canvas-container {
            position: relative;
            border: 3px solid var(--gold);
            border-radius: 12px;
            overflow: hidden;
            background: #1a1a1a;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: glow 3s infinite;
        }
        
        #annotationCanvas {
            display: block;
            width: 100%;
            cursor: crosshair;
            touch-action: none;
        }
        
        .measure-input-overlay {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        
        .measure-input-overlay input {
            width: 200px;
            padding: 10px;
            background: var(--card);
            border: 2px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
        }
        
        .measure-input-overlay input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold-glow);
            animation: pop 0.3s ease;
        }
        
        .measure-input-overlay button {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--gold);
            color: black;
            border: none;
            border-radius: 8px;
            font-weight: 900;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .measure-input-overlay button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px var(--gold-glow);
        }
        
        .measure-input-overlay button:active {
            animation: pop 0.2s ease;
        }
        
        /* ========== ANNOTATIONS LIST ========== */
        .annotations-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .annotation-item {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: slideUp 0.3s ease;
        }
        
        .annotation-item:hover {
            border-color: var(--gold);
            transform: translateX(5px);
            box-shadow: 0 5px 20px var(--gold-glow);
        }
        
        .annotation-info {
            flex: 1;
            font-size: 14px;
            font-weight: 700;
        }
        
        .annotation-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 900;
            transition: all 0.3s;
        }
        
        .annotation-delete:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 20px rgba(255, 77, 77, 0.5);
        }
        
        .annotation-delete:active {
            animation: pop 0.2s ease;
        }
        
        /* ========== CARDS ========== */
        .card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: slideUp 0.4s ease;
            animation-fill-mode: backwards;
        }
        
        .card:hover {
            border-color: var(--gold);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px var(--gold-glow);
        }
        
        .card:active {
            transform: translateY(-5px) scale(0.98);
            animation: pop 0.2s ease;
        }
        
        /* ========== TOAST NOTIFICATIONS ========== */
        .toast {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            z-index: 9999;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast::before {
            content: '‚ú®';
            font-size: 20px;
            animation: bounce 1s ease-in-out infinite;
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        
        /* ========== CONFETTI ========== */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--gold);
            pointer-events: none;
            z-index: 10000;
            animation: confetti 2s ease-out forwards;
        }
        
        /* ========== PROGRESS BAR ========== */
        .progress-container {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, var(--info) 100%);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: shimmer 2s infinite;
            background-size: 200% 100%;
        }
        
        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--card);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 100px var(--gold-glow);
        }
        
        /* ========== FORMS ========== */
        label {
            display: block;
            margin: 20px 0 8px 0;
            font-size: 12px;
            font-weight: 900;
            color: var(--gold);
            text-transform: uppercase;
            animation: float 3s ease-in-out infinite;
        }
        
        input:not([type="checkbox"]):not([type="file"]):not([type="color"]),
        textarea,
        select {
            width: 100%;
            padding: 14px;
            background: var(--card);
            border: 2px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Darker Grotesque', sans-serif;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 30px var(--gold-glow);
            transform: scale(1.02);
            animation: pop 0.3s ease;
        }
        
        /* ========== STEP SYSTEM ========== */
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
            animation: slideUp 0.4s ease;
        }
        
        /* ========== UTILITIES ========== */
        .hidden { display: none !important; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold);
            box-shadow: 0 0 20px var(--gold-glow);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>VERTEX MONACO</h1>
        <p class="header-subtitle">V5.0 DELUXE ‚ú® √âDITION SATISFAISANTE</p>
    </div>

    <!-- STEP 0: MAIN MENU -->
    <div class="step active" id="step0">
        <div class="main-nav">
            <div class="nav-card" onclick="goTo(1)">
                <div class="nav-icon">üè¢</div>
                <div class="nav-title">PROJETS</div>
                <div class="nav-subtitle">Clients & Interventions</div>
            </div>
            
            <div class="nav-card" onclick="goTo(2)">
                <div class="nav-icon">üì¶</div>
                <div class="nav-title">STOCK</div>
                <div class="nav-subtitle">Inventaire</div>
            </div>
            
            <div class="nav-card" onclick="goTo(5)">
                <div class="nav-icon">üìê</div>
                <div class="nav-title">MESURES</div>
                <div class="nav-subtitle">√âtats des lieux</div>
            </div>
            
            <div class="nav-card" onclick="goTo(10)">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-title">R√âGLAGES</div>
                <div class="nav-subtitle">Param√®tres</div>
            </div>
        </div>
    </div>

    <!-- STEP 5: PHOTO MEASUREMENTS -->
    <div class="step" id="step5">
        <h2 style="color:var(--gold); margin-bottom:20px; animation: float 3s ease-in-out infinite;">
            üìê √âtats des Lieux & Mesures
        </h2>
        
        <label>üì∏ Importer une photo</label>
        <input type="file" id="measurePhoto" accept="image/*" capture="environment" onchange="loadPhotoForMeasure(this)">
        
        <div id="photoEditorContainer" class="hidden">
            <div class="annotation-editor">
                <div class="annotation-toolbar">
                    <button class="tool-btn" onclick="selectTool('arrow')" data-tool="arrow">‚û°Ô∏è</button>
                    <button class="tool-btn" onclick="selectTool('line')" data-tool="line">üìè</button>
                    <button class="tool-btn" onclick="selectTool('measure')" data-tool="measure">üìê</button>
                    <button class="tool-btn" onclick="selectTool('rect')" data-tool="rect">‚¨ú</button>
                    <button class="tool-btn" onclick="selectTool('circle')" data-tool="circle">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('text')" data-tool="text">üìù</button>
                </div>
                
                <div class="color-picker">
                    <div class="color-btn" style="background: #D4AF37;" onclick="selectColor('#D4AF37')"></div>
                    <div class="color-btn" style="background: #ff4d4d;" onclick="selectColor('#ff4d4d')"></div>
                    <div class="color-btn" style="background: #2ecc71;" onclick="selectColor('#2ecc71')"></div>
                    <div class="color-btn" style="background: #3498db;" onclick="selectColor('#3498db')"></div>
                    <div class="color-btn" style="background: #f39c12;" onclick="selectColor('#f39c12')"></div>
                    <div class="color-btn" style="background: #9b59b6;" onclick="selectColor('#9b59b6')"></div>
                    <div class="color-btn" style="background: #e91e63;" onclick="selectColor('#e91e63')"></div>
                    <div class="color-btn" style="background: #ffffff;" onclick="selectColor('#ffffff')"></div>
                </div>
                
                <div class="canvas-container">
                    <canvas id="annotationCanvas"></canvas>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-outline" onclick="undoAnnotation()">‚Ü©Ô∏è ANNULER</button>
                    <button class="btn-outline" onclick="clearAnnotations()">üóëÔ∏è EFFACER TOUT</button>
                </div>
                
                <div class="annotations-list" id="annotationsList"></div>
                
                <button class="btn-gold" onclick="saveAnnotatedPhoto()">‚úÖ ENREGISTRER PHOTO</button>
            </div>
        </div>
        
        <div id="savedMeasures"></div>
        
        <button class="btn-outline" onclick="goTo(0)">‚Üê RETOUR</button>
    </div>

    <!-- Other steps (1, 2, 10) - simplified placeholders -->
    <div class="step" id="step1">
        <h2 style="color:var(--gold); margin-bottom:20px;">üè¢ Projets</h2>
        <p style="text-align:center; color:#666; padding:40px 0;">Module projets √† venir...</p>
        <button class="btn-outline" onclick="goTo(0)">‚Üê RETOUR</button>
    </div>
    
    <div class="step" id="step2">
        <h2 style="color:var(--gold); margin-bottom:20px;">üì¶ Stock</h2>
        <p style="text-align:center; color:#666; padding:40px 0;">Module stock √† venir...</p>
        <button class="btn-outline" onclick="goTo(0)">‚Üê RETOUR</button>
    </div>
    
    <div class="step" id="step10">
        <h2 style="color:var(--gold); margin-bottom:20px;">‚öôÔ∏è R√©glages</h2>
        <button class="btn-outline" onclick="exportData()">üíæ SAUVEGARDER</button>
        <button class="btn-outline" onclick="goTo(0)">‚Üê RETOUR</button>
    </div>
</div>

<script>
// ========== CONFIG ==========
const CONFIG = {
    DB_NAME: 'VertexDB_V5',
    VERSION: 5
};

// ========== STATE ==========
let db = {
    measures: []
};

let canvas, ctx;
let currentTool = 'arrow';
let currentColor = '#D4AF37';
let isDrawing = false;
let startX, startY;
let annotations = [];
let tempAnnotation = null;
let baseImage = null;
let measureInputActive = false;

// ========== INIT ==========
window.addEventListener('load', () => {
    loadData();
    console.log('‚ú® Vertex V5.0 Deluxe charg√©');
});

function loadData() {
    const stored = localStorage.getItem(CONFIG.DB_NAME);
    if (stored) {
        db = JSON.parse(stored);
    }
    if (!db.measures) db.measures = [];
}

function saveData() {
    localStorage.setItem(CONFIG.DB_NAME, JSON.stringify(db));
}

// ========== NAVIGATION ==========
function goTo(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + step).classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Confetti on navigation for satisfaction!
    if (step === 5) {
        createConfetti(10);
    }
}

// ========== SATISFYING EFFECTS ==========
function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    
    // Confetti for success!
    if (type === 'success') {
        createConfetti(5);
    }
    
    setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function createConfetti(count) {
    const colors = ['#D4AF37', '#ff4d4d', '#2ecc71', '#3498db', '#9b59b6', '#e91e63'];
    
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 0.5 + 's';
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 2000);
        }, i * 50);
    }
}

// ========== PHOTO LOADING ==========
function loadPhotoForMeasure(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        baseImage = new Image();
        baseImage.onload = () => {
            document.getElementById('photoEditorContainer').classList.remove('hidden');
            initCanvas();
            showToast('‚ú® Photo charg√©e !', 'success');
        };
        baseImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function initCanvas() {
    canvas = document.getElementById('annotationCanvas');
    ctx = canvas.getContext('2d');
    
    const maxWidth = 550;
    const scale = maxWidth / baseImage.width;
    canvas.width = baseImage.width * scale;
    canvas.height = baseImage.height * scale;
    
    annotations = [];
    redraw();
    
    setupCanvasEvents();
}

function setupCanvasEvents() {
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);
}

function getMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    if (e.touches) {
        return {
            x: (e.touches[0].clientX - rect.left) * scaleX,
            y: (e.touches[0].clientY - rect.top) * scaleY
        };
    }
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

function handleTouch(e) {
    e.preventDefault();
    if (e.type === 'touchstart') startDrawing(e);
    else if (e.type === 'touchmove') draw(e);
}

// ========== TOOL SELECTION ==========
function selectTool(tool) {
    currentTool = tool;
    
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
    
    // Satisfying sound effect simulation
    showToast(`üìê ${tool.toUpperCase()} s√©lectionn√©`, 'success');
}

function selectColor(color) {
    currentColor = color;
    
    document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    // Visual feedback
    event.target.style.animation = 'none';
    setTimeout(() => {
        event.target.style.animation = '';
    }, 10);
}

// ========== DRAWING ==========
function startDrawing(e) {
    if (measureInputActive) return;
    
    isDrawing = true;
    const pos = getMousePos(e);
    startX = pos.x;
    startY = pos.y;
    
    if (currentTool === 'text') {
        const text = prompt('üìù Entrer le texte :');
        if (text) {
            annotations.push({
                type: 'text',
                x: startX,
                y: startY,
                text: text,
                color: currentColor
            });
            renderAnnotationsList();
            redraw();
            showToast('‚ú® Texte ajout√© !', 'success');
        }
        isDrawing = false;
    }
}

function draw(e) {
    if (!isDrawing) return;
    
    const pos = getMousePos(e);
    
    tempAnnotation = {
        type: currentTool,
        startX: startX,
        startY: startY,
        endX: pos.x,
        endY: pos.y,
        color: currentColor
    };
    
    redraw();
    drawAnnotation(tempAnnotation);
}

function stopDrawing(e) {
    if (!isDrawing) return;
    
    isDrawing = false;
    
    if (tempAnnotation) {
        if (currentTool === 'measure') {
            showMeasureInput(tempAnnotation);
        } else {
            annotations.push(tempAnnotation);
            renderAnnotationsList();
            showToast('‚úÖ Annotation ajout√©e !', 'success');
        }
        tempAnnotation = null;
        redraw();
    }
}

function showMeasureInput(annotation) {
    measureInputActive = true;
    
    const overlay = document.createElement('div');
    overlay.className = 'measure-input-overlay';
    overlay.style.left = '50%';
    overlay.style.top = '50%';
    overlay.style.transform = 'translate(-50%, -50%)';
    
    overlay.innerHTML = `
        <input type="text" id="measureValue" placeholder="Ex: 2.80m" autofocus>
        <button onclick="confirmMeasure()">‚úÖ CONFIRMER</button>
    `;
    
    document.body.appendChild(overlay);
    document.getElementById('measureValue').focus();
    
    // Store temp annotation
    window.tempMeasureAnnotation = annotation;
}

function confirmMeasure() {
    const value = document.getElementById('measureValue').value.trim();
    if (!value) {
        showToast('‚ö†Ô∏è Entrer une valeur', 'warning');
        return;
    }
    
    const annotation = window.tempMeasureAnnotation;
    annotation.measure = value;
    annotations.push(annotation);
    
    document.querySelector('.measure-input-overlay').remove();
    measureInputActive = false;
    
    renderAnnotationsList();
    redraw();
    createConfetti(8);
    showToast(`‚ú® Mesure "${value}" ajout√©e !`, 'success');
}

// ========== DRAWING FUNCTIONS ==========
function drawAnnotation(ann) {
    ctx.strokeStyle = ann.color;
    ctx.fillStyle = ann.color;
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    switch (ann.type) {
        case 'arrow':
            drawArrow(ann.startX, ann.startY, ann.endX, ann.endY);
            break;
        case 'line':
            ctx.beginPath();
            ctx.moveTo(ann.startX, ann.startY);
            ctx.lineTo(ann.endX, ann.endY);
            ctx.stroke();
            break;
        case 'measure':
            drawMeasureLine(ann);
            break;
        case 'rect':
            ctx.strokeRect(ann.startX, ann.startY, ann.endX - ann.startX, ann.endY - ann.startY);
            break;
        case 'circle':
            const radius = Math.sqrt(Math.pow(ann.endX - ann.startX, 2) + Math.pow(ann.endY - ann.startY, 2));
            ctx.beginPath();
            ctx.arc(ann.startX, ann.startY, radius, 0, Math.PI * 2);
            ctx.stroke();
            break;
        case 'text':
            ctx.font = 'bold 24px "Darker Grotesque"';
            ctx.fillText(ann.text, ann.x, ann.y);
            break;
    }
}

function drawArrow(x1, y1, x2, y2) {
    const headlen = 20;
    const angle = Math.atan2(y2 - y1, x2 - x1);
    
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function drawMeasureLine(ann) {
    // Line
    ctx.beginPath();
    ctx.moveTo(ann.startX, ann.startY);
    ctx.lineTo(ann.endX, ann.endY);
    ctx.stroke();
    
    // End caps
    const perpAngle = Math.atan2(ann.endY - ann.startY, ann.endX - ann.startX) + Math.PI / 2;
    const capLength = 15;
    
    ctx.beginPath();
    ctx.moveTo(ann.startX + capLength * Math.cos(perpAngle), ann.startY + capLength * Math.sin(perpAngle));
    ctx.lineTo(ann.startX - capLength * Math.cos(perpAngle), ann.startY - capLength * Math.sin(perpAngle));
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(ann.endX + capLength * Math.cos(perpAngle), ann.endY + capLength * Math.sin(perpAngle));
    ctx.lineTo(ann.endX - capLength * Math.cos(perpAngle), ann.endY - capLength * Math.sin(perpAngle));
    ctx.stroke();
    
    // Text
    if (ann.measure) {
        const midX = (ann.startX + ann.endX) / 2;
        const midY = (ann.startY + ann.endY) / 2;
        
        ctx.fillStyle = '#000';
        ctx.fillRect(midX - 40, midY - 20, 80, 30);
        
        ctx.fillStyle = ann.color;
        ctx.font = 'bold 20px "Space Mono"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(ann.measure, midX, midY);
    }
}

function redraw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (baseImage) {
        ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
    }
    
    annotations.forEach(ann => drawAnnotation(ann));
}

// ========== ANNOTATIONS LIST ==========
function renderAnnotationsList() {
    const list = document.getElementById('annotationsList');
    list.innerHTML = '';
    
    if (annotations.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#666; padding:20px 0;">Aucune annotation</p>';
        return;
    }
    
    annotations.forEach((ann, i) => {
        const label = ann.type === 'measure' && ann.measure ? 
            `üìê ${ann.measure}` : 
            `${getToolEmoji(ann.type)} ${ann.type}`;
        
        list.innerHTML += `
            <div class="annotation-item">
                <div class="annotation-info">
                    <span style="color: ${ann.color};">‚óè</span> ${label}
                </div>
                <button class="annotation-delete" onclick="deleteAnnotation(${i})">‚úï</button>
            </div>
        `;
    });
}

function getToolEmoji(type) {
    const emojis = {
        arrow: '‚û°Ô∏è',
        line: 'üìè',
        measure: 'üìê',
        rect: '‚¨ú',
        circle: '‚≠ï',
        text: 'üìù'
    };
    return emojis[type] || 'üìå';
}

function deleteAnnotation(index) {
    annotations.splice(index, 1);
    renderAnnotationsList();
    redraw();
    showToast('üóëÔ∏è Annotation supprim√©e', 'success');
}

function undoAnnotation() {
    if (annotations.length === 0) {
        showToast('‚ö†Ô∏è Aucune annotation', 'warning');
        return;
    }
    annotations.pop();
    renderAnnotationsList();
    redraw();
    showToast('‚Ü©Ô∏è Annul√©', 'success');
}

function clearAnnotations() {
    if (annotations.length === 0) return;
    
    if (confirm('üóëÔ∏è Effacer toutes les annotations ?')) {
        annotations = [];
        renderAnnotationsList();
        redraw();
        showToast('‚ú® Annotations effac√©es', 'success');
    }
}

// ========== SAVE ==========
function saveAnnotatedPhoto() {
    if (annotations.length === 0) {
        showToast('‚ö†Ô∏è Aucune annotation', 'warning');
        return;
    }
    
    const finalImage = canvas.toDataURL('image/jpeg', 0.9);
    
    db.measures.push({
        id: Date.now(),
        image: finalImage,
        annotations: annotations.length,
        date: new Date().toISOString()
    });
    
    saveData();
    
    // MASSIVE CONFETTI !
    createConfetti(30);
    showToast('üéâ Photo enregistr√©e avec succ√®s !', 'success');
    
    setTimeout(() => {
        document.getElementById('photoEditorContainer').classList.add('hidden');
        document.getElementById('measurePhoto').value = '';
        loadSavedMeasures();
    }, 1500);
}

function loadSavedMeasures() {
    const container = document.getElementById('savedMeasures');
    container.innerHTML = '';
    
    if (db.measures.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0;">Aucune mesure enregistr√©e</p>';
        return;
    }
    
    container.innerHTML = '<h3 style="color:var(--gold); margin:30px 0 20px 0;">üìê Mesures enregistr√©es</h3>';
    
    db.measures.reverse().forEach((measure, i) => {
        container.innerHTML += `
            <div class="card" style="cursor: default;">
                <img src="${measure.image}" style="width:100%; border-radius:8px; margin-bottom:10px;">
                <div style="font-size:12px; color:#888;">
                    ${measure.annotations} annotation${measure.annotations > 1 ? 's' : ''} ‚Ä¢ 
                    ${new Date(measure.date).toLocaleDateString('fr-FR')}
                </div>
            </div>
        `;
    });
}

// ========== EXPORT ==========
function exportData() {
    const backup = {
        version: CONFIG.VERSION,
        date: new Date().toISOString(),
        data: db
    };
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Vertex_Backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    createConfetti(15);
    showToast('üíæ Sauvegarde cr√©√©e !', 'success');
}

// ========== INIT SAVED MEASURES ==========
window.addEventListener('load', () => {
    if (document.getElementById('savedMeasures')) {
        loadSavedMeasures();
    }
});

console.log('‚ú® Vertex V5.0 Deluxe - √âdition Satisfaisante');
</script>

</body>
</html>
