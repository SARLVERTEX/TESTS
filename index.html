<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D4AF37">
    <meta name="description" content="Vertex Monaco - Syst√®me de gestion technico-commercial professionnel">
    <link rel="manifest" href="manifest.json">
    <title>Vertex Monaco | V15 PRO</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Darker+Grotesque:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ========== VARIABLES ========== */
        :root { 
            --gold: #D4AF37; 
            --gold-dark: #B8941F;
            --gold-light: #F5E6B3;
            --bg: #000; 
            --card: #121212; 
            --text: #fff; 
            --danger: #ff4d4d; 
            --success: #2ecc71; 
            --border: #282828;
            --warning: #f39c12;
            --info: #3498db;
            --accent: #e74c3c;
            --shadow: rgba(212, 175, 55, 0.15);
        }
        
        [data-theme="light"] {
            --bg: #fafafa;
            --card: #ffffff;
            --text: #1a1a1a;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        /* ========== RESET & BASE ========== */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Darker Grotesque', sans-serif; 
            line-height: 1.5; 
            overflow-x: hidden; 
            transition: background 0.3s, color 0.3s;
            font-size: 16px;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            padding-bottom: 100px; 
        }
        
        /* ========== TYPOGRAPHY ========== */
        h1, h2, h3 { 
            font-weight: 900; 
            letter-spacing: -0.02em; 
            margin: 0;
        }
        
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }
        
        .mono { 
            font-family: 'Space Mono', monospace; 
            letter-spacing: 0.05em;
        }
        
        /* ========== HEADER ========== */
        .header { 
            text-align: center; 
            padding: 30px 0; 
            border-bottom: 3px solid var(--gold); 
            margin-bottom: 30px; 
            position: relative;
            background: linear-gradient(135deg, var(--card) 0%, var(--bg) 100%);
        }
        
        .header h1 { 
            letter-spacing: 8px; 
            font-size: 24px; 
            color: var(--gold); 
            margin: 0; 
            font-weight: 900;
            text-shadow: 2px 2px 8px var(--shadow);
        }
        
        .header-subtitle {
            font-size: 11px;
            color: var(--gold-light);
            letter-spacing: 3px;
            margin-top: 8px;
            font-weight: 600;
            opacity: 0.8;
        }
        
        .version-badge { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            font-size: 9px; 
            background: var(--gold); 
            color: black; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-weight: bold;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .theme-toggle { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            background: none; 
            border: 2px solid var(--gold); 
            color: var(--gold); 
            padding: 8px 15px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: var(--gold);
            color: black;
            transform: rotate(180deg);
        }
        
        /* ========== INDICATORS ========== */
        .offline-indicator { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--danger); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 30px; 
            font-size: 13px; 
            font-weight: bold; 
            z-index: 10000; 
            display: none;
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.4);
        }
        
        .offline-indicator.active { 
            display: block; 
            animation: pulse 2s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); } 
            50% { opacity: 0.8; transform: translateX(-50%) scale(1.02); } 
        }
        
        .sync-indicator { 
            position: fixed; 
            top: 100px; 
            right: 20px; 
            background: var(--info); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 25px; 
            font-size: 11px; 
            font-weight: bold; 
            z-index: 9999; 
            display: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .sync-indicator.active { 
            display: block; 
            animation: slideInRight 0.3s; 
        }
        
        @keyframes slideInRight {
            from { transform: translateX(150px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ========== TOAST ========== */
        .toast { 
            position: fixed; 
            top: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--success); 
            color: white; 
            padding: 16px 30px; 
            border-radius: 12px; 
            font-size: 14px; 
            font-weight: bold; 
            z-index: 9999; 
            animation: toastSlide 0.3s ease;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }
        
        @keyframes toastSlide { 
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; } 
            to { transform: translateX(-50%) translateY(0); opacity: 1; } 
        }
        
        /* ========== PROGRESS BAR ========== */
        .progress-bar { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 30px;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 18px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
            z-index: 0;
        }
        
        .progress-step { 
            flex: 1; 
            text-align: center; 
            position: relative;
            z-index: 1;
        }
        
        .progress-dot { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: var(--card); 
            border: 3px solid var(--border);
            margin: 0 auto 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: 900;
            transition: all 0.3s;
        }
        
        .progress-step.active .progress-dot { 
            background: var(--gold); 
            color: black; 
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--shadow);
            transform: scale(1.1);
        }
        
        .progress-step.completed .progress-dot { 
            background: var(--success); 
            color: white; 
            border-color: var(--success);
        }
        
        .progress-label { 
            font-size: 11px; 
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* ========== LOADING SPINNER ========== */
        .spinner-container {
            text-align: center;
            padding: 40px 0;
        }
        
        .spinner { 
            border: 4px solid var(--border); 
            border-top: 4px solid var(--gold); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 0.8s linear infinite; 
            margin: 0 auto 15px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .spinner-text {
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }
        
        /* ========== TABS ========== */
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab-btn { 
            flex: 1; 
            min-width: 100px; 
            padding: 14px 20px; 
            background: transparent; 
            border: none;
            color: #666; 
            border-radius: 0;
            font-size: 13px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gold);
            transform: scaleX(0);
            transition: transform 0.3s;
        }
        
        .tab-btn.active { 
            color: var(--gold);
        }
        
        .tab-btn.active::after {
            transform: scaleX(1);
        }
        
        .tab-btn:hover {
            color: var(--gold-light);
        }
        
        /* ========== TYPE CHIPS ========== */
        .type-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        
        .type-chip { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 16px; 
            border-radius: 12px; 
            text-align: center; 
            font-size: 12px; 
            font-weight: 900; 
            color: #666; 
            cursor: pointer; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .type-chip.selected { 
            border-color: var(--gold); 
            color: var(--gold); 
            background: rgba(212, 175, 55, 0.15);
            box-shadow: 0 0 20px var(--shadow);
            transform: translateY(-2px);
        }
        
        .type-chip:hover {
            border-color: var(--gold-light);
            transform: translateY(-2px);
        }
        
        .type-chip:active { 
            transform: scale(0.95); 
        }
        
        /* ========== STAFF GRID ========== */
        .staff-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
        }
        
        .staff-chip { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 14px; 
            border-radius: 10px; 
            font-size: 13px; 
            text-align: center; 
            color: #888; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 700;
        }
        
        .staff-chip.selected { 
            background: var(--gold); 
            color: #000; 
            font-weight: 900; 
            border-color: var(--gold);
            box-shadow: 0 4px 15px var(--shadow);
            transform: translateY(-2px);
        }
        
        .staff-chip:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
        }
        
        .staff-chip:active { 
            transform: scale(0.95); 
        }
        /* ========== CHECKLIST ========== */
        .check-item { 
            display: flex; 
            align-items: center; 
            background: var(--card); 
            padding: 16px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border: 2px solid var(--border); 
            transition: all 0.3s;
        }
        
        .check-item:has(input:checked) { 
            background: rgba(46, 204, 113, 0.15); 
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.2);
        }
        
        .check-item input { 
            width: 24px; 
            height: 24px; 
            margin-right: 15px; 
            accent-color: var(--gold); 
            cursor: pointer;
        }
        
        .check-item label {
            flex: 1;
            cursor: pointer;
            user-select: none;
            margin: 0;
            font-weight: 600;
        }
        
        /* ========== PHOTO SYSTEM ========== */
        .photo-box { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 20px; 
            border-radius: 15px; 
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .photo-box h4 { 
            margin: 0 0 15px 0; 
            font-size: 12px; 
            color: var(--gold); 
            text-transform: uppercase; 
            letter-spacing: 2px;
            font-weight: 900;
        }
        
        .photo-gallery { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .photo-card { 
            background: var(--bg); 
            padding: 12px; 
            border-radius: 12px; 
            border: 2px solid var(--border); 
            position: relative;
            transition: all 0.3s;
        }
        
        .photo-card:hover {
            border-color: var(--gold);
            box-shadow: 0 4px 20px var(--shadow);
        }
        
        .photo-card img { 
            width: 100%; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            max-height: 400px; 
            object-fit: contain; 
            cursor: pointer; 
            transition: transform 0.3s;
            background: #1a1a1a;
        }
        
        .photo-card img:hover { 
            transform: scale(1.02); 
        }
        
        .photo-input { 
            background: var(--bg); 
            border: 1px solid var(--border); 
            color: var(--text); 
            padding: 10px; 
            font-size: 13px; 
            width: 100%; 
            border-radius: 6px; 
            margin-bottom: 8px;
            font-family: 'Darker Grotesque', sans-serif;
            font-weight: 600;
        }
        
        .photo-size { 
            font-size: 10px; 
            color: #666; 
            margin-bottom: 8px;
            font-family: 'Space Mono', monospace;
        }
        
        .photo-controls { 
            display: flex; 
            gap: 8px; 
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .photo-controls button { 
            flex: 1; 
            min-width: 80px;
            padding: 8px 12px; 
            font-size: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border); 
            background: var(--card); 
            color: var(--text); 
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }
        
        .photo-controls button:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .photo-controls button:active {
            transform: scale(0.95);
        }
        
        /* ========== ANNOTATION CANVAS ========== */
        .annotation-container {
            position: relative;
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 10;
        }
        
        .annotation-tools {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .annotation-tool-btn {
            padding: 8px 12px;
            background: var(--card);
            border: 2px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .annotation-tool-btn.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        
        .annotation-tool-btn:hover {
            border-color: var(--gold);
        }
        
        .color-picker {
            width: 40px;
            height: 36px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .measure-input {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            background: var(--card);
            border: 2px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ========== IMAGE MODAL ========== */
        .image-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 10001; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .image-modal.active { 
            display: flex; 
            animation: fadeIn 0.3s; 
        }
        
        .image-modal img { 
            max-width: 100%; 
            max-height: 90vh; 
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .image-modal-close { 
            position: absolute; 
            top: 30px; 
            right: 30px; 
            background: var(--danger); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .image-modal-close:hover {
            background: #ff6b6b;
            transform: scale(1.05);
        }
        
        /* ========== SIGNATURE ========== */
        #sig-canvas { 
            background: #fff; 
            border: 3px solid var(--gold); 
            border-radius: 12px; 
            touch-action: none; 
            width: 100%; 
            height: 250px; 
            cursor: crosshair;
            box-shadow: 0 4px 20px var(--shadow);
        }
        
        /* ========== BUTTONS ========== */
        .btn-gold { 
            width: 100%; 
            padding: 20px; 
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: black; 
            border: none; 
            font-weight: 900; 
            border-radius: 12px; 
            text-transform: uppercase; 
            margin-top: 20px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-size: 15px;
            letter-spacing: 0.1em;
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--shadow);
        }
        
        .btn-gold:active { 
            transform: scale(0.98); 
        }
        
        .btn-gold:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-outline { 
            width: 100%; 
            padding: 14px 20px; 
            background: transparent; 
            color: var(--text); 
            border: 2px solid var(--border); 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-outline:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-outline:active { 
            transform: scale(0.98); 
        }
        
        .btn-now { 
            background: var(--card); 
            color: var(--gold); 
            border: 2px solid var(--gold); 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 11px; 
            margin-top: 8px; 
            width: 100%; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-now:hover {
            background: var(--gold);
            color: black;
        }
        
        .btn-now:active { 
            transform: scale(0.95); 
        }
        
        .btn-danger { 
            width: 100%; 
            padding: 14px 20px; 
            background: rgba(255, 77, 77, 0.1); 
            color: var(--danger); 
            border: 2px solid var(--danger); 
            border-radius: 10px; 
            margin-top: 30px; 
            font-size: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-danger:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-danger:active { 
            transform: scale(0.98); 
        }
        
        /* ========== FORM INPUTS ========== */
        label { 
            display: block; 
            margin: 20px 0 8px 0; 
            font-size: 12px; 
            font-weight: 900; 
            color: var(--gold); 
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        input:not([type="checkbox"]):not([type="file"]), 
        textarea, 
        select { 
            width: 100%; 
            padding: 14px; 
            background: var(--card); 
            border: 2px solid var(--border); 
            color: var(--text); 
            border-radius: 10px; 
            font-size: 15px;
            font-family: 'Darker Grotesque', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--shadow);
        }
        
        textarea { 
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }
        
        /* ========== CARDS ========== */
        .folder-card { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        
        .folder-card:hover { 
            border-color: var(--gold); 
            background: rgba(212, 175, 55, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .folder-card:active { 
            transform: scale(0.98); 
        }
        
        .folder-info { 
            flex: 1; 
        }
        
        .folder-name { 
            font-weight: 900; 
            font-size: 18px; 
            margin-bottom: 6px;
            color: var(--gold);
        }
        
        .folder-meta { 
            font-size: 12px; 
            color: #666;
            font-family: 'Space Mono', monospace;
        }
        
        .folder-arrow { 
            color: var(--gold); 
            font-size: 28px;
            transition: transform 0.3s;
        }
        
        .folder-card:hover .folder-arrow {
            transform: translateX(5px);
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin: 20px 0; 
        }
        
        .stat-card { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--shadow);
        }
        
        .stat-value { 
            font-size: 32px; 
            font-weight: 900; 
            color: var(--gold);
            font-family: 'Space Mono', monospace;
        }
        
        .stat-label { 
            font-size: 10px; 
            color: #666; 
            text-transform: uppercase; 
            margin-top: 8px;
            letter-spacing: 0.05em;
            font-weight: 700;
        }
        /* ========== TIMELINE ========== */
        .timeline-item { 
            border-left: 4px solid var(--gold); 
            padding-left: 25px; 
            margin-bottom: 50px; 
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 12px;
            height: 12px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--shadow);
        }
        
        .section-block { 
            background: var(--card); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border-left: 3px solid var(--border);
            font-size: 14px; 
            border: 2px solid var(--border);
            transition: all 0.3s;
        }
        
        .section-block:hover {
            border-left-color: var(--gold);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        /* ========== CHARTS ========== */
        .chart-container { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 20px; 
            border-radius: 12px; 
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .chart-title { 
            font-size: 13px; 
            font-weight: 900; 
            color: var(--gold); 
            margin-bottom: 15px; 
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .chart-bar { 
            background: var(--border); 
            height: 36px; 
            border-radius: 8px; 
            margin-bottom: 12px; 
            position: relative; 
            overflow: hidden;
        }
        
        .chart-bar-fill { 
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-dark) 100%);
            height: 100%; 
            transition: width 0.8s ease; 
            display: flex; 
            align-items: center; 
            padding-left: 15px; 
            font-size: 13px; 
            font-weight: 900; 
            color: black;
            font-family: 'Space Mono', monospace;
        }
        
        .chart-bar-label { 
            font-size: 11px; 
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* ========== STATUS PILLS ========== */
        .status-pill { 
            padding: 8px 16px; 
            border-radius: 25px; 
            font-size: 11px; 
            font-weight: 900; 
            cursor: pointer; 
            border: none; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-ongoing { 
            background: var(--success); 
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .status-done { 
            background: #666; 
            color: white; 
        }
        
        .status-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .status-pill:active { 
            transform: scale(0.95); 
        }
        
        /* ========== MODAL ========== */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 10000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal.active { 
            display: flex; 
            animation: fadeIn 0.3s; 
        }
        
        .modal-content { 
            background: var(--card); 
            border: 3px solid var(--gold); 
            border-radius: 15px; 
            padding: 30px; 
            max-width: 500px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .modal-title { 
            font-size: 20px; 
            font-weight: 900; 
            color: var(--gold); 
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .modal-body { 
            font-size: 14px; 
            margin-bottom: 25px; 
            line-height: 1.6;
            font-weight: 600;
        }
        
        .modal-actions { 
            display: flex; 
            gap: 12px; 
        }
        
        .modal-btn { 
            flex: 1; 
            padding: 14px; 
            border-radius: 10px; 
            border: none; 
            font-weight: 900; 
            cursor: pointer;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }
        
        .modal-btn.confirm { 
            background: var(--gold); 
            color: black;
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .modal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .modal-btn.cancel { 
            background: transparent; 
            color: var(--text); 
            border: 2px solid var(--border); 
        }
        
        .modal-btn.cancel:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }
        
        /* ========== TEMPLATES ========== */
        .template-card { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 16px; 
            border-radius: 10px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        
        .template-card:hover { 
            border-color: var(--gold);
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(-2px);
        }
        
        .template-card h4 { 
            margin: 0 0 8px 0; 
            font-size: 15px; 
            color: var(--gold);
            font-weight: 900;
        }
        
        .template-card p { 
            margin: 0; 
            font-size: 12px; 
            color: #666;
            font-weight: 600;
        }
        
        /* ========== SEARCH FILTERS ========== */
        .search-filters { 
            background: var(--card); 
            border: 2px solid var(--border); 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 15px;
        }
        
        .filter-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 12px; 
        }
        
        /* ========== COMMERCIAL TOOLS ========== */
        .quote-section {
            background: var(--card);
            border: 2px solid var(--gold);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .quote-section h3 {
            color: var(--gold);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .quote-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 40px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .quote-total {
            text-align: right;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid var(--gold);
        }
        
        .quote-total-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #666;
            font-weight: 700;
        }
        
        .quote-total-amount {
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
            font-family: 'Space Mono', monospace;
        }
        
        /* ========== CLIENT NOTES ========== */
        .client-notes {
            background: var(--card);
            border-left: 4px solid var(--info);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            font-weight: 600;
        }
        
        .client-notes-header {
            color: var(--info);
            font-weight: 900;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        /* ========== STEP CONTAINER ========== */
        .step { 
            display: none; 
            animation: fadeIn 0.3s ease; 
        }
        
        .step.active { 
            display: block; 
        }
        
        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ========== WEATHER WIDGET ========== */
        .weather-widget { 
            background: linear-gradient(135deg, var(--card) 0%, var(--bg) 100%);
            border: 2px solid var(--border); 
            padding: 16px; 
            border-radius: 12px; 
            margin: 15px 0; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .weather-icon { 
            font-size: 40px; 
        }
        
        .weather-info { 
            flex: 1; 
        }
        
        .weather-temp { 
            font-size: 24px; 
            font-weight: 900; 
            color: var(--gold);
            font-family: 'Space Mono', monospace;
        }
        
        .weather-desc { 
            font-size: 12px; 
            color: #666;
            font-weight: 600;
        }
        
        /* ========== INSTALL PROMPT ========== */
        .install-prompt { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--gold); 
            color: black; 
            padding: 18px 25px; 
            border-radius: 15px; 
            font-size: 13px; 
            font-weight: 900; 
            z-index: 10000; 
            display: none; 
            box-shadow: 0 8px 30px var(--shadow);
            max-width: 90%;
        }
        
        .install-prompt.active { 
            display: block; 
            animation: slideUp 0.4s ease; 
        }
        
        .install-prompt button { 
            margin-left: 12px; 
            padding: 10px 18px; 
            background: black; 
            color: var(--gold); 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .install-prompt button:hover {
            transform: scale(1.05);
        }
        
        /* ========== PRINT STYLES ========== */
        @media print { 
            .no-print { display: none !important; } 
            body { 
                background: white; 
                color: black; 
            }
            .container {
                max-width: 100%;
            }
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 20px;
                letter-spacing: 4px;
            }
            
            .type-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .quote-item {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* ========== UTILITY CLASSES ========== */
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .text-center { text-align: center; }
        .text-gold { color: var(--gold); }
        .font-mono { font-family: 'Space Mono', monospace; }
        .uppercase { text-transform: uppercase; }
        .bold { font-weight: 900; }
    </style>
</head>
<body>
<!-- ========== INDICATORS ========== -->
<div class="offline-indicator" id="offlineIndicator">üì° MODE HORS LIGNE</div>
<div class="sync-indicator" id="syncIndicator">üîÑ Synchronisation...</div>

<div class="container">
    <!-- ========== HEADER ========== -->
    <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        <h1>VERTEX MONACO</h1>
        <p class="header-subtitle">TECHNICO-COMMERCIAL PRO | V15</p>
        <div class="version-badge">v15.0</div>
    </div>

    <!-- ========== HOME / PROJECT LIST ========== -->
    <div class="step active" id="step0">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Dossiers actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total missions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-hours">0h</div>
                <div class="stat-label">Total heures</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-month">0</div>
                <div class="stat-label">Ce mois</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="tab-active" onclick="switchTab('ongoing')">EN COURS</button>
            <button class="tab-btn" id="tab-archived" onclick="switchTab('done')">ARCHIVES</button>
            <button class="tab-btn" id="tab-analytics" onclick="switchTab('analytics')">STATS</button>
            <button class="tab-btn" id="tab-quotes" onclick="switchTab('quotes')">DEVIS</button>
        </div>
        
        <!-- LIST VIEW -->
        <div id="view-list">
            <button class="btn-gold" onclick="showNewProjectOptions()">+ NOUVEAU CLIENT</button>
            
            <input type="text" id="searchBar" oninput="filterProjects()" placeholder="üîç Rechercher un dossier..." style="margin-top:20px;">
            
            <div class="search-filters" id="advancedFilters" style="display:none;">
                <div class="filter-row">
                    <select id="filterType" onchange="filterProjects()">
                        <option value="">Tous types</option>
                        <option value="INSTALLATION">Installation</option>
                        <option value="MAINTENANCE">Maintenance</option>
                        <option value="D√âPANNAGE">D√©pannage</option>
                        <option value="AUDIT">Audit</option>
                        <option value="√âTAT DES LIEUX">√âtat des lieux</option>
                        <option value="DEVIS">Devis</option>
                    </select>
                    <select id="filterStaff" onchange="filterProjects()">
                        <option value="">Toute √©quipe</option>
                        <option value="Allan">Allan</option>
                        <option value="Pietro">Pietro</option>
                        <option value="Marco">Marco</option>
                        <option value="Osvaldo">Osvaldo</option>
                        <option value="Jean-Christophe">Jean-Christophe</option>
                    </select>
                </div>
                <div class="filter-row">
                    <input type="date" id="filterDateFrom" onchange="filterProjects()">
                    <input type="date" id="filterDateTo" onchange="filterProjects()">
                </div>
            </div>
            
            <button class="btn-outline" onclick="toggleAdvancedFilters()" style="margin-top:12px; font-size:11px;">
                üîé FILTRES AVANC√âS
            </button>
            
            <div id="project-list" style="margin-top:15px;"></div>
            
            <button class="btn-outline" onclick="exportToCSV()" style="margin-top:50px;">üìä EXPORT EXCEL (.CSV)</button>
            <button class="btn-outline" onclick="exportPDFReport()">üìÑ RAPPORT PDF GLOBAL</button>
            <button class="btn-outline" onclick="exportBackup()">üíæ SAUVEGARDER DONN√âES</button>
            <button class="btn-outline" onclick="document.getElementById('import-file').click()">üì• RESTAURER DONN√âES</button>
            <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importBackup(this)">
        </div>

        <!-- ANALYTICS VIEW -->
        <div id="view-analytics" style="display:none;">
            <div class="chart-container">
                <div class="chart-title">üìà Interventions par type</div>
                <div id="chart-by-type"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üë• Interventions par technicien</div>
                <div id="chart-by-staff"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üìÖ √âvolution mensuelle</div>
                <div id="chart-by-month"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avg-duration">0h</div>
                    <div class="stat-label">Dur√©e moyenne</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="top-client">-</div>
                    <div class="stat-label">Top client</div>
                </div>
            </div>

            <button class="btn-outline" onclick="exportAnalyticsPDF()">üìä EXPORTER STATS PDF</button>
        </div>

        <!-- QUOTES VIEW -->
        <div id="view-quotes" style="display:none;">
            <button class="btn-gold" onclick="newQuote()">+ NOUVEAU DEVIS</button>
            <div id="quotes-list" style="margin-top:20px;"></div>
        </div>
    </div>
    <!-- ========== STEP 1: MISSION INFO ========== -->
    <div class="step" id="step1">
        <div class="progress-bar">
            <div class="progress-step active">
                <div class="progress-dot">1</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">2</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">3</div>
                <div class="progress-label">Rapport</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">4</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <h3 id="c-name" style="text-align:center; color:var(--gold); margin-bottom:25px;"></h3>
        
        <label>Charger un template</label>
        <button class="btn-outline" onclick="showTemplates()">üìã TEMPLATES DISPONIBLES</button>
        
        <label>Type de mission *</label>
        <div class="type-grid">
            <div class="type-chip" onclick="selectType(this, 'INSTALLATION')">INSTALLATION</div>
            <div class="type-chip" onclick="selectType(this, 'MAINTENANCE')">MAINTENANCE</div>
            <div class="type-chip" onclick="selectType(this, 'D√âPANNAGE')">D√âPANNAGE</div>
            <div class="type-chip" onclick="selectType(this, 'AUDIT')">AUDIT</div>
            <div class="type-chip" onclick="selectType(this, '√âTAT DES LIEUX')">√âTAT DES LIEUX</div>
            <div class="type-chip" onclick="selectType(this, 'DEVIS')">DEVIS</div>
        </div>

        <label>√âquipe sur place *</label>
        <div class="staff-grid">
            <div class="staff-chip" onclick="toggleStaff(this)">Allan</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Pietro</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Marco</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Osvaldo</div>
            <div class="staff-chip" onclick="toggleStaff(this)">Jean-Christophe</div>
        </div>

        <label>Heure d'arriv√©e *</label>
        <input type="time" id="time_in">
        <button class="btn-now" onclick="setTime('time_in')">‚è∞ MAINTENANT</button>

        <div class="weather-widget" id="weather-widget" style="display:none;">
            <div class="weather-icon">üå§Ô∏è</div>
            <div class="weather-info">
                <div class="weather-temp">--¬∞C</div>
                <div class="weather-desc">Chargement m√©t√©o...</div>
            </div>
        </div>

        <div id="gps-info" style="font-size:11px; color: var(--success); margin-top:15px; font-weight:700;"></div>

        <label>Notes client / Contexte</label>
        <textarea id="client_context" rows="3" placeholder="Informations importantes avant l'intervention..."></textarea>

        <button class="btn-gold" onclick="validateStep1()">D√âMARRER L'INTERVENTION</button>
        <button class="btn-outline" onclick="confirmCancel()">ANNULER</button>
    </div>

    <!-- ========== STEP 2: PHOTOS AVANT & PENDANT ========== -->
    <div class="step" id="step2">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">2</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">3</div>
                <div class="progress-label">Rapport</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">4</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos AVANT l'intervention</h4>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'before')" style="display:none;" id="cam-before">
            <button class="btn-outline" onclick="document.getElementById('cam-before').click()">+ AJOUTER PHOTOS AVANT</button>
            <div id="gallery-before" class="photo-gallery"></div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos PENDANT l'intervention</h4>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'during')" style="display:none;" id="cam-during">
            <button class="btn-outline" onclick="document.getElementById('cam-during').click()">+ AJOUTER PHOTOS PENDANT</button>
            <div id="gallery-during" class="photo-gallery"></div>
        </div>

        <button class="btn-gold" onclick="validateStep2()">CONTINUER ‚Üí RAPPORT</button>
        <button class="btn-outline" onclick="nextStep(1)">‚Üê RETOUR</button>
    </div>
    <!-- ========== STEP 3: PHOTOS APR√àS & RAPPORT ========== -->
    <div class="step" id="step3">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">3</div>
                <div class="progress-label">Rapport</div>
            </div>
            <div class="progress-step">
                <div class="progress-dot">4</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <div class="photo-box">
            <h4>üì∏ Photos APR√àS l'intervention</h4>
            <input type="file" accept="image/*" capture="environment" multiple onchange="handlePhotos(this, 'after')" style="display:none;" id="cam-after">
            <button class="btn-outline" onclick="document.getElementById('cam-after').click()">+ AJOUTER PHOTOS APR√àS</button>
            <div id="gallery-after" class="photo-gallery"></div>
        </div>

        <label>Compte-rendu des travaux r√©alis√©s *</label>
        <textarea id="task_done" rows="6" placeholder="Description technique d√©taill√©e de l'intervention effectu√©e..."></textarea>
        
        <label>Mat√©riel install√© / R√©f√©rences</label>
        <textarea id="task_mat" rows="3" placeholder="√âquipements install√©s, r√©f√©rences, num√©ros de s√©rie..."></textarea>

        <label>Pi√®ces d√©tach√©es utilis√©es</label>
        <textarea id="task_parts" rows="3" placeholder="Liste des pi√®ces, quantit√©s, r√©f√©rences..."></textarea>

        <label>Recommandations / Points de vigilance</label>
        <textarea id="task_recommendations" rows="3" placeholder="Conseils pour le client, prochaines interventions, SAV..."></textarea>

        <button class="btn-gold" onclick="validateStep3()">CONTINUER ‚Üí FINALISATION</button>
        <button class="btn-outline" onclick="nextStep(2)">‚Üê RETOUR AUX PHOTOS</button>
    </div>

    <!-- ========== STEP 4: CHECKLIST, HEURE DE D√âPART & SIGNATURE ========== -->
    <div class="step" id="step4">
        <div class="progress-bar">
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">D√©marrage</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Photos</div>
            </div>
            <div class="progress-step completed">
                <div class="progress-dot">‚úì</div>
                <div class="progress-label">Rapport</div>
            </div>
            <div class="progress-step active">
                <div class="progress-dot">4</div>
                <div class="progress-label">Signature</div>
            </div>
        </div>

        <label>Heure de d√©part *</label>
        <input type="time" id="time_out">
        <button class="btn-now" onclick="setTime('time_out')">‚è∞ MAINTENANT</button>

        <label style="margin-top:30px;">Checklist de fin de mission *</label>
        <div id="checklist-container"></div>

        <label style="margin-top:30px;">Signature client (tactile ou souris) *</label>
        <canvas id="sig-canvas"></canvas>
        <button class="btn-outline" onclick="clearSig()">üóëÔ∏è EFFACER LA SIGNATURE</button>
        
        <div id="save-spinner" style="display:none;">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p class="spinner-text">Enregistrement en cours...</p>
            </div>
        </div>
        
        <button class="btn-gold" id="btn-save" onclick="saveEntry()">‚úì ENREGISTRER LA MISSION</button>
        <button class="btn-outline" onclick="nextStep(3)">‚Üê RETOUR AU RAPPORT</button>
    </div>
    <!-- ========== STEP 5: VIEW PROJECT ========== -->
    <div class="step" id="step5">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
            <h2 id="view-n" style="color:var(--gold); margin:0; font-size:22px;"></h2>
            <div id="status-toggle-container"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="project-interventions">0</div>
                <div class="stat-label">Interventions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="project-hours">0h</div>
                <div class="stat-label">Temps total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="project-quotes">0</div>
                <div class="stat-label">Devis</div>
            </div>
        </div>

        <div id="timeline" style="margin-top:30px;"></div>
        
        <div class="no-print">
            <button class="btn-outline" style="color:#2ecc71; border-color:#2ecc71;" onclick="sendProjectMail()">
                ‚úâÔ∏è ENVOYER PAR MAIL
            </button>
            <button class="btn-outline" style="color:#3498db; border-color:#3498db;" onclick="shareWhatsApp()">
                üí¨ PARTAGER WHATSAPP
            </button>
            <button class="btn-gold" onclick="newIntervention()">+ NOUVELLE INTERVENTION</button>
            <button class="btn-outline" onclick="exportProjectPDF()">üñ®Ô∏è G√âN√âRER PDF D√âTAILL√â</button>
            <button class="btn-outline" onclick="duplicateLastIntervention()">üìã DUPLIQUER DERNI√àRE</button>
            <button class="btn-outline" onclick="newProjectQuote()">üí∞ CR√âER UN DEVIS</button>
            <button class="btn-outline" onclick="nextStep(0)">‚Üê RETOUR ACCUEIL</button>
            <button class="btn-danger" onclick="confirmDeleteProject()">‚ö†Ô∏è SUPPRIMER CE CLIENT</button>
        </div>
    </div>
</div>

<!-- ========== MODALS ========== -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Confirmation</div>
        <div class="modal-body" id="modalBody">√ätes-vous s√ªr ?</div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal()">Annuler</button>
            <button class="modal-btn confirm" id="modalConfirm" onclick="modalConfirmAction()">Confirmer</button>
        </div>
    </div>
</div>

<div class="modal" id="templatesModal">
    <div class="modal-content">
        <div class="modal-title">üìã Choisir un template</div>
        <div id="templates-list"></div>
        <button class="btn-outline" onclick="closeModal('templatesModal')" style="margin-top:20px;">Fermer</button>
    </div>
</div>

<div class="modal" id="annotationModal">
    <div class="modal-content" style="max-width:90%; max-height:90vh;">
        <div class="modal-title">‚úèÔ∏è Annoter la photo</div>
        <div class="annotation-tools">
            <button class="annotation-tool-btn" id="tool-arrow" onclick="selectAnnotationTool('arrow')">‚Üí Fl√®che</button>
            <button class="annotation-tool-btn" id="tool-line" onclick="selectAnnotationTool('line')">‚Äî Ligne</button>
            <button class="annotation-tool-btn" id="tool-text" onclick="selectAnnotationTool('text')">T Texte</button>
            <button class="annotation-tool-btn" id="tool-measure" onclick="selectAnnotationTool('measure')">üìè Mesure</button>
            <input type="color" class="color-picker" id="annotation-color" value="#D4AF37">
            <input type="text" class="measure-input" id="measure-value" placeholder="Ex: 2.5m">
            <button class="annotation-tool-btn" onclick="undoAnnotation()">‚Ü∂ Annuler</button>
            <button class="annotation-tool-btn" onclick="clearAnnotations()">üóëÔ∏è Effacer tout</button>
        </div>
        <div class="annotation-container" id="annotation-container">
            <img id="annotation-image" src="" style="width:100%; display:block;">
            <canvas class="annotation-canvas" id="annotation-canvas"></canvas>
        </div>
        <div class="modal-actions" style="margin-top:15px;">
            <button class="modal-btn cancel" onclick="closeAnnotationModal()">Annuler</button>
            <button class="modal-btn confirm" onclick="saveAnnotation()">‚úì Enregistrer</button>
        </div>
    </div>
</div>

<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close">‚úï FERMER</button>
    <img id="modalImage" src="" alt="">
</div>

<div class="install-prompt" id="installPrompt">
    üì± Installer Vertex Monaco sur votre appareil
    <button onclick="installPWA()">Installer</button>
    <button onclick="dismissInstall()" style="background:transparent; color:black; border:2px solid black;">
        Plus tard
    </button>
</div>
<script>
// ========== CONFIGURATION ==========
const CONFIG = {
    DB_NAME: 'VertexDB_V15',
    DB_VERSION: 4,
    MAX_IMAGE_SIZE: 1400,
    IMAGE_QUALITY: 0.75,
    WEATHER_API_KEY: 'demo',
    ENABLE_CLOUD_SYNC: false,
    AUTO_SAVE_INTERVAL: 30000,
    ANNOTATION_LINE_WIDTH: 3,
    ANNOTATION_FONT_SIZE: 16,
};

// ========== STATE ==========
let db = {};
let indexedDB_instance = null;
let cur = null;
let staff = [];
let photosBefore = [];
let photosDuring = [];
let photosAfter = [];
let selectedType = "";
let currentFilter = 'ongoing';
let currentView = 'list';
let gpsCoords = null;
let hasUnsavedChanges = false;
let modalCallback = null;
let isOnline = navigator.onLine;
let syncQueue = [];
let deferredPrompt = null;
let currentTheme = localStorage.getItem('vertex_theme') || 'dark';

// Annotation state
let currentAnnotationPhoto = null;
let currentAnnotationType = null;
let annotationCanvas = null;
let annotationCtx = null;
let isAnnotating = false;
let annotationStartPos = null;
let annotations = [];
let currentAnnotationColor = '#D4AF37';

// Templates
const TEMPLATES = {
    'installation_standard': {
        name: 'Installation Standard',
        type: 'INSTALLATION',
        checklist: [
            'Chantier nettoy√© / Propret√©',
            'Tests de diffusion OK',
            'Alimentation & Baie verrouill√©es',
            'Documentation technique remise',
            'Client form√© √† l\'utilisation',
            'Client pr√©venu du d√©part'
        ],
        taskTemplate: 'Installation compl√®te du syst√®me audio/vid√©o comprenant :\n- Pose du mat√©riel\n- C√¢blage et raccordements\n- Configuration initiale\n- Tests de fonctionnement\n- Formation client'
    },
    'maintenance_preventive': {
        name: 'Maintenance Pr√©ventive',
        type: 'MAINTENANCE',
        checklist: [
            'V√©rification c√¢blage',
            'Nettoyage √©quipements',
            'Tests syst√®mes',
            'Mise √† jour firmware',
            'Documentation MAJ',
            'Client pr√©venu du d√©part'
        ],
        taskTemplate: 'Maintenance pr√©ventive incluant :\n- V√©rification √©tat g√©n√©ral\n- Nettoyage des connectiques\n- Tests de performance\n- Mise √† jour logiciels\n- Recommandations'
    },
    'depannage_urgent': {
        name: 'D√©pannage Urgent',
        type: 'D√âPANNAGE',
        checklist: [
            'Diagnostic effectu√©',
            'Panne r√©solue',
            'Tests OK',
            'Client form√©',
            'SAV planifi√© si n√©cessaire',
            'Client pr√©venu du d√©part'
        ],
        taskTemplate: 'Intervention de d√©pannage :\n- Diagnostic panne\n- R√©paration effectu√©e\n- Tests validation\n- Conseils client'
    },
    'etat_des_lieux': {
        name: '√âtat des Lieux',
        type: '√âTAT DES LIEUX',
        checklist: [
            'Toutes les zones photographi√©es',
            'Mesures not√©es',
            '√âtat g√©n√©ral √©valu√©',
            'Points d\'attention identifi√©s',
            'Rapport photos complet',
            'Client inform√©'
        ],
        taskTemplate: '√âtat des lieux complet :\n- Prise de photos avec mesures\n- √âvaluation de l\'infrastructure\n- Identification des besoins\n- Recommandations pour devis'
    },
    'audit_technique': {
        name: 'Audit Technique',
        type: 'AUDIT',
        checklist: [
            'Inventaire mat√©riel fait',
            '√âtat r√©seau analys√©',
            'Points faibles identifi√©s',
            'Recommandations formul√©es',
            'Rapport d√©taill√©',
            'Client brief√©'
        ],
        taskTemplate: 'Audit technique approfondi :\n- Inventaire √©quipements\n- Analyse infrastructure\n- Tests performance\n- Identification des axes d\'am√©lioration\n- Recommandations budg√©tis√©es'
    }
};

// ========== INITIALIZATION ==========
window.addEventListener('load', async () => {
    console.log('üöÄ Initialisation Vertex Monaco V15...');
    
    await initIndexedDB();
    await loadFromIndexedDB();
    applyTheme(currentTheme);
    checkStorageSpace();
    requestGeolocation();
    setupBeforeUnload();
    setupNetworkListeners();
    loadList();
    updateStats();
    
    // PWA Installation prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        setTimeout(() => {
            if (!localStorage.getItem('pwa_dismissed')) {
                document.getElementById('installPrompt').classList.add('active');
            }
        }, 5000);
    });
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {
            console.log('Service Worker non disponible');
        });
    }
    
    // Auto-save interval
    setInterval(autoSave, CONFIG.AUTO_SAVE_INTERVAL);
    
    // Weather
    getWeather();
    
    console.log('‚úì Vertex Monaco pr√™t');
});

// ========== INDEXED DB ==========
async function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
        
        request.onerror = () => {
            console.error('IndexedDB error:', request.error);
            reject(request.error);
        };
        
        request.onsuccess = () => {
            indexedDB_instance = request.result;
            console.log('‚úì IndexedDB connect√©');
            resolve();
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            if (!db.objectStoreNames.contains('projects')) {
                db.createObjectStore('projects', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('images')) {
                db.createObjectStore('images', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('quotes')) {
                db.createObjectStore('quotes', { keyPath: 'id' });
            }
            
            console.log('‚úì IndexedDB sch√©ma mis √† jour');
        };
    });
}

async function loadFromIndexedDB() {
    try {
        const transaction = indexedDB_instance.transaction(['projects'], 'readonly');
        const store = transaction.objectStore('projects');
        const request = store.getAll();
        
        request.onsuccess = () => {
            db = {};
            request.result.forEach(project => {
                db[project.id] = project.data;
            });
            console.log(`‚úì ${Object.keys(db).length} projets charg√©s`);
        };
    } catch (e) {
        console.error('Erreur chargement IndexedDB:', e);
        const stored = localStorage.getItem('vertex_v15_db');
        if (stored) {
            db = JSON.parse(stored);
            console.log('‚úì Donn√©es charg√©es depuis localStorage (fallback)');
        }
    }
}

async function saveToIndexedDB() {
    try {
        const transaction = indexedDB_instance.transaction(['projects'], 'readwrite');
        const store = transaction.objectStore('projects');
        
        // Clear and re-save
        await store.clear();
        
        for (const [id, data] of Object.entries(db)) {
            if (id !== '_version') {
                await store.put({ id, data });
            }
        }
        
        // Backup to localStorage
        localStorage.setItem('vertex_v15_db', JSON.stringify(db));
        console.log('‚úì Donn√©es sauvegard√©es');
        hasUnsavedChanges = false;
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
        showToast('Erreur de sauvegarde', 'error');
    }
}

function autoSave() {
    if (hasUnsavedChanges) {
        saveToIndexedDB();
        showToast('üíæ Sauvegarde automatique', 'info');
    }
}

// ========== THEME ==========
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    applyTheme(currentTheme);
    localStorage.setItem('vertex_theme', currentTheme);
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    console.log(`‚úì Th√®me appliqu√©: ${theme}`);
}

// ========== NETWORK ==========
function setupNetworkListeners() {
    window.addEventListener('online', () => {
        isOnline = true;
        document.getElementById('offlineIndicator').classList.remove('active');
        showToast('‚úì Connexion r√©tablie', 'success');
        syncOfflineData();
    });
    
    window.addEventListener('offline', () => {
        isOnline = false;
        document.getElementById('offlineIndicator').classList.add('active');
        showToast('üì° Mode hors ligne activ√©', 'warning');
    });
    
    if (!isOnline) {
        document.getElementById('offlineIndicator').classList.add('active');
    }
}

function syncOfflineData() {
    if (syncQueue.length > 0 && CONFIG.ENABLE_CLOUD_SYNC) {
        document.getElementById('syncIndicator').classList.add('active');
        
        setTimeout(() => {
            syncQueue = [];
            document.getElementById('syncIndicator').classList.remove('active');
            showToast('‚úì Synchronisation termin√©e', 'success');
        }, 2000);
    }
}
// ========== PHOTO ANNOTATION SYSTEM ==========
function openAnnotationModal(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    const photo = photoArray[index];
    
    currentAnnotationPhoto = { type, index };
    annotations = photo.annotations || [];
    
    const modal = document.getElementById('annotationModal');
    const img = document.getElementById('annotation-image');
    const canvas = document.getElementById('annotation-canvas');
    
    img.src = photo.src;
    
    img.onload = () => {
        const container = document.getElementById('annotation-container');
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.style.width = img.offsetWidth + 'px';
        canvas.style.height = img.offsetHeight + 'px';
        
        annotationCanvas = canvas;
        annotationCtx = canvas.getContext('2d');
        
        // Redraw existing annotations
        redrawAnnotations();
        
        setupAnnotationListeners();
    };
    
    modal.classList.add('active');
    selectAnnotationTool('measure'); // Default to measure tool
}

function selectAnnotationTool(tool) {
    currentAnnotationType = tool;
    
    document.querySelectorAll('.annotation-tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const toolBtn = document.getElementById(`tool-${tool}`);
    if (toolBtn) toolBtn.classList.add('active');
}

function setupAnnotationListeners() {
    const canvas = annotationCanvas;
    
    // Remove old listeners
    canvas.removeEventListener('mousedown', startAnnotation);
    canvas.removeEventListener('mousemove', drawAnnotation);
    canvas.removeEventListener('mouseup', endAnnotation);
    canvas.removeEventListener('touchstart', startAnnotation);
    canvas.removeEventListener('touchmove', drawAnnotation);
    canvas.removeEventListener('touchend', endAnnotation);
    
    // Add listeners
    canvas.addEventListener('mousedown', startAnnotation);
    canvas.addEventListener('mousemove', drawAnnotation);
    canvas.addEventListener('mouseup', endAnnotation);
    canvas.addEventListener('touchstart', startAnnotation, { passive: false });
    canvas.addEventListener('touchmove', drawAnnotation, { passive: false });
    canvas.addEventListener('touchend', endAnnotation);
}

function getAnnotationPos(e) {
    const canvas = annotationCanvas;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
    };
}

function startAnnotation(e) {
    e.preventDefault();
    isAnnotating = true;
    annotationStartPos = getAnnotationPos(e);
    currentAnnotationColor = document.getElementById('annotation-color').value;
}

function drawAnnotation(e) {
    if (!isAnnotating) return;
    e.preventDefault();
    
    const pos = getAnnotationPos(e);
    const ctx = annotationCtx;
    
    // Redraw canvas
    redrawAnnotations();
    
    ctx.strokeStyle = currentAnnotationColor;
    ctx.fillStyle = currentAnnotationColor;
    ctx.lineWidth = CONFIG.ANNOTATION_LINE_WIDTH;
    ctx.font = `bold ${CONFIG.ANNOTATION_FONT_SIZE}px "Darker Grotesque"`;
    
    switch (currentAnnotationType) {
        case 'line':
            ctx.beginPath();
            ctx.moveTo(annotationStartPos.x, annotationStartPos.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            break;
            
        case 'arrow':
            drawArrow(ctx, annotationStartPos.x, annotationStartPos.y, pos.x, pos.y);
            break;
            
        case 'measure':
            // Draw line
            ctx.beginPath();
            ctx.moveTo(annotationStartPos.x, annotationStartPos.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            // Draw endpoints
            ctx.beginPath();
            ctx.arc(annotationStartPos.x, annotationStartPos.y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw measurement text
            const measureValue = document.getElementById('measure-value').value || '?';
            const midX = (annotationStartPos.x + pos.x) / 2;
            const midY = (annotationStartPos.y + pos.y) / 2;
            
            // Background for text
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            const textWidth = ctx.measureText(measureValue).width;
            ctx.fillRect(midX - textWidth / 2 - 8, midY - CONFIG.ANNOTATION_FONT_SIZE - 4, 
                        textWidth + 16, CONFIG.ANNOTATION_FONT_SIZE + 8);
            
            // Text
            ctx.fillStyle = currentAnnotationColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(measureValue, midX, midY);
            break;
    }
}

function endAnnotation(e) {
    if (!isAnnotating) return;
    e.preventDefault();
    
    const pos = getAnnotationPos(e);
    const measureValue = document.getElementById('measure-value').value || '';
    
    const annotation = {
        type: currentAnnotationType,
        start: annotationStartPos,
        end: pos,
        color: currentAnnotationColor,
        measure: measureValue
    };
    
    annotations.push(annotation);
    isAnnotating = false;
    
    redrawAnnotations();
}

function drawArrow(ctx, x1, y1, x2, y2) {
    const headLength = 15;
    const angle = Math.atan2(y2 - y1, x2 - x1);
    
    // Line
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    // Arrow head
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), 
               y2 - headLength * Math.sin(angle - Math.PI / 6));
    ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), 
               y2 - headLength * Math.sin(angle + Math.PI / 6));
    ctx.closePath();
    ctx.fill();
}

function redrawAnnotations() {
    const ctx = annotationCtx;
    ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
    
    annotations.forEach(ann => {
        ctx.strokeStyle = ann.color;
        ctx.fillStyle = ann.color;
        ctx.lineWidth = CONFIG.ANNOTATION_LINE_WIDTH;
        ctx.font = `bold ${CONFIG.ANNOTATION_FONT_SIZE}px "Darker Grotesque"`;
        
        switch (ann.type) {
            case 'line':
                ctx.beginPath();
                ctx.moveTo(ann.start.x, ann.start.y);
                ctx.lineTo(ann.end.x, ann.end.y);
                ctx.stroke();
                break;
                
            case 'arrow':
                drawArrow(ctx, ann.start.x, ann.start.y, ann.end.x, ann.end.y);
                break;
                
            case 'measure':
                // Line
                ctx.beginPath();
                ctx.moveTo(ann.start.x, ann.start.y);
                ctx.lineTo(ann.end.x, ann.end.y);
                ctx.stroke();
                
                // Endpoints
                ctx.beginPath();
                ctx.arc(ann.start.x, ann.start.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(ann.end.x, ann.end.y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Measurement
                const midX = (ann.start.x + ann.end.x) / 2;
                const midY = (ann.start.y + ann.end.y) / 2;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                const textWidth = ctx.measureText(ann.measure).width;
                ctx.fillRect(midX - textWidth / 2 - 8, midY - CONFIG.ANNOTATION_FONT_SIZE - 4, 
                            textWidth + 16, CONFIG.ANNOTATION_FONT_SIZE + 8);
                
                ctx.fillStyle = ann.color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(ann.measure, midX, midY);
                break;
                
            case 'text':
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                const textW = ctx.measureText(ann.measure).width;
                ctx.fillRect(ann.start.x - 8, ann.start.y - CONFIG.ANNOTATION_FONT_SIZE - 4, 
                            textW + 16, CONFIG.ANNOTATION_FONT_SIZE + 8);
                
                ctx.fillStyle = ann.color;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(ann.measure, ann.start.x, ann.start.y - CONFIG.ANNOTATION_FONT_SIZE);
                break;
        }
    });
}

function undoAnnotation() {
    if (annotations.length > 0) {
        annotations.pop();
        redrawAnnotations();
        showToast('Annotation annul√©e', 'info');
    }
}

function clearAnnotations() {
    if (annotations.length > 0) {
        showModal(
            'Effacer toutes les annotations',
            '√ätes-vous s√ªr de vouloir effacer toutes les annotations ?',
            'Effacer',
            () => {
                annotations = [];
                redrawAnnotations();
                showToast('Annotations effac√©es', 'success');
            }
        );
    }
}

function saveAnnotation() {
    if (!currentAnnotationPhoto) return;
    
    const { type, index } = currentAnnotationPhoto;
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    
    // Save annotations to photo object
    photoArray[index].annotations = [...annotations];
    
    // Create composite image with annotations
    const tempCanvas = document.createElement('canvas');
    const img = document.getElementById('annotation-image');
    tempCanvas.width = img.naturalWidth;
    tempCanvas.height = img.naturalHeight;
    
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.drawImage(img, 0, 0);
    
    // Scale and draw annotations
    const scaleX = tempCanvas.width / annotationCanvas.width;
    const scaleY = tempCanvas.height / annotationCanvas.height;
    
    annotations.forEach(ann => {
        tempCtx.strokeStyle = ann.color;
        tempCtx.fillStyle = ann.color;
        tempCtx.lineWidth = CONFIG.ANNOTATION_LINE_WIDTH * Math.max(scaleX, scaleY);
        tempCtx.font = `bold ${CONFIG.ANNOTATION_FONT_SIZE * Math.max(scaleX, scaleY)}px "Darker Grotesque"`;
        
        const startX = ann.start.x * scaleX;
        const startY = ann.start.y * scaleY;
        const endX = ann.end.x * scaleX;
        const endY = ann.end.y * scaleY;
        
        switch (ann.type) {
            case 'line':
                tempCtx.beginPath();
                tempCtx.moveTo(startX, startY);
                tempCtx.lineTo(endX, endY);
                tempCtx.stroke();
                break;
                
            case 'arrow':
                drawArrow(tempCtx, startX, startY, endX, endY);
                break;
                
            case 'measure':
                tempCtx.beginPath();
                tempCtx.moveTo(startX, startY);
                tempCtx.lineTo(endX, endY);
                tempCtx.stroke();
                
                tempCtx.beginPath();
                tempCtx.arc(startX, startY, 6 * Math.max(scaleX, scaleY), 0, Math.PI * 2);
                tempCtx.fill();
                tempCtx.beginPath();
                tempCtx.arc(endX, endY, 6 * Math.max(scaleX, scaleY), 0, Math.PI * 2);
                tempCtx.fill();
                
                const midX = (startX + endX) / 2;
                const midY = (startY + endY) / 2;
                
                tempCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                const textWidth = tempCtx.measureText(ann.measure).width;
                const fontSize = CONFIG.ANNOTATION_FONT_SIZE * Math.max(scaleX, scaleY);
                tempCtx.fillRect(midX - textWidth / 2 - 10, midY - fontSize - 5, 
                                textWidth + 20, fontSize + 10);
                
                tempCtx.fillStyle = ann.color;
                tempCtx.textAlign = 'center';
                tempCtx.textBaseline = 'middle';
                tempCtx.fillText(ann.measure, midX, midY);
                break;
        }
    });
    
    // Update photo with annotated version
    photoArray[index].src = tempCanvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
    photoArray[index].compressedSize = Math.round((photoArray[index].src.length * 3) / 4);
    
    renderGalleries();
    closeAnnotationModal();
    showToast(`‚úì Photo annot√©e avec ${annotations.length} mesure(s)`, 'success');
    hasUnsavedChanges = true;
}

function closeAnnotationModal() {
    document.getElementById('annotationModal').classList.remove('active');
    currentAnnotationPhoto = null;
    annotations = [];
    isAnnotating = false;
}
// ========== PHOTO MANAGEMENT ==========
let photosProcessed = 0;
let photosTotal = 0;

function handlePhotos(input, type) {
    const files = Array.from(input.files);
    photosTotal = files.length;
    photosProcessed = 0;
    
    if (files.length === 0) return;
    
    showToast(`üì∏ Traitement de ${files.length} photo(s)...`, 'info');
    
    files.forEach(file => {
        compressImage(file, (compressedDataUrl, originalSize, compressedSize) => {
            const imgObj = {
                src: compressedDataUrl,
                note: "",
                originalSize: originalSize,
                compressedSize: compressedSize,
                rotation: 0,
                annotations: []
            };
            
            if (type === 'before') {
                photosBefore.push(imgObj);
            } else if (type === 'during') {
                photosDuring.push(imgObj);
            } else {
                photosAfter.push(imgObj);
            }
            
            photosProcessed++;
            if (photosProcessed === photosTotal) {
                renderGalleries();
                showToast(`‚úì ${photosTotal} photo(s) ajout√©e(s)`, 'success');
                hasUnsavedChanges = true;
            }
        });
    });
    
    input.value = '';
}

function compressImage(file, callback) {
    const reader = new FileReader();
    const originalSize = file.size;
    
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Resize if too large
            if (width > CONFIG.MAX_IMAGE_SIZE || height > CONFIG.MAX_IMAGE_SIZE) {
                if (width > height) {
                    height = Math.round((height * CONFIG.MAX_IMAGE_SIZE) / width);
                    width = CONFIG.MAX_IMAGE_SIZE;
                } else {
                    width = Math.round((width * CONFIG.MAX_IMAGE_SIZE) / height);
                    height = CONFIG.MAX_IMAGE_SIZE;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Add watermark
            ctx.font = 'bold 14px "Darker Grotesque"';
            ctx.fillStyle = 'rgba(212, 175, 55, 0.8)';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
            ctx.shadowBlur = 4;
            ctx.fillText(`Vertex Monaco - ${new Date().toLocaleDateString('fr-FR')}`, 15, height - 15);
            
            const compressedDataUrl = canvas.toDataURL('image/jpeg', CONFIG.IMAGE_QUALITY);
            const compressedSize = Math.round((compressedDataUrl.length * 3) / 4);
            
            callback(compressedDataUrl, originalSize, compressedSize);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function renderGalleries() {
    renderGallery('before', photosBefore);
    renderGallery('during', photosDuring);
    renderGallery('after', photosAfter);
}

function renderGallery(type, photos) {
    const container = document.getElementById(`gallery-${type}`);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (photos.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666; padding:20px 0; font-size:13px;">Aucune photo</p>';
        return;
    }
    
    photos.forEach((p, i) => {
        const sizeInfo = `${(p.compressedSize / 1024).toFixed(1)} KB`;
        const hasAnnotations = p.annotations && p.annotations.length > 0;
        
        container.innerHTML += `
            <div class="photo-card">
                <img src="${escapeHtml(p.src)}" 
                     style="transform: rotate(${p.rotation}deg);"
                     onclick="openImageModal('${type}', ${i})"
                     alt="Photo ${type}">
                <div class="photo-size">
                    üì¶ ${sizeInfo} 
                    ${hasAnnotations ? `| ‚úèÔ∏è ${p.annotations.length} annotation(s)` : ''}
                </div>
                <input type="text" class="photo-input" placeholder="L√©gende ou description..." 
                       oninput="photos${type.charAt(0).toUpperCase() + type.slice(1)}[${i}].note=this.value" 
                       value="${escapeHtml(p.note)}">
                <div class="photo-controls">
                    <button onclick="rotatePhoto('${type}', ${i})">üîÑ Rotation</button>
                    <button onclick="openAnnotationModal('${type}', ${i})" style="border-color:var(--gold); color:var(--gold);">
                        ‚úèÔ∏è Annoter
                    </button>
                    <button onclick="removePhoto('${type}', ${i})" style="border-color:var(--danger); color:var(--danger);">
                        üóëÔ∏è Suppr.
                    </button>
                </div>
            </div>
        `;
    });
}

function rotatePhoto(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    photoArray[index].rotation = (photoArray[index].rotation + 90) % 360;
    renderGalleries();
    hasUnsavedChanges = true;
}

function removePhoto(type, index) {
    showModal(
        'Supprimer la photo',
        '√ätes-vous s√ªr de vouloir supprimer cette photo ?',
        'Supprimer',
        () => {
            if (type === 'before') photosBefore.splice(index, 1);
            else if (type === 'during') photosDuring.splice(index, 1);
            else photosAfter.splice(index, 1);
            
            renderGalleries();
            showToast('‚úì Photo supprim√©e', 'success');
            hasUnsavedChanges = true;
        }
    );
}

function openImageModal(type, index) {
    const photoArray = type === 'before' ? photosBefore : type === 'during' ? photosDuring : photosAfter;
    document.getElementById('modalImage').src = photoArray[index].src;
    document.getElementById('imageModal').classList.add('active');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

// ========== SIGNATURE ==========
const canvas = document.getElementById('sig-canvas');
if (canvas) {
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        tempCtx.drawImage(canvas, 0, 0);
        
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        ctx.drawImage(tempCanvas, 0, 0);
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDrawing(e) {
        drawing = true;
        const p = getPos(e);
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        e.preventDefault();
    }

    function draw(e) {
        if (!drawing) return;
        const p = getPos(e);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        e.preventDefault();
    }

    function stopDrawing() {
        drawing = false;
    }

    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);

    window.resizeCanvas = resizeCanvas;
}

function clearSig() {
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    showToast('‚úì Signature effac√©e', 'success');
}

function isCanvasBlank(canvas) {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
}
// ========== TOAST & MODALS ==========
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'toastSlide 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showModal(title, body, confirmText, callback, modalId = 'confirmModal') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').textContent = body;
    document.getElementById('modalConfirm').textContent = confirmText;
    modalCallback = callback;
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId = 'confirmModal') {
    document.getElementById(modalId).classList.remove('active');
    modalCallback = null;
}

function modalConfirmAction() {
    if (modalCallback) modalCallback();
    closeModal();
}

// ========== NAVIGATION ==========
function nextStep(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
    
    if (n === 4) {
        setTimeout(resizeCanvas, 200);
        loadChecklist();
    }
    if (n === 1) {
        document.getElementById('c-name').textContent = cur;
        resetForm();
        hasUnsavedChanges = true;
    }
    if (n === 5) {
        document.getElementById('view-n').textContent = cur;
        showTimeline();
        hasUnsavedChanges = false;
    }
    if (n === 0) {
        hasUnsavedChanges = false;
        switchTab(currentFilter);
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function confirmCancel() {
    if (hasUnsavedChanges) {
        showModal(
            'Annuler la mission',
            'Les donn√©es non enregistr√©es seront perdues. Continuer ?',
            'Oui, annuler',
            () => nextStep(0)
        );
    } else {
        nextStep(0);
    }
}

function setupBeforeUnload() {
    window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });
}

function checkStorageSpace() {
    if (navigator.storage && navigator.storage.estimate) {
        navigator.storage.estimate().then(estimate => {
            const percentUsed = estimate.usage / estimate.quota;
            if (percentUsed > 0.8) {
                showToast(`‚ö†Ô∏è Stockage √† ${Math.round(percentUsed * 100)}% - Pensez √† exporter !`, 'warning');
            }
        });
    }
}

// ========== TABS & VIEWS ==========
function switchTab(tab) {
    currentFilter = tab;
    currentView = tab;
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    if (tab === 'ongoing' || tab === 'done') {
        document.getElementById('tab-active').classList.toggle('active', tab === 'ongoing');
        document.getElementById('tab-archived').classList.toggle('active', tab === 'done');
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-analytics').style.display = 'none';
        document.getElementById('view-quotes').style.display = 'none';
        loadList();
    } else if (tab === 'analytics') {
        document.getElementById('tab-analytics').classList.add('active');
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-analytics').style.display = 'block';
        document.getElementById('view-quotes').style.display = 'none';
        loadAnalytics();
    } else if (tab === 'quotes') {
        document.getElementById('tab-quotes').classList.add('active');
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-analytics').style.display = 'none';
        document.getElementById('view-quotes').style.display = 'block';
        loadQuotes();
    }
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advancedFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// ========== STEP 1: MISSION INFO ==========
function setTime(id) {
    const n = new Date();
    document.getElementById(id).value = n.getHours().toString().padStart(2, '0') + ':' + 
                                        n.getMinutes().toString().padStart(2, '0');
    showToast('‚è∞ Heure actuelle enregistr√©e', 'info');
}

function selectType(el, type) {
    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedType = type;
}

function toggleStaff(el) {
    el.classList.toggle('selected');
    staff = Array.from(document.querySelectorAll('.staff-chip.selected')).map(c => c.textContent);
}

function requestGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                gpsCoords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                const gpsInfo = document.getElementById('gps-info');
                if (gpsInfo) {
                    gpsInfo.textContent = `üìç Position GPS enregistr√©e (${gpsCoords.lat.toFixed(5)}, ${gpsCoords.lng.toFixed(5)})`;
                }
            },
            () => {
                console.log('GPS non disponible');
            }
        );
    }
}

function validateStep1() {
    if (!selectedType) {
        showToast('‚ö†Ô∏è Veuillez s√©lectionner un type de mission', 'error');
        return;
    }
    if (staff.length === 0) {
        showToast('‚ö†Ô∏è Veuillez s√©lectionner au moins un membre de l\'√©quipe', 'error');
        return;
    }
    if (!document.getElementById('time_in').value) {
        showToast('‚ö†Ô∏è Veuillez indiquer l\'heure d\'arriv√©e', 'error');
        return;
    }
    nextStep(2);
}

function validateStep2() {
    nextStep(3);
}

function validateStep3() {
    const taskDone = document.getElementById('task_done').value.trim();
    if (!taskDone) {
        showToast('‚ö†Ô∏è Veuillez remplir le compte-rendu des travaux', 'error');
        return;
    }
    nextStep(4);
}

// ========== TEMPLATES ==========
function showTemplates() {
    const list = document.getElementById('templates-list');
    list.innerHTML = '';
    
    Object.entries(TEMPLATES).forEach(([id, template]) => {
        list.innerHTML += `
            <div class="template-card" onclick="loadTemplate('${id}')">
                <h4>${escapeHtml(template.name)}</h4>
                <p>Type: ${escapeHtml(template.type)}</p>
            </div>
        `;
    });
    
    document.getElementById('templatesModal').classList.add('active');
}

function loadTemplate(id) {
    const template = TEMPLATES[id];
    
    selectedType = template.type;
    document.querySelectorAll('.type-chip').forEach(chip => {
        if (chip.textContent === template.type) {
            chip.classList.add('selected');
        } else {
            chip.classList.remove('selected');
        }
    });
    
    document.getElementById('task_done').value = template.taskTemplate;
    
    closeModal('templatesModal');
    showToast('‚úì Template charg√©', 'success');
}

function loadChecklist() {
    const container = document.getElementById('checklist-container');
    const template = Object.values(TEMPLATES).find(t => t.type === selectedType);
    const checklist = template ? template.checklist : [
        'Chantier nettoy√© / Propret√©',
        'Tests de diffusion OK',
        'Alimentation & Baie verrouill√©es',
        'Client pr√©venu du d√©part'
    ];
    
    container.innerHTML = '';
    checklist.forEach((item, i) => {
        container.innerHTML += `
            <div class="check-item">
                <input type="checkbox" id="check${i}">
                <label for="check${i}">${escapeHtml(item)}</label>
            </div>
        `;
    });
}

// ========== PROJECT MANAGEMENT ==========
function showNewProjectOptions() {
    const name = prompt('üìÅ Nom du client :');
    if (!name) return;
    
    const trimmed = name.trim();
    if (!trimmed) {
        showToast('‚ö†Ô∏è Le nom ne peut pas √™tre vide', 'error');
        return;
    }
    
    startNewProjectWithName(trimmed);
}

function startNewProjectWithName(name) {
    if (db[name]) {
        showToast('‚ö†Ô∏è Ce client existe d√©j√†', 'error');
        return;
    }
    
    db[name] = {
        entries: [],
        quotes: [],
        status: 'ongoing',
        created: new Date().toISOString()
    };
    
    saveToIndexedDB();
    loadList();
    showToast('‚úì Nouveau client cr√©√©', 'success');
}

// ========== WEATHER ==========
async function getWeather() {
    if (!gpsCoords) return;
    
    // Simulated weather - replace with real API call
    setTimeout(() => {
        const widget = document.getElementById('weather-widget');
        if (widget) {
            widget.style.display = 'flex';
            widget.querySelector('.weather-temp').textContent = '18¬∞C';
            widget.querySelector('.weather-desc').textContent = 'Partiellement nuageux';
        }
    }, 1000);
}

// ========== SAVE ENTRY ==========
function saveEntry() {
    // Validation
    if (!selectedType || !staff.length) {
        showToast('‚ö†Ô∏è Type et √âquipe requis !', 'error');
        return;
    }
    
    if (!document.getElementById('time_out').value) {
        showToast('‚ö†Ô∏è Veuillez indiquer l\'heure de d√©part', 'error');
        return;
    }
    
    const checks = Array.from(document.querySelectorAll('#checklist-container input[type="checkbox"]'));
    if (!checks.every(c => c.checked)) {
        showToast('‚ö†Ô∏è Veuillez valider tous les points de la checklist', 'error');
        return;
    }
    
    const canvas = document.getElementById('sig-canvas');
    if (isCanvasBlank(canvas)) {
        showToast('‚ö†Ô∏è Veuillez faire signer le client', 'error');
        return;
    }
    
    // Show loading
    document.getElementById('save-spinner').style.display = 'block';
    document.getElementById('btn-save').disabled = true;
    
    setTimeout(async () => {
        try {
            const entry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('fr-FR'),
                timestamp: new Date().toISOString(),
                type: selectedType,
                in: document.getElementById('time_in').value,
                out: document.getElementById('time_out').value,
                staff: staff.join(', '),
                context: document.getElementById('client_context')?.value || '',
                done: document.getElementById('task_done').value,
                mat: document.getElementById('task_mat').value,
                parts: document.getElementById('task_parts').value || '',
                recommendations: document.getElementById('task_recommendations')?.value || '',
                before: [...photosBefore],
                during: [...photosDuring],
                after: [...photosAfter],
                sig: canvas.toDataURL('image/png', 0.5),
                gps: gpsCoords ? { lat: gpsCoords.lat, lng: gpsCoords.lng } : null
            };
            
            db[cur].entries.push(entry);
            await saveToIndexedDB();
            
            document.getElementById('save-spinner').style.display = 'none';
            document.getElementById('btn-save').disabled = false;
            
            showToast('‚úÖ Mission enregistr√©e avec succ√®s !', 'success');
            nextStep(5);
        } catch (e) {
            document.getElementById('save-spinner').style.display = 'none';
            document.getElementById('btn-save').disabled = false;
            showToast('‚ùå Erreur lors de l\'enregistrement', 'error');
            console.error(e);
        }
    }, 500);
}

// ========== RESET FORM ==========
function resetForm() {
    staff = [];
    photosBefore = [];
    photosDuring = [];
    photosAfter = [];
    selectedType = '';
    
    document.querySelectorAll('.type-chip, .staff-chip').forEach(c => c.classList.remove('selected'));
    document.getElementById('task_done').value = '';
    document.getElementById('task_mat').value = '';
    document.getElementById('task_parts').value = '';
    if (document.getElementById('task_recommendations')) {
        document.getElementById('task_recommendations').value = '';
    }
    if (document.getElementById('client_context')) {
        document.getElementById('client_context').value = '';
    }
    document.getElementById('time_in').value = '';
    document.getElementById('time_out').value = '';
    
    renderGalleries();
    clearSig();
}
// ========== PROJECT VIEW & TIMELINE ==========
function showTimeline() {
    const t = document.getElementById('timeline');
    t.innerHTML = '';
    
    const isDone = db[cur].status === 'done';
    document.getElementById('status-toggle-container').innerHTML = `
        <button class="status-pill ${isDone ? 'status-done' : 'status-ongoing'}" 
                onclick="toggleStatus()">
            ${isDone ? 'üì¶ ARCHIV√â' : '‚úÖ ACTIF'}
        </button>
    `;
    
    const entries = db[cur].entries;
    document.getElementById('project-interventions').textContent = entries.length;
    
    const quotes = db[cur].quotes || [];
    document.getElementById('project-quotes').textContent = quotes.length;
    
    // Calculate total time
    let totalMinutes = 0;
    entries.forEach(e => {
        if (e.in && e.out) {
            const [inH, inM] = e.in.split(':').map(Number);
            const [outH, outM] = e.out.split(':').map(Number);
            const minutes = (outH * 60 + outM) - (inH * 60 + inM);
            if (minutes > 0) totalMinutes += minutes;
        }
    });
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('project-hours').textContent = `${hours}h${minutes > 0 ? minutes.toString().padStart(2, '0') : ''}`;
    
    // Display entries in reverse chronological order
    [...entries].reverse().forEach(e => {
        const gpsInfo = e.gps ? `üìç ${e.gps.lat.toFixed(5)}, ${e.gps.lng.toFixed(5)}` : '';
        const duration = calculateDuration(e.in, e.out);
        
        t.innerHTML += `
            <div class="timeline-item">
                <div style="font-size:11px; font-weight:900; color:var(--gold); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.05em;">
                    ${escapeHtml(e.date)} | ${escapeHtml(e.type)}
                </div>
                <div class="section-block">
                    <strong>√âquipe:</strong> ${escapeHtml(e.staff)}<br>
                    <strong>Horaires:</strong> ${escapeHtml(e.in)} ‚Üí ${escapeHtml(e.out)} ${duration ? `(${duration})` : ''}
                    ${gpsInfo ? `<br><span style="font-size:10px; color:#888; font-family: 'Space Mono', monospace;">${gpsInfo}</span>` : ''}
                </div>
                ${e.context ? `<div class="client-notes">
                    <div class="client-notes-header">üìù Contexte</div>
                    ${escapeHtml(e.context)}
                </div>` : ''}
                <div class="section-block">
                    <strong>Travaux r√©alis√©s:</strong><br>
                    ${escapeHtml(e.done).replace(/\n/g, '<br>')}
                </div>
                ${e.mat ? `<div class="section-block" style="border-left-color:var(--success)">
                    <strong>Mat√©riel/SAV:</strong><br>
                    ${escapeHtml(e.mat).replace(/\n/g, '<br>')}
                </div>` : ''}
                ${e.parts ? `<div class="section-block" style="border-left-color:var(--info)">
                    <strong>Pi√®ces d√©tach√©es:</strong><br>
                    ${escapeHtml(e.parts).replace(/\n/g, '<br>')}
                </div>` : ''}
                ${e.recommendations ? `<div class="section-block" style="border-left-color:var(--warning)">
                    <strong>Recommandations:</strong><br>
                    ${escapeHtml(e.recommendations).replace(/\n/g, '<br>')}
                </div>` : ''}
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:15px 0;">
                    <div>
                        <div style="font-size:10px; font-weight:700; color:#e67e22; margin-bottom:5px; text-transform:uppercase;">AVANT (${e.before.length})</div>
                        ${e.before.map(p => renderPhotoInTimeline(p, '#e67e22')).join('')}
                    </div>
                    <div>
                        <div style="font-size:10px; font-weight:700; color:#3498db; margin-bottom:5px; text-transform:uppercase;">PENDANT (${(e.during || []).length})</div>
                        ${(e.during || []).map(p => renderPhotoInTimeline(p, '#3498db')).join('')}
                    </div>
                    <div>
                        <div style="font-size:10px; font-weight:700; color:#2ecc71; margin-bottom:5px; text-transform:uppercase;">APR√àS (${e.after.length})</div>
                        ${e.after.map(p => renderPhotoInTimeline(p, '#2ecc71')).join('')}
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                    <img src="${escapeHtml(e.sig)}" 
                         style="width:140px; background:white; border-radius:6px; padding:5px; border:2px solid #ddd;">
                    <button class="no-print" 
                            style="color:var(--danger); border:1px solid var(--danger); background:rgba(255,77,77,0.1); font-size:11px; cursor:pointer; padding:8px 12px; border-radius:6px; font-weight:700;" 
                            onclick="confirmDeleteEntry(${e.id})">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        `;
    });
    
    if (entries.length === 0) {
        t.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0;">Aucune intervention enregistr√©e</p>';
    }
}

function calculateDuration(timeIn, timeOut) {
    if (!timeIn || !timeOut) return '';
    const [inH, inM] = timeIn.split(':').map(Number);
    const [outH, outM] = timeOut.split(':').map(Number);
    const minutes = (outH * 60 + outM) - (inH * 60 + inM);
    if (minutes <= 0) return '';
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h}h${m > 0 ? m.toString().padStart(2, '0') : ''}`;
}

function renderPhotoInTimeline(photo, borderColor) {
    const hasAnnotations = photo.annotations && photo.annotations.length > 0;
    return `
        <img src="${escapeHtml(photo.src)}" 
             style="width:100%; border:2px solid ${borderColor}; border-radius:6px; margin-bottom:8px; transform: rotate(${photo.rotation || 0}deg); cursor:pointer;"
             onclick="openImageModal('', 0)" alt="Photo intervention">
        ${hasAnnotations ? `<div style="font-size:9px; color:${borderColor}; margin-bottom:5px;">‚úèÔ∏è ${photo.annotations.length} mesure(s)</div>` : ''}
        ${photo.note ? `<div style="font-size:10px; color:#888; margin-bottom:10px; font-weight:600;">${escapeHtml(photo.note)}</div>` : ''}
    `;
}

function confirmDeleteEntry(id) {
    showModal(
        'Supprimer l\'intervention',
        'Cette action est irr√©versible. Continuer ?',
        'Supprimer',
        () => deleteEntry(id)
    );
}

function deleteEntry(id) {
    db[cur].entries = db[cur].entries.filter(e => e.id !== id);
    saveToIndexedDB();
    showTimeline();
    updateStats();
    showToast('‚úì Intervention supprim√©e', 'success');
}

function newIntervention() {
    nextStep(1);
}

function duplicateLastIntervention() {
    const last = db[cur].entries[db[cur].entries.length - 1];
    if (!last) {
        showToast('‚ö†Ô∏è Aucune intervention √† dupliquer', 'warning');
        return;
    }
    
    selectedType = last.type;
    staff = last.staff.split(', ');
    document.getElementById('task_done').value = last.done;
    document.getElementById('task_mat').value = last.mat || '';
    
    document.querySelectorAll('.type-chip').forEach(chip => {
        if (chip.textContent === last.type) {
            chip.classList.add('selected');
        }
    });
    
    document.querySelectorAll('.staff-chip').forEach(chip => {
        if (staff.includes(chip.textContent)) {
            chip.classList.add('selected');
        }
    });
    
    nextStep(1);
    showToast('‚úì Derni√®re intervention dupliqu√©e', 'success');
}

function toggleStatus() {
    db[cur].status = (db[cur].status === 'done' ? 'ongoing' : 'done');
    saveToIndexedDB();
    showTimeline();
    loadList();
    updateStats();
    showToast(`‚úì Client ${db[cur].status === 'done' ? 'archiv√©' : 'r√©activ√©'}`, 'success');
}

function confirmDeleteProject() {
    showModal(
        '‚ö†Ô∏è Supprimer le client',
        `Toutes les interventions pour "${cur}" seront d√©finitivement supprim√©es. Cette action est irr√©versible.`,
        'Supprimer d√©finitivement',
        deleteFullProject
    );
}

function deleteFullProject() {
    delete db[cur];
    saveToIndexedDB();
    updateStats();
    showToast('‚úì Client supprim√©', 'success');
    nextStep(0);
}

// ========== LIST & FILTERS ==========
function filterProjects() {
    const query = document.getElementById('searchBar').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const filterStaff = document.getElementById('filterStaff').value;
    const filterDateFrom = document.getElementById('filterDateFrom').value;
    const filterDateTo = document.getElementById('filterDateTo').value;
    
    loadList(query, filterType, filterStaff, filterDateFrom, filterDateTo);
}

function loadList(query = '', filterType = '', filterStaff = '', dateFrom = '', dateTo = '') {
    const list = document.getElementById('project-list');
    list.innerHTML = '';
    
    const projects = Object.keys(db)
        .filter(key => key !== '_version')
        .sort((a, b) => {
            const aDate = db[a].entries.length > 0 ? new Date(db[a].entries[db[a].entries.length - 1].timestamp) : new Date(db[a].created);
            const bDate = db[b].entries.length > 0 ? new Date(db[b].entries[db[b].entries.length - 1].timestamp) : new Date(db[b].created);
            return bDate - aDate;
        });
    
    let displayedCount = 0;
    
    projects.forEach(id => {
        const project = db[id];
        
        if (project.status !== currentFilter) return;
        if (query && !id.toLowerCase().includes(query)) return;
        
        if (filterType || filterStaff || dateFrom || dateTo) {
            const matchesFilters = project.entries.some(e => {
                const typeMatch = !filterType || e.type === filterType;
                const staffMatch = !filterStaff || e.staff.includes(filterStaff);
                
                let dateMatch = true;
                if (dateFrom || dateTo) {
                    const entryDate = new Date(e.timestamp || e.date);
                    if (dateFrom) dateMatch = dateMatch && entryDate >= new Date(dateFrom);
                    if (dateTo) dateMatch = dateMatch && entryDate <= new Date(dateTo);
                }
                
                return typeMatch && staffMatch && dateMatch;
            });
            
            if (!matchesFilters) return;
        }
        
        const lastEntry = project.entries[project.entries.length - 1];
        const lastDate = lastEntry ? lastEntry.date : 'Aucune intervention';
        const entryCount = project.entries.length;
        
        list.innerHTML += `
            <div class="folder-card" onclick="cur='${escapeHtml(id)}';nextStep(5);">
                <div class="folder-info">
                    <div class="folder-name">${escapeHtml(id)}</div>
                    <div class="folder-meta">
                        ${entryCount} intervention${entryCount > 1 ? 's' : ''} ‚Ä¢ Derni√®re: ${escapeHtml(lastDate)}
                    </div>
                </div>
                <div class="folder-arrow">‚ùØ</div>
            </div>
        `;
        displayedCount++;
    });
    
    if (displayedCount === 0) {
        list.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0; font-size:14px;">Aucun dossier trouv√©</p>';
    }
}

// ========== STATS ==========
function updateStats() {
    let activeCount = 0;
    let totalInterventions = 0;
    let totalMinutes = 0;
    let thisMonth = 0;
    
    const now = new Date();
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    Object.keys(db).forEach(key => {
        if (key === '_version') return;
        const project = db[key];
        
        if (project.status === 'ongoing') activeCount++;
        totalInterventions += project.entries.length;
        
        project.entries.forEach(e => {
            if (e.in && e.out) {
                const [inH, inM] = e.in.split(':').map(Number);
                const [outH, outM] = e.out.split(':').map(Number);
                const minutes = (outH * 60 + outM) - (inH * 60 + inM);
                if (minutes > 0) totalMinutes += minutes;
            }
            
            const entryDate = new Date(e.timestamp || e.date);
            if (entryDate >= thisMonthStart) thisMonth++;
        });
    });
    
    document.getElementById('stat-active').textContent = activeCount;
    document.getElementById('stat-total').textContent = totalInterventions;
    
    const hours = Math.floor(totalMinutes / 60);
    document.getElementById('stat-hours').textContent = `${hours}h`;
    document.getElementById('stat-month').textContent = thisMonth;
}

// ========== ANALYTICS ==========
function loadAnalytics() {
    const typeCount = {};
    const staffCount = {};
    const monthCount = {};
    let totalDuration = 0;
    let entryCount = 0;
    const clientCount = {};
    
    Object.keys(db).forEach(key => {
        if (key === '_version') return;
        
        db[key].entries.forEach(e => {
            typeCount[e.type] = (typeCount[e.type] || 0) + 1;
            
            e.staff.split(', ').forEach(s => {
                staffCount[s.trim()] = (staffCount[s.trim()] || 0) + 1;
            });
            
            const month = new Date(e.timestamp || e.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'short' });
            monthCount[month] = (monthCount[month] || 0) + 1;
            
            if (e.in && e.out) {
                const [inH, inM] = e.in.split(':').map(Number);
                const [outH, outM] = e.out.split(':').map(Number);
                const minutes = (outH * 60 + outM) - (inH * 60 + inM);
                if (minutes > 0) {
                    totalDuration += minutes;
                    entryCount++;
                }
            }
            
            clientCount[key] = (clientCount[key] || 0) + 1;
        });
    });
    
    renderChart('chart-by-type', typeCount);
    renderChart('chart-by-staff', staffCount);
    renderChart('chart-by-month', monthCount);
    
    const avgMinutes = entryCount > 0 ? Math.round(totalDuration / entryCount) : 0;
    const avgHours = Math.floor(avgMinutes / 60);
    const avgMins = avgMinutes % 60;
    document.getElementById('avg-duration').textContent = `${avgHours}h${avgMins > 0 ? avgMins.toString().padStart(2, '0') : ''}`;
    
    const topClient = Object.entries(clientCount).sort((a, b) => b[1] - a[1])[0];
    document.getElementById('top-client').textContent = topClient ? topClient[0].substring(0, 15) + (topClient[0].length > 15 ? '...' : '') : '-';
}

function renderChart(containerId, data) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (Object.keys(data).length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666; padding:20px 0;">Aucune donn√©e</p>';
        return;
    }
    
    const max = Math.max(...Object.values(data));
    
    Object.entries(data)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .forEach(([label, value]) => {
            const percent = (value / max) * 100;
            container.innerHTML += `
                <div class="chart-bar-label">${escapeHtml(label)}</div>
                <div class="chart-bar">
                    <div class="chart-bar-fill" style="width: ${percent}%;">
                        ${value}
                    </div>
                </div>
            `;
        });
}

// ========== QUOTES (placeholder) ==========
function loadQuotes() {
    const list = document.getElementById('quotes-list');
    list.innerHTML = '<p style="text-align:center; color:#666; padding:40px 0;">Fonctionnalit√© devis √† venir...</p>';
}

function newQuote() {
    showToast('üìä Fonctionnalit√© devis √† venir', 'info');
}

function newProjectQuote() {
    showToast('üìä Cr√©ation de devis √† venir', 'info');
}

// ========== EXPORT ==========
function exportToCSV() {
    let csv = '\uFEFFClient;Date;Type;Equipe;Arrivee;Depart;Duree;Travaux;Materiel;Pieces;GPS_Lat;GPS_Lng\n';
    
    Object.keys(db).forEach(client => {
        if (client === '_version') return;
        
        db[client].entries.forEach(e => {
            const gpsLat = e.gps ? e.gps.lat : '';
            const gpsLng = e.gps ? e.gps.lng : '';
            const duration = calculateDuration(e.in, e.out);
            csv += `"${escapeCSV(client)}";`;
            csv += `"${escapeCSV(e.date)}";`;
            csv += `"${escapeCSV(e.type)}";`;
            csv += `"${escapeCSV(e.staff)}";`;
            csv += `"${escapeCSV(e.in)}";`;
            csv += `"${escapeCSV(e.out)}";`;
            csv += `"${escapeCSV(duration)}";`;
            csv += `"${escapeCSV(e.done)}";`;
            csv += `"${escapeCSV(e.mat)}";`;
            csv += `"${escapeCSV(e.parts || '')}";`;
            csv += `"${escapeCSV(gpsLat)}";`;
            csv += `"${escapeCSV(gpsLng)}"\n`;
        });
    });
    
    downloadFile(csv, `Vertex_Export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
    showToast('‚úÖ Export CSV g√©n√©r√©', 'success');
}

function exportBackup() {
    const backup = {
        version: CONFIG.DB_VERSION,
        appVersion: '15.0',
        exportDate: new Date().toISOString(),
        data: db
    };
    
    const json = JSON.stringify(backup, null, 2);
    downloadFile(json, `Vertex_Backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    showToast('‚úÖ Sauvegarde compl√®te g√©n√©r√©e', 'success');
}

function importBackup(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.data || !backup.version) {
                throw new Error('Format invalide');
            }
            
            showModal(
                'Restaurer les donn√©es',
                `Cette action remplacera toutes les donn√©es actuelles. ${Object.keys(backup.data).length} projets seront import√©s. Continuer ?`,
                'Restaurer',
                () => {
                    db = backup.data;
                    saveToIndexedDB();
                    loadList();
                    updateStats();
                    showToast('‚úÖ Donn√©es restaur√©es avec succ√®s', 'success');
                }
            );
        } catch (err) {
            showToast('‚ùå Erreur: fichier invalide', 'error');
            console.error(err);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function exportProjectPDF() {
    showToast('üñ®Ô∏è G√©n√©ration PDF...', 'info');
    setTimeout(() => window.print(), 500);
}

function exportPDFReport() {
    showToast('üìÑ Rapport PDF global en cours...', 'info');
    setTimeout(() => window.print(), 500);
}

function exportAnalyticsPDF() {
    showToast('üìä Export statistiques PDF...', 'info');
    setTimeout(() => window.print(), 500);
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename);
    link.click();
}

// ========== SHARING ==========
function sendProjectMail() {
    const entries = db[cur].entries;
    if (!entries.length) return;
    
    const lastEntry = entries[entries.length - 1];
    
    const subject = encodeURIComponent(`Rapport Vertex - ${cur} - ${lastEntry.date}`);
    let body = `CLIENT: ${cur}\n\n`;
    body += `TYPE: ${lastEntry.type}\n`;
    body += `DATE: ${lastEntry.date}\n`;
    body += `√âQUIPE: ${lastEntry.staff}\n`;
    body += `HORAIRES: ${lastEntry.in} - ${lastEntry.out}\n\n`;
    body += `TRAVAUX R√âALIS√âS:\n${lastEntry.done}\n\n`;
    if (lastEntry.mat) body += `MAT√âRIEL/SAV:\n${lastEntry.mat}\n\n`;
    if (lastEntry.parts) body += `PI√àCES:\n${lastEntry.parts}\n\n`;
    if (lastEntry.recommendations) body += `RECOMMANDATIONS:\n${lastEntry.recommendations}\n\n`;
    if (lastEntry.gps) body += `POSITION GPS: ${lastEntry.gps.lat}, ${lastEntry.gps.lng}\n`;
    body += `\n--- Rapport g√©n√©r√© par Vertex Monaco V15 Pro ---`;
    
    window.location.href = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
}

function shareWhatsApp() {
    const entries = db[cur].entries;
    if (!entries.length) return;
    
    const lastEntry = entries[entries.length - 1];
    let text = `*üìã Rapport Vertex - ${cur}*\n\n`;
    text += `üìÖ ${lastEntry.date}\n`;
    text += `üîß ${lastEntry.type}\n`;
    text += `üë• ${lastEntry.staff}\n`;
    text += `‚è∞ ${lastEntry.in} - ${lastEntry.out}\n\n`;
    text += `*Travaux:*\n${lastEntry.done}`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

// ========== UTILITIES ==========
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeCSV(text) {
    if (!text) return '';
    return text.toString().replace(/"/g, '""').replace(/\n/g, ' ');
}

// ========== PWA ==========
function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult => {
            if (choiceResult.outcome === 'accepted') {
                showToast('‚úÖ Application install√©e !', 'success');
            }
            deferredPrompt = null;
            document.getElementById('installPrompt').classList.remove('active');
        });
    }
}

function dismissInstall() {
    document.getElementById('installPrompt').classList.remove('active');
    localStorage.setItem('pwa_dismissed', 'true');
}

// ========== WINDOW RESIZE ==========
window.onresize = () => {
    if (document.getElementById('step4')?.classList.contains('active')) {
        resizeCanvas();
    }
};

// ========== END ==========
console.log('‚úÖ Vertex Monaco V15 Pro charg√© avec succ√®s');
</script>

</body>
</html>
