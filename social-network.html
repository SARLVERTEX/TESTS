<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERTEX Video Generator ULTIMATE v3 | Complete Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-tertiary: rgba(15, 23, 42, 0.6);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-tertiary: #cbd5e1;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent: #FFD700;
            --accent-dark: #B8860B;
            --success: #10b981;
            --error: #ef4444;
            --canvas-bg: #000000;
        }
        
        body.light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-tertiary: rgba(255, 255, 255, 0.8);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --canvas-bg: #ffffff;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
            -webkit-font-smoothing: antialiased;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1920px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .brand {
            color: var(--accent);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            font-size: 0.625rem;
            margin-bottom: 0.25rem;
        }
        
        .title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.75rem;
            font-weight: 900;
            text-transform: uppercase;
            font-style: italic;
            background: linear-gradient(135deg, var(--accent) 0%, var(--text-primary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 0.5rem;
            text-transform: uppercase;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .icon-btn {
            width: 2.25rem;
            height: 2.25rem;
            background: var(--bg-tertiary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .icon-btn:hover:not(:disabled) {
            border-color: var(--accent);
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }
        
        .icon-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .theme-toggle {
            background: var(--bg-tertiary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            padding: 0.25rem;
            display: flex;
            gap: 0.25rem;
        }
        
        .theme-toggle-btn {
            padding: 0.35rem 0.75rem;
            border-radius: 1.5rem;
            font-size: 0.7rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-toggle-btn.active {
            background: var(--accent);
            color: #000;
        }
        
        .workspace {
            display: grid;
            grid-template-columns: 300px 1fr 340px;
            gap: 1rem;
            align-items: start;
        }
        
        @media (max-width: 1400px) {
            .workspace {
                grid-template-columns: 280px 1fr;
            }
            .workspace > :last-child {
                grid-column: 1 / -1;
            }
        }
        
        @media (max-width: 900px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: var(--bg-tertiary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.25rem;
            transition: all 0.3s;
        }
        
        .panel-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .canvas-wrapper {
            position: relative;
            background: var(--canvas-bg);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
        }
        
        .canvas-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .canvas-btn {
            width: 2rem;
            height: 2rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-size: 0.875rem;
        }
        
        .canvas-btn:hover {
            background: rgba(255, 215, 0, 0.9);
            color: black;
        }
        
        .canvas-btn.active {
            background: var(--accent);
            color: black;
        }
        
        #canvasContainer {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            cursor: crosshair;
        }
        
        #canvasContainer.dragging {
            cursor: move;
        }
        
        #previewCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .layers-panel {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .layer-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .layer-item:hover {
            border-color: var(--accent);
        }
        
        .layer-item.selected {
            border-color: var(--accent);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .layer-icon {
            width: 2rem;
            height: 2rem;
            background: var(--bg-tertiary);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }
        
        .layer-info {
            flex: 1;
            min-width: 0;
        }
        
        .layer-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .layer-type {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        
        .layer-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .layer-btn {
            width: 1.5rem;
            height: 1.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75rem;
        }
        
        .layer-btn:hover {
            border-color: var(--accent);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .layer-btn.active {
            background: var(--accent);
            color: black;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .label {
            display: block;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        
        .input, .textarea, .select {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.6rem 0.75rem;
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--bg-secondary);
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }
        
        .slider-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }
        
        .slider-value {
            width: 3rem;
            text-align: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: black;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.7rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Inter', sans-serif;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-tertiary);
            box-shadow: none;
        }
        
        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
        }
        
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        .color-input {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        .color-label {
            font-size: 0.7rem;
            font-weight: 600;
            flex: 1;
        }
        
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-secondary);
        }
        
        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }
        
        .upload-zone.drag-over {
            border-color: var(--accent);
            background: rgba(255, 215, 0, 0.1);
        }
        
        .upload-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .uploaded-media {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .media-item:hover {
            border-color: var(--accent);
        }
        
        .media-item.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            background: rgba(239, 68, 68, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s;
            cursor: pointer;
        }
        
        .media-item:hover .media-remove {
            opacity: 1;
        }
        
        .filter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .filter-btn {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.7rem;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        
        .filter-btn:hover {
            border-color: var(--accent);
        }
        
        .filter-btn.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent);
        }
        
        .template-grid {
            display: grid;
            gap: 0.5rem;
        }
        
        .template-btn {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .template-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .template-name {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }
        
        .template-desc {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .preset-btn {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .preset-btn:hover {
            border-color: var(--accent);
        }
        
        .preset-colors {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
            margin-bottom: 0.5rem;
        }
        
        .preset-color {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
        }
        
        .preset-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .ai-panel {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .ai-panel-title {
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #8b5cf6;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ai-suggestions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .ai-suggestion {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.7rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75rem;
            color: var(--text-primary);
        }
        
        .ai-suggestion:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 0.9rem;
            height: 0.9rem;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hashtags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }
        
        .hashtag {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.3rem 0.7rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .hashtag:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--accent);
        }
        
        .shapes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .shape-btn {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .shape-btn:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }
        
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 0.5rem;
        }
        
        .tab {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            background: var(--accent);
            color: #000;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .projects-list {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .project-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .project-item:hover {
            border-color: var(--accent);
        }
        
        .project-name {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }
        
        .project-date {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        
        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .project-actions button {
            flex: 1;
        }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-tertiary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid #3b82f6; }
        
        .toast-text {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--error);
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
        }
        
        .recording-indicator.active {
            display: flex;
        }
        
        .recording-dot {
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.75rem;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #FFA500 100%);
            width: 0%;
            transition: width 0.3s;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
        
        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 1rem 0;
        }
        
        .font-preview {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <div class="brand">VERTEX MONACO</div>
                <h1 class="title">
                    Video Generator ULTIMATE
                    <span class="version-badge">v3.0 COMPLETE</span>
                </h1>
            </div>
            
            <div class="header-actions">
                <div style="display: flex; gap: 0.5rem;">
                    <button class="icon-btn" onclick="undo()" title="Annuler (Ctrl+Z)" id="undoBtn" disabled>‚Ü∂</button>
                    <button class="icon-btn" onclick="redo()" title="Refaire (Ctrl+Y)" id="redoBtn" disabled>‚Ü∑</button>
                    <button class="icon-btn" onclick="saveProject()" title="Sauvegarder (Ctrl+S)">üíæ</button>
                </div>
                
                <div class="theme-toggle" onclick="toggleTheme()">
                    <button class="theme-toggle-btn active" id="darkBtn">üåô</button>
                    <button class="theme-toggle-btn" id="lightBtn">‚òÄÔ∏è</button>
                </div>
            </div>
        </header>
        
        <div class="workspace">
            <!-- Left Panel: Layers, Media, Templates -->
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchLeftTab(0)">Calques</button>
                    <button class="tab" onclick="switchLeftTab(1)">M√©dias</button>
                    <button class="tab" onclick="switchLeftTab(2)">Assets</button>
                    <button class="tab" onclick="switchLeftTab(3)">Projets</button>
                </div>
                
                <!-- Tab 0: Layers -->
                <div class="tab-content active">
                    <div class="panel-title">üé® Calques</div>
                    
                    <div class="form-group">
                        <div class="grid-3">
                            <button class="btn btn-secondary btn-small" onclick="addTextLayer()">
                                ‚ûï Texte
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="addShapeLayer()">
                                ‚¨ú Forme
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="addImageLayer()">
                                üñºÔ∏è Image
                            </button>
                        </div>
                    </div>
                    
                    <div class="layers-panel" id="layersPanel">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.75rem;">
                            Aucun calque
                        </div>
                    </div>
                </div>
                
                <!-- Tab 1: Media -->
                <div class="tab-content">
                    <div class="panel-title">üìÅ M√©dias</div>
                    
                    <div class="form-group">
                        <div class="upload-zone" id="uploadZone">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÅ</div>
                            <div class="upload-text">
                                <strong>Glissez</strong> vos fichiers<br>
                                ou <strong>cliquez</strong> pour parcourir<br>
                                <small style="font-size: 0.65rem;">Max 5MB par image</small>
                            </div>
                            <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" multiple style="display: none;">
                        </div>
                        <div class="uploaded-media" id="mediaLibrary"></div>
                    </div>
                    
                    <div class="form-group" id="filterSection" style="display: none;">
                        <label class="label">Filtres</label>
                        <div class="filter-controls">
                            <button class="filter-btn active" onclick="applyFilter('none')" data-filter="none">Original</button>
                            <button class="filter-btn" onclick="applyFilter('grayscale')" data-filter="grayscale">N&B</button>
                            <button class="filter-btn" onclick="applyFilter('sepia')" data-filter="sepia">S√©pia</button>
                            <button class="filter-btn" onclick="applyFilter('blur')" data-filter="blur">Flou</button>
                            <button class="filter-btn" onclick="applyFilter('brightness')" data-filter="brightness">Lumineux</button>
                            <button class="filter-btn" onclick="applyFilter('contrast')" data-filter="contrast">Contrast√©</button>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 2: Templates & Presets -->
                <div class="tab-content">
                    <div class="panel-title">‚ú® Assets</div>
                    
                    <div class="form-group">
                        <label class="label">Templates</label>
                        <div class="template-grid">
                            <button class="template-btn" onclick="applyTemplate('product')">
                                <div class="template-name">üéØ Produit</div>
                                <div class="template-desc">Mise en avant solution</div>
                            </button>
                            <button class="template-btn" onclick="applyTemplate('announcement')">
                                <div class="template-name">üì£ Annonce</div>
                                <div class="template-desc">Nouveaut√©s & √©v√©nements</div>
                            </button>
                            <button class="template-btn" onclick="applyTemplate('quote')">
                                <div class="template-name">üí¨ Citation</div>
                                <div class="template-desc">Message inspirant</div>
                            </button>
                            <button class="template-btn" onclick="applyTemplate('stats')">
                                <div class="template-name">üìä Statistique</div>
                                <div class="template-desc">Chiffres cl√©s</div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="form-group">
                        <label class="label">Presets Couleurs</label>
                        <div class="preset-grid">
                            <button class="preset-btn" onclick="applyPreset('vertex')">
                                <div class="preset-colors">
                                    <div class="preset-color" style="background: #020617;"></div>
                                    <div class="preset-color" style="background: #FFD700;"></div>
                                </div>
                                <div class="preset-name">Vertex</div>
                            </button>
                            <button class="preset-btn" onclick="applyPreset('luxe')">
                                <div class="preset-colors">
                                    <div class="preset-color" style="background: #1a1a1a;"></div>
                                    <div class="preset-color" style="background: #C0C0C0;"></div>
                                </div>
                                <div class="preset-name">Luxe</div>
                            </button>
                            <button class="preset-btn" onclick="applyPreset('tech')">
                                <div class="preset-colors">
                                    <div class="preset-color" style="background: #0f172a;"></div>
                                    <div class="preset-color" style="background: #3b82f6;"></div>
                                </div>
                                <div class="preset-name">Tech</div>
                            </button>
                            <button class="preset-btn" onclick="applyPreset('elegant')">
                                <div class="preset-colors">
                                    <div class="preset-color" style="background: #fef3c7;"></div>
                                    <div class="preset-color" style="background: #92400e;"></div>
                                </div>
                                <div class="preset-name">√âl√©gant</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 3: Projects -->
                <div class="tab-content">
                    <div class="panel-title">üíæ Projets</div>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary btn-small" onclick="saveProject()">
                            üíæ Sauvegarder projet actuel
                        </button>
                    </div>
                    
                    <div class="projects-list" id="projectsList">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.75rem;">
                            Aucun projet sauvegard√©
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Panel: Canvas -->
            <div class="panel">
                <div class="panel-title">üëÅÔ∏è Canvas</div>
                
                <div class="form-group">
                    <div class="grid-4" style="margin-bottom: 0.5rem;">
                        <button class="btn btn-secondary btn-small" onclick="setFormat('square')" data-format="square">
                            1:1<br><small style="font-size: 0.6rem;">1080√ó1080</small>
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="setFormat('story')" data-format="story">
                            9:16<br><small style="font-size: 0.6rem;">1080√ó1920</small>
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="setFormat('landscape')" data-format="landscape">
                            16:9<br><small style="font-size: 0.6rem;">1920√ó1080</small>
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="setFormat('vertical')" data-format="vertical">
                            4:5<br><small style="font-size: 0.6rem;">1080√ó1350</small>
                        </button>
                    </div>
                </div>
                
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span id="recordingTime">00:00</span>
                    <span style="margin-left: auto;">Enregistrement...</span>
                </div>
                
                <div class="canvas-wrapper">
                    <div class="canvas-controls">
                        <button class="canvas-btn" onclick="toggleGrid()" title="Grille" id="gridBtn">‚äû</button>
                        <button class="canvas-btn" onclick="zoomIn()" title="Zoom +">üîç+</button>
                        <button class="canvas-btn" onclick="zoomOut()" title="Zoom -">üîç-</button>
                        <button class="canvas-btn" onclick="resetZoom()" title="Reset">‚äô</button>
                    </div>
                    
                    <div id="canvasContainer">
                        <canvas id="previewCanvas"></canvas>
                    </div>
                </div>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label class="label">Dur√©e (s)</label>
                    <div class="slider-group">
                        <input type="range" class="slider" id="totalDuration" min="3" max="30" value="5" oninput="updateTotalDuration()">
                        <input type="number" class="slider-value" id="totalDurationValue" value="5" min="3" max="30" onchange="updateTotalDuration()">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="grid-3">
                        <button class="btn btn-secondary" onclick="playPreview()">‚ñ∂Ô∏è Play</button>
                        <button class="btn" onclick="startRecording()" id="recordBtn">üé¨ WebM</button>
                        <button class="btn btn-secondary" onclick="exportGIF()">üñºÔ∏è GIF</button>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Properties & AI -->
            <div class="panel">
                <div class="panel-title">‚öôÔ∏è Propri√©t√©s</div>
                
                <!-- AI Assistant -->
                <div class="ai-panel">
                    <div class="ai-panel-title">
                        ü§ñ Assistant IA
                    </div>
                    
                    <div class="form-group">
                        <input 
                            type="text" 
                            class="input" 
                            id="aiTopic" 
                            placeholder="Ex: Totem LED 65 pouces pour retail"
                            maxlength="200"
                        >
                    </div>
                    
                    <button class="btn btn-ai btn-small" onclick="generateContent()" id="aiBtn">
                        ‚ú® G√©n√©rer avec IA
                    </button>
                    
                    <div id="aiSuggestions" class="ai-suggestions" style="display: none;"></div>
                </div>
                
                <div id="propertiesPanel">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.75rem;">
                        S√©lectionnez un calque
                    </div>
                </div>
                
                <div class="divider"></div>
                
                <div class="form-group">
                    <label class="label">Hashtags</label>
                    <div class="hashtags" id="hashtags">
                        <span class="hashtag" onclick="copyHashtag(this)">#DigitalSignage</span>
                        <span class="hashtag" onclick="copyHashtag(this)">#Innovation</span>
                        <span class="hashtag" onclick="copyHashtag(this)">#VertexMonaco</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            MAX_FILE_SIZE: 5 * 1024 * 1024,
            ALLOWED_FORMATS: ['image/png', 'image/jpeg', 'image/webp'],
            API_TIMEOUT: 30000,
            MAX_HISTORY: 50,
            FONTS: [
                'Outfit', 'Inter', 'Arial', 'Helvetica', 'Times New Roman', 
                'Georgia', 'Courier New', 'Verdana', 'Impact', 'Comic Sans MS'
            ]
        };
        
        // State
        let canvas, ctx;
        let currentFormat = 'square';
        let zoom = 1;
        let showGrid = false;
        let isDarkMode = true;
        let isRecording = false;
        let mediaRecorder, recordedChunks = [];
        let animationId;
        
        // Layers
        let layers = [];
        let selectedLayerId = null;
        let layerIdCounter = 0;
        
        // Media library
        let mediaLibrary = [];
        let selectedMediaId = null;
        let currentFilter = 'none';
        
        // History
        let history = [];
        let historyIndex = -1;
        
        // Canvas interaction
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragLayerId = null;
        
        const formats = {
            square: { width: 1080, height: 1080 },
            story: { width: 1080, height: 1920 },
            landscape: { width: 1920, height: 1080 },
            vertical: { width: 1080, height: 1350 }
        };
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('previewCanvas');
            ctx = canvas.getContext('2d');
            setFormat('square');
            setupCanvasInteraction();
            setupKeyboardShortcuts();
            setupDragAndDrop();
            loadProjects();
            
            // Add default background
            addBackgroundLayer();
            addTextLayer('VERTEX', { fontSize: 120, fontWeight: 900, y: 450, color: '#FFFFFF' });
            addTextLayer('MONACO', { fontSize: 60, fontWeight: 700, y: 550, color: '#FFD700' });
            
            saveState();
        });
        
        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    redo();
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveProject();
                }
                if (e.key === 'Delete' && selectedLayerId) {
                    deleteLayer(selectedLayerId);
                }
                if (e.key === ' ') {
                    e.preventDefault();
                    playPreview();
                }
            });
        }
        
        // Drag and drop for media upload
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            uploadZone.onclick = () => fileInput.click();
            
            fileInput.onchange = (e) => {
                handleFiles(e.target.files);
            };
            
            uploadZone.ondragover = (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            };
            
            uploadZone.ondragleave = () => {
                uploadZone.classList.remove('drag-over');
            };
            
            uploadZone.ondrop = (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            };
        }
        
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!CONFIG.ALLOWED_FORMATS.includes(file.type)) {
                    showToast('Format non support√©', 'error');
                    return;
                }
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    showToast('Fichier trop volumineux (max 5MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const id = Date.now() + Math.random();
                        mediaLibrary.push({
                            id: id,
                            src: e.target.result,
                            width: img.width,
                            height: img.height,
                            name: file.name
                        });
                        renderMediaLibrary();
                        showToast('Image ajout√©e !', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderMediaLibrary() {
            const container = document.getElementById('mediaLibrary');
            const filterSection = document.getElementById('filterSection');
            
            if (mediaLibrary.length === 0) {
                container.innerHTML = '';
                filterSection.style.display = 'none';
                return;
            }
            
            container.innerHTML = mediaLibrary.map(media => `
                <div class="media-item ${selectedMediaId === media.id ? 'selected' : ''}" 
                     onclick="selectMedia('${media.id}')">
                    <img src="${media.src}" alt="${media.name}">
                    <div class="media-remove" onclick="removeMedia('${media.id}', event)">√ó</div>
                </div>
            `).join('');
            
            if (selectedMediaId) {
                filterSection.style.display = 'block';
            }
        }
        
        function selectMedia(id) {
            selectedMediaId = selectedMediaId === id ? null : id;
            renderMediaLibrary();
            
            const filterSection = document.getElementById('filterSection');
            filterSection.style.display = selectedMediaId ? 'block' : 'none';
        }
        
        function removeMedia(id, event) {
            event.stopPropagation();
            
            if (!confirm('Supprimer cette image ?')) return;
            
            mediaLibrary = mediaLibrary.filter(m => m.id != id);
            if (selectedMediaId == id) {
                selectedMediaId = null;
                document.getElementById('filterSection').style.display = 'none';
            }
            renderMediaLibrary();
            showToast('Image supprim√©e', 'info');
        }
        
        function applyFilter(filterType) {
            currentFilter = filterType;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filterType);
            });
            
            updateCanvas();
            saveState();
        }
        
        function getFilterString() {
            switch(currentFilter) {
                case 'grayscale': return 'grayscale(100%)';
                case 'sepia': return 'sepia(100%)';
                case 'blur': return 'blur(3px)';
                case 'brightness': return 'brightness(1.3)';
                case 'contrast': return 'contrast(1.5)';
                default: return 'none';
            }
        }
        
        // Canvas interaction
        function setupCanvasInteraction() {
            const container = document.getElementById('canvasContainer');
            
            container.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                const layer = getLayerAt(x, y);
                if (layer && !layer.locked) {
                    selectLayer(layer.id);
                    isDragging = true;
                    dragLayerId = layer.id;
                    dragStartX = x - layer.x;
                    dragStartY = y - layer.y;
                    container.style.cursor = 'move';
                    container.classList.add('dragging');
                }
            });
            
            container.addEventListener('mousemove', (e) => {
                if (!isDragging || !dragLayerId) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                const layer = layers.find(l => l.id === dragLayerId);
                if (layer) {
                    layer.x = x - dragStartX;
                    layer.y = y - dragStartY;
                    updateCanvas();
                    updatePropertiesPanel();
                }
            });
            
            container.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    dragLayerId = null;
                    container.style.cursor = 'crosshair';
                    container.classList.remove('dragging');
                    saveState();
                }
            });
            
            container.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    dragLayerId = null;
                    container.style.cursor = 'crosshair';
                    container.classList.remove('dragging');
                }
            });
        }
        
        function getLayerAt(x, y) {
            for (let i = layers.length - 1; i >= 0; i--) {
                const layer = layers[i];
                if (!layer.visible || layer.type === 'background') continue;
                
                if (layer.type === 'text') {
                    ctx.font = `${layer.fontWeight || 400} ${layer.fontSize}px ${layer.fontFamily}`;
                    const metrics = ctx.measureText(layer.text);
                    const width = metrics.width;
                    const height = layer.fontSize;
                    
                    if (x >= layer.x - width/2 && x <= layer.x + width/2 &&
                        y >= layer.y - height/2 && y <= layer.y + height/2) {
                        return layer;
                    }
                } else if (layer.type === 'shape' || layer.type === 'image') {
                    const halfW = layer.width / 2;
                    const halfH = layer.height / 2;
                    
                    if (x >= layer.x - halfW && x <= layer.x + halfW &&
                        y >= layer.y - halfH && y <= layer.y + halfH) {
                        return layer;
                    }
                }
            }
            return null;
        }
        
        // Layer management
        function addBackgroundLayer() {
            const layer = {
                id: layerIdCounter++,
                type: 'background',
                name: 'Fond',
                color: '#020617',
                visible: true,
                locked: false
            };
            
            layers.push(layer);
            updateLayersPanel();
            updateCanvas();
        }
        
        function addTextLayer(text = 'Nouveau texte', options = {}) {
            const layer = {
                id: layerIdCounter++,
                type: 'text',
                name: `Texte ${layers.filter(l => l.type === 'text').length + 1}`,
                text: text,
                x: options.x || canvas.width / 2,
                y: options.y || canvas.height / 2,
                fontSize: options.fontSize || 60,
                fontFamily: options.fontFamily || 'Outfit',
                fontWeight: options.fontWeight || 700,
                color: options.color || '#FFFFFF',
                opacity: 1,
                rotation: 0,
                visible: true,
                locked: false,
                animationType: 'fadeIn',
                animationStart: 0,
                animationDuration: 1,
                shadowBlur: 0,
                shadowColor: '#000000',
                shadowX: 0,
                shadowY: 0,
                strokeWidth: 0,
                strokeColor: '#000000'
            };
            
            layers.push(layer);
            selectLayer(layer.id);
            updateLayersPanel();
            updateCanvas();
            saveState();
            showToast('Calque texte ajout√©', 'success');
        }
        
        function addShapeLayer(shapeType = 'rectangle') {
            const layer = {
                id: layerIdCounter++,
                type: 'shape',
                name: `Forme ${layers.filter(l => l.type === 'shape').length + 1}`,
                shapeType: shapeType,
                x: canvas.width / 2,
                y: canvas.height / 2,
                width: 200,
                height: 200,
                color: '#FFD700',
                opacity: 1,
                rotation: 0,
                visible: true,
                locked: false,
                animationType: 'fadeIn',
                animationStart: 0,
                animationDuration: 1,
                shadowBlur: 0,
                shadowColor: '#000000',
                shadowX: 0,
                shadowY: 0,
                strokeWidth: 0,
                strokeColor: '#000000'
            };
            
            layers.push(layer);
            selectLayer(layer.id);
            updateLayersPanel();
            updateCanvas();
            saveState();
            showToast('Calque forme ajout√©', 'success');
        }
        
        function addImageLayer() {
            if (!selectedMediaId) {
                showToast('S√©lectionnez d\'abord une image dans l\'onglet M√©dias', 'error');
                return;
            }
            
            const media = mediaLibrary.find(m => m.id === selectedMediaId);
            if (!media) return;
            
            const layer = {
                id: layerIdCounter++,
                type: 'image',
                name: `Image ${layers.filter(l => l.type === 'image').length + 1}`,
                imageSrc: media.src,
                x: canvas.width / 2,
                y: canvas.height / 2,
                width: 300,
                height: 300,
                opacity: 1,
                rotation: 0,
                visible: true,
                locked: false,
                filter: currentFilter,
                animationType: 'fadeIn',
                animationStart: 0,
                animationDuration: 1,
                shadowBlur: 0,
                shadowColor: '#000000',
                shadowX: 0,
                shadowY: 0
            };
            
            layers.push(layer);
            selectLayer(layer.id);
            updateLayersPanel();
            updateCanvas();
            saveState();
            showToast('Calque image ajout√©', 'success');
        }
        
        function selectLayer(id) {
            selectedLayerId = id;
            updateLayersPanel();
            updatePropertiesPanel();
            updateCanvas();
        }
        
        function deleteLayer(id) {
            const layer = layers.find(l => l.id === id);
            if (layer && layer.type === 'background') {
                showToast('Impossible de supprimer le fond', 'error');
                return;
            }
            
            if (!confirm('Supprimer ce calque ?')) return;
            
            layers = layers.filter(l => l.id !== id);
            if (selectedLayerId === id) {
                selectedLayerId = null;
            }
            updateLayersPanel();
            updatePropertiesPanel();
            updateCanvas();
            saveState();
            showToast('Calque supprim√©', 'info');
        }
        
        function duplicateLayer(id) {
            const layer = layers.find(l => l.id === id);
            if (!layer || layer.type === 'background') return;
            
            const newLayer = JSON.parse(JSON.stringify(layer));
            newLayer.id = layerIdCounter++;
            newLayer.name = layer.name + ' copie';
            newLayer.x += 20;
            newLayer.y += 20;
            
            layers.push(newLayer);
            selectLayer(newLayer.id);
            updateLayersPanel();
            updateCanvas();
            saveState();
            showToast('Calque dupliqu√©', 'success');
        }
        
        function toggleLayerVisibility(id) {
            const layer = layers.find(l => l.id === id);
            if (layer) {
                layer.visible = !layer.visible;
                updateLayersPanel();
                updateCanvas();
                saveState();
            }
        }
        
        function toggleLayerLock(id) {
            const layer = layers.find(l => l.id === id);
            if (layer) {
                layer.locked = !layer.locked;
                updateLayersPanel();
            }
        }
        
        // UI Updates
        function updateLayersPanel() {
            const panel = document.getElementById('layersPanel');
            
            if (layers.length === 0) {
                panel.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.75rem;">Aucun calque</div>';
                return;
            }
            
            const getIcon = (layer) => {
                if (layer.type === 'text') return 'üìù';
                if (layer.type === 'shape') return '‚¨ú';
                if (layer.type === 'image') return 'üñºÔ∏è';
                if (layer.type === 'background') return 'üé®';
                return 'üìÑ';
            };
            
            panel.innerHTML = [...layers].reverse().map(layer => `
                <div class="layer-item ${selectedLayerId === layer.id ? 'selected' : ''}" onclick="selectLayer(${layer.id})">
                    <div class="layer-icon">${getIcon(layer)}</div>
                    <div class="layer-info">
                        <div class="layer-name">${layer.name}</div>
                        <div class="layer-type">${layer.type}</div>
                    </div>
                    <div class="layer-actions">
                        <button class="layer-btn ${layer.visible ? 'active' : ''}" onclick="event.stopPropagation(); toggleLayerVisibility(${layer.id})" title="Visibilit√©">
                            ${layer.visible ? 'üëÅÔ∏è' : 'üö´'}
                        </button>
                        ${layer.type !== 'background' ? `
                        <button class="layer-btn ${layer.locked ? 'active' : ''}" onclick="event.stopPropagation(); toggleLayerLock(${layer.id})" title="Verrouiller">
                            ${layer.locked ? 'üîí' : 'üîì'}
                        </button>
                        <button class="layer-btn" onclick="event.stopPropagation(); duplicateLayer(${layer.id})" title="Dupliquer">üìã</button>
                        <button class="layer-btn" onclick="event.stopPropagation(); deleteLayer(${layer.id})" title="Supprimer">üóëÔ∏è</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function updatePropertiesPanel() {
            const panel = document.getElementById('propertiesPanel');
            
            if (!selectedLayerId) {
                panel.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.75rem;">S√©lectionnez un calque</div>';
                return;
            }
            
            const layer = layers.find(l => l.id === selectedLayerId);
            if (!layer) return;
            
            if (layer.type === 'background') {
                panel.innerHTML = `
                    <div class="form-group">
                        <label class="label">Couleur de fond</label>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-input" value="${layer.color}" onchange="updateLayerProperty('color', this.value)">
                            <span class="color-label">${layer.color}</span>
                        </div>
                    </div>
                `;
            } else if (layer.type === 'text') {
                panel.innerHTML = `
                    <div class="form-group">
                        <label class="label">Nom du calque</label>
                        <input type="text" class="input" value="${layer.name}" oninput="updateLayerProperty('name', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Texte</label>
                        <textarea class="input" rows="3" oninput="updateLayerProperty('text', this.value)">${layer.text}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Police</label>
                        <select class="select" onchange="updateLayerProperty('fontFamily', this.value)">
                            ${CONFIG.FONTS.map(font => `<option value="${font}" ${layer.fontFamily === font ? 'selected' : ''}>${font}</option>`).join('')}
                        </select>
                        <div class="font-preview" style="font-family: ${layer.fontFamily};">Aper√ßu ${layer.fontFamily}</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Taille (${layer.fontSize}px)</label>
                        <div class="slider-group">
                            <input type="range" class="slider" min="12" max="200" value="${layer.fontSize}" oninput="updateLayerProperty('fontSize', parseInt(this.value))">
                            <input type="number" class="slider-value" value="${layer.fontSize}" min="12" max="200" onchange="updateLayerProperty('fontSize', parseInt(this.value))">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Graisse</label>
                        <select class="select" onchange="updateLayerProperty('fontWeight', parseInt(this.value))">
                            <option value="300" ${layer.fontWeight === 300 ? 'selected' : ''}>Light (300)</option>
                            <option value="400" ${layer.fontWeight === 400 ? 'selected' : ''}>Normal (400)</option>
                            <option value="600" ${layer.fontWeight === 600 ? 'selected' : ''}>SemiBold (600)</option>
                            <option value="700" ${layer.fontWeight === 700 ? 'selected' : ''}>Bold (700)</option>
                            <option value="900" ${layer.fontWeight === 900 ? 'selected' : ''}>Black (900)</option>
                        </select>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="form-group">
                        <label class="label">Position</label>
                        <div class="grid-2">
                            <div>
                                <label class="label" style="font-size: 0.65rem;">X (${Math.round(layer.x)})</label>
                                <input type="range" class="slider" min="0" max="${canvas.width}" value="${layer.x}" oninput="updateLayerProperty('x', parseFloat(this.value))">
                            </div>
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Y (${Math.round(layer.y)})</label>
                                <input type="range" class="slider" min="0" max="${canvas.height}" value="${layer.y}" oninput="updateLayerProperty('y', parseFloat(this.value))">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Rotation (${layer.rotation}¬∞)</label>
                        <input type="range" class="slider" min="-180" max="180" value="${layer.rotation}" oninput="updateLayerProperty('rotation', parseFloat(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Opacit√© (${Math.round(layer.opacity * 100)}%)</label>
                        <input type="range" class="slider" min="0" max="1" step="0.01" value="${layer.opacity}" oninput="updateLayerProperty('opacity', parseFloat(this.value))">
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="form-group">
                        <label class="label">Couleur</label>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-input" value="${layer.color}" onchange="updateLayerProperty('color', this.value)">
                            <span class="color-label">${layer.color}</span>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="panel-title" style="font-size: 0.7rem; margin-top: 1rem;">EFFETS</div>
                    
                    <div class="form-group">
                        <label class="label">Contour (${layer.strokeWidth}px)</label>
                        <div class="slider-group">
                            <input type="range" class="slider" min="0" max="20" value="${layer.strokeWidth}" oninput="updateLayerProperty('strokeWidth', parseFloat(this.value))">
                            <input type="number" class="slider-value" value="${layer.strokeWidth}" min="0" max="20" onchange="updateLayerProperty('strokeWidth', parseFloat(this.value))">
                        </div>
                    </div>
                    
                    ${layer.strokeWidth > 0 ? `
                    <div class="form-group">
                        <label class="label">Couleur contour</label>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-input" value="${layer.strokeColor}" onchange="updateLayerProperty('strokeColor', this.value)">
                            <span class="color-label">${layer.strokeColor}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="form-group">
                        <label class="label">Ombre (${layer.shadowBlur}px)</label>
                        <div class="slider-group">
                            <input type="range" class="slider" min="0" max="50" value="${layer.shadowBlur}" oninput="updateLayerProperty('shadowBlur', parseFloat(this.value))">
                            <input type="number" class="slider-value" value="${layer.shadowBlur}" min="0" max="50" onchange="updateLayerProperty('shadowBlur', parseFloat(this.value))">
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="panel-title" style="font-size: 0.7rem; margin-top: 1rem;">ANIMATION</div>
                    
                    <div class="form-group">
                        <label class="label">Type</label>
                        <select class="select" onchange="updateLayerProperty('animationType', this.value)">
                            <option value="none" ${layer.animationType === 'none' ? 'selected' : ''}>Aucune</option>
                            <option value="fadeIn" ${layer.animationType === 'fadeIn' ? 'selected' : ''}>Apparition</option>
                            <option value="slideUp" ${layer.animationType === 'slideUp' ? 'selected' : ''}>Glissement haut</option>
                            <option value="slideDown" ${layer.animationType === 'slideDown' ? 'selected' : ''}>Glissement bas</option>
                            <option value="slideLeft" ${layer.animationType === 'slideLeft' ? 'selected' : ''}>Glissement gauche</option>
                            <option value="slideRight" ${layer.animationType === 'slideRight' ? 'selected' : ''}>Glissement droite</option>
                            <option value="scale" ${layer.animationType === 'scale' ? 'selected' : ''}>Zoom</option>
                            <option value="rotate" ${layer.animationType === 'rotate' ? 'selected' : ''}>Rotation</option>
                            <option value="bounce" ${layer.animationType === 'bounce' ? 'selected' : ''}>Rebond</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">D√©but (${layer.animationStart}s)</label>
                        <input type="range" class="slider" min="0" max="10" step="0.1" value="${layer.animationStart}" oninput="updateLayerProperty('animationStart', parseFloat(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Dur√©e (${layer.animationDuration}s)</label>
                        <input type="range" class="slider" min="0.1" max="5" step="0.1" value="${layer.animationDuration}" oninput="updateLayerProperty('animationDuration', parseFloat(this.value))">
                    </div>
                `;
            } else if (layer.type === 'shape') {
                panel.innerHTML = `
                    <div class="form-group">
                        <label class="label">Nom du calque</label>
                        <input type="text" class="input" value="${layer.name}" oninput="updateLayerProperty('name', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Forme</label>
                        <div class="shapes-grid">
                            <button class="shape-btn ${layer.shapeType === 'rectangle' ? 'active' : ''}" onclick="updateLayerProperty('shapeType', 'rectangle')">‚¨ú</button>
                            <button class="shape-btn ${layer.shapeType === 'circle' ? 'active' : ''}" onclick="updateLayerProperty('shapeType', 'circle')">‚≠ï</button>
                            <button class="shape-btn ${layer.shapeType === 'triangle' ? 'active' : ''}" onclick="updateLayerProperty('shapeType', 'triangle')">‚ñ≤</button>
                            <button class="shape-btn ${layer.shapeType === 'star' ? 'active' : ''}" onclick="updateLayerProperty('shapeType', 'star')">‚≠ê</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Dimensions</label>
                        <div class="grid-2">
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Largeur (${Math.round(layer.width)})</label>
                                <input type="range" class="slider" min="10" max="1000" value="${layer.width}" oninput="updateLayerProperty('width', parseFloat(this.value))">
                            </div>
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Hauteur (${Math.round(layer.height)})</label>
                                <input type="range" class="slider" min="10" max="1000" value="${layer.height}" oninput="updateLayerProperty('height', parseFloat(this.value))">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Position</label>
                        <div class="grid-2">
                            <div>
                                <label class="label" style="font-size: 0.65rem;">X (${Math.round(layer.x)})</label>
                                <input type="range" class="slider" min="0" max="${canvas.width}" value="${layer.x}" oninput="updateLayerProperty('x', parseFloat(this.value))">
                            </div>
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Y (${Math.round(layer.y)})</label>
                                <input type="range" class="slider" min="0" max="${canvas.height}" value="${layer.y}" oninput="updateLayerProperty('y', parseFloat(this.value))">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Rotation (${layer.rotation}¬∞)</label>
                        <input type="range" class="slider" min="-180" max="180" value="${layer.rotation}" oninput="updateLayerProperty('rotation', parseFloat(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Opacit√© (${Math.round(layer.opacity * 100)}%)</label>
                        <input type="range" class="slider" min="0" max="1" step="0.01" value="${layer.opacity}" oninput="updateLayerProperty('opacity', parseFloat(this.value))">
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="form-group">
                        <label class="label">Couleur</label>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-input" value="${layer.color}" onchange="updateLayerProperty('color', this.value)">
                            <span class="color-label">${layer.color}</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Contour (${layer.strokeWidth}px)</label>
                        <div class="slider-group">
                            <input type="range" class="slider" min="0" max="20" value="${layer.strokeWidth}" oninput="updateLayerProperty('strokeWidth', parseFloat(this.value))">
                            <input type="number" class="slider-value" value="${layer.strokeWidth}" min="0" max="20" onchange="updateLayerProperty('strokeWidth', parseFloat(this.value))">
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="panel-title" style="font-size: 0.7rem; margin-top: 1rem;">ANIMATION</div>
                    
                    <div class="form-group">
                        <label class="label">Type</label>
                        <select class="select" onchange="updateLayerProperty('animationType', this.value)">
                            <option value="none" ${layer.animationType === 'none' ? 'selected' : ''}>Aucune</option>
                            <option value="fadeIn" ${layer.animationType === 'fadeIn' ? 'selected' : ''}>Apparition</option>
                            <option value="scale" ${layer.animationType === 'scale' ? 'selected' : ''}>Zoom</option>
                            <option value="rotate" ${layer.animationType === 'rotate' ? 'selected' : ''}>Rotation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">D√©but (${layer.animationStart}s)</label>
                        <input type="range" class="slider" min="0" max="10" step="0.1" value="${layer.animationStart}" oninput="updateLayerProperty('animationStart', parseFloat(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Dur√©e (${layer.animationDuration}s)</label>
                        <input type="range" class="slider" min="0.1" max="5" step="0.1" value="${layer.animationDuration}" oninput="updateLayerProperty('animationDuration', parseFloat(this.value))">
                    </div>
                `;
            } else if (layer.type === 'image') {
                panel.innerHTML = `
                    <div class="form-group">
                        <label class="label">Nom du calque</label>
                        <input type="text" class="input" value="${layer.name}" oninput="updateLayerProperty('name', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Dimensions</label>
                        <div class="grid-2">
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Largeur (${Math.round(layer.width)})</label>
                                <input type="range" class="slider" min="10" max="1000" value="${layer.width}" oninput="updateLayerProperty('width', parseFloat(this.value))">
                            </div>
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Hauteur (${Math.round(layer.height)})</label>
                                <input type="range" class="slider" min="10" max="1000" value="${layer.height}" oninput="updateLayerProperty('height', parseFloat(this.value))">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Position</label>
                        <div class="grid-2">
                            <div>
                                <label class="label" style="font-size: 0.65rem;">X (${Math.round(layer.x)})</label>
                                <input type="range" class="slider" min="0" max="${canvas.width}" value="${layer.x}" oninput="updateLayerProperty('x', parseFloat(this.value))">
                            </div>
                            <div>
                                <label class="label" style="font-size: 0.65rem;">Y (${Math.round(layer.y)})</label>
                                <input type="range" class="slider" min="0" max="${canvas.height}" value="${layer.y}" oninput="updateLayerProperty('y', parseFloat(this.value))">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Rotation (${layer.rotation}¬∞)</label>
                        <input type="range" class="slider" min="-180" max="180" value="${layer.rotation}" oninput="updateLayerProperty('rotation', parseFloat(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Opacit√© (${Math.round(layer.opacity * 100)}%)</label>
                        <input type="range" class="slider" min="0" max="1" step="0.01" value="${layer.opacity}" oninput="updateLayerProperty('opacity', parseFloat(this.value))">
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="panel-title" style="font-size: 0.7rem; margin-top: 1rem;">ANIMATION</div>
                    
                    <div class="form-group">
                        <label class="label">Type</label>
                        <select class="select" onchange="updateLayerProperty('animationType', this.value)">
                            <option value="none" ${layer.animationType === 'none' ? 'selected' : ''}>Aucune</option>
                            <option value="fadeIn" ${layer.animationType === 'fadeIn' ? 'selected' : ''}>Apparition</option>
                            <option value="scale" ${layer.animationType === 'scale' ? 'selected' : ''}>Zoom</option>
                            <option value="rotate" ${layer.animationType === 'rotate' ? 'selected' : ''}>Rotation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="label">D√©but (${layer.animationStart}s)</label>
                        <input type="range" class="slider" min="0" max="10" step="0.1" value="${layer.animationStart}" oninput="updateLayerProperty('animationStart', parseFloat(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label class="label">Dur√©e (${layer.animationDuration}s)</label>
                        <input type="range" class="slider" min="0.1" max="5" step="0.1" value="${layer.animationDuration}" oninput="updateLayerProperty('animationDuration', parseFloat(this.value))">
                    </div>
                `;
            }
        }
        
        function updateLayerProperty(property, value) {
            const layer = layers.find(l => l.id === selectedLayerId);
            if (layer) {
                layer[property] = value;
                updatePropertiesPanel();
                updateCanvas();
                
                if (!['x', 'y', 'width', 'height', 'rotation', 'opacity', 'fontSize', 'shadowBlur', 'strokeWidth', 'shadowX', 'shadowY'].includes(property)) {
                    saveState();
                }
            }
        }
        
        // Canvas drawing
        function updateCanvas() {
            if (!ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw layers
            layers.forEach(layer => {
                if (!layer.visible) return;
                drawLayer(layer);
            });
            
            // Selection indicator
            if (selectedLayerId) {
                const layer = layers.find(l => l.id === selectedLayerId);
                if (layer && layer.visible && layer.type !== 'background') {
                    drawSelectionBox(layer);
                }
            }
            
            // Grid
            if (showGrid) {
                drawGrid();
            }
        }
        
        function drawLayer(layer, progress = 1) {
            ctx.save();
            
            if (layer.type === 'background') {
                ctx.fillStyle = layer.color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                return;
            }
            
            // Animation
            let animProgress = 1;
            if (layer.animationType !== 'none' && progress < 1) {
                const totalDuration = parseFloat(document.getElementById('totalDuration').value);
                const currentTime = progress * totalDuration;
                
                if (currentTime >= layer.animationStart) {
                    const elapsed = currentTime - layer.animationStart;
                    animProgress = Math.min(elapsed / layer.animationDuration, 1);
                } else {
                    animProgress = 0;
                }
            }
            
            ctx.translate(layer.x, layer.y);
            ctx.rotate((layer.rotation * Math.PI) / 180);
            
            if (layer.animationType !== 'none') {
                applyAnimation(layer, animProgress);
            }
            
            ctx.globalAlpha = layer.opacity;
            
            if (layer.shadowBlur > 0) {
                ctx.shadowColor = layer.shadowColor;
                ctx.shadowBlur = layer.shadowBlur;
                ctx.shadowOffsetX = layer.shadowX;
                ctx.shadowOffsetY = layer.shadowY;
            }
            
            if (layer.type === 'text') {
                ctx.font = `${layer.fontWeight} ${layer.fontSize}px ${layer.fontFamily}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (layer.strokeWidth > 0) {
                    ctx.strokeStyle = layer.strokeColor;
                    ctx.lineWidth = layer.strokeWidth;
                    ctx.strokeText(layer.text, 0, 0);
                }
                
                ctx.fillStyle = layer.color;
                ctx.fillText(layer.text, 0, 0);
                
            } else if (layer.type === 'shape') {
                if (layer.strokeWidth > 0) {
                    ctx.strokeStyle = layer.strokeColor;
                    ctx.lineWidth = layer.strokeWidth;
                }
                
                ctx.fillStyle = layer.color;
                drawShape(layer);
                
            } else if (layer.type === 'image') {
                const img = new Image();
                img.src = layer.imageSrc;
                
                if (layer.filter && layer.filter !== 'none') {
                    ctx.filter = getFilterString();
                }
                
                ctx.drawImage(img, -layer.width/2, -layer.height/2, layer.width, layer.height);
            }
            
            ctx.restore();
        }
        
        function drawShape(layer) {
            const halfW = layer.width / 2;
            const halfH = layer.height / 2;
            
            ctx.beginPath();
            
            switch (layer.shapeType) {
                case 'rectangle':
                    ctx.rect(-halfW, -halfH, layer.width, layer.height);
                    break;
                    
                case 'circle':
                    const radius = Math.min(halfW, halfH);
                    ctx.arc(0, 0, radius, 0, Math.PI * 2);
                    break;
                    
                case 'triangle':
                    ctx.moveTo(0, -halfH);
                    ctx.lineTo(halfW, halfH);
                    ctx.lineTo(-halfW, halfH);
                    ctx.closePath();
                    break;
                    
                case 'star':
                    const spikes = 5;
                    const outerRadius = Math.min(halfW, halfH);
                    const innerRadius = outerRadius / 2;
                    
                    for (let i = 0; i < spikes * 2; i++) {
                        const radius = i % 2 === 0 ? outerRadius : innerRadius;
                        const angle = (i * Math.PI) / spikes - Math.PI / 2;
                        const x = Math.cos(angle) * radius;
                        const y = Math.sin(angle) * radius;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.closePath();
                    break;
            }
            
            ctx.fill();
            if (layer.strokeWidth > 0) {
                ctx.stroke();
            }
        }
        
        function applyAnimation(layer, progress) {
            switch (layer.animationType) {
                case 'fadeIn':
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'slideUp':
                    ctx.translate(0, (1 - progress) * 100);
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'slideDown':
                    ctx.translate(0, -(1 - progress) * 100);
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'slideLeft':
                    ctx.translate((1 - progress) * 100, 0);
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'slideRight':
                    ctx.translate(-(1 - progress) * 100, 0);
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'scale':
                    const scale = 0.5 + (progress * 0.5);
                    ctx.scale(scale, scale);
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'rotate':
                    ctx.rotate((1 - progress) * Math.PI * 2);
                    ctx.globalAlpha *= progress;
                    break;
                    
                case 'bounce':
                    const bounce = Math.abs(Math.sin(progress * Math.PI * 2)) * (1 - progress) * 50;
                    ctx.translate(0, -bounce);
                    ctx.globalAlpha *= progress;
                    break;
            }
        }
        
        function drawSelectionBox(layer) {
            ctx.save();
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            
            ctx.translate(layer.x, layer.y);
            ctx.rotate((layer.rotation * Math.PI) / 180);
            
            if (layer.type === 'text') {
                ctx.font = `${layer.fontWeight} ${layer.fontSize}px ${layer.fontFamily}`;
                const metrics = ctx.measureText(layer.text);
                const width = metrics.width;
                const height = layer.fontSize;
                
                ctx.strokeRect(-width/2 - 10, -height/2 - 10, width + 20, height + 20);
            } else if (layer.type === 'shape' || layer.type === 'image') {
                const halfW = layer.width / 2;
                const halfH = layer.height / 2;
                ctx.strokeRect(-halfW - 10, -halfH - 10, layer.width + 20, layer.height + 20);
            }
            
            ctx.restore();
        }
        
        function drawGrid() {
            ctx.save();
            ctx.strokeStyle = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            ctx.restore();
        }
        
        // Canvas controls
        function toggleGrid() {
            showGrid = !showGrid;
            document.getElementById('gridBtn').classList.toggle('active', showGrid);
            updateCanvas();
        }
        
        function zoomIn() {
            zoom = Math.min(zoom * 1.2, 3);
            applyZoom();
        }
        
        function zoomOut() {
            zoom = Math.max(zoom / 1.2, 0.5);
            applyZoom();
        }
        
        function resetZoom() {
            zoom = 1;
            applyZoom();
        }
        
        function applyZoom() {
            canvas.style.transform = `scale(${zoom})`;
        }
        
        // Format
        function setFormat(format) {
            currentFormat = format;
            const dims = formats[format];
            canvas.width = dims.width;
            canvas.height = dims.height;
            
            document.querySelectorAll('[data-format]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.format === format);
            });
            
            // Reposition layers proportionally
            layers.forEach(layer => {
                if (layer.type !== 'background') {
                    layer.x = (layer.x / canvas.width) * dims.width || dims.width / 2;
                    layer.y = (layer.y / canvas.height) * dims.height || dims.height / 2;
                }
            });
            
            updateCanvas();
            saveState();
        }
        
        // Templates
        function applyTemplate(template) {
            // Clear non-background layers
            layers = layers.filter(l => l.type === 'background');
            
            const templates = {
                product: {
                    title: 'NOUVELLE SOLUTION',
                    subtitle: 'Digital Signage',
                    desc: 'D√©couvrez nos √©crans LED haute d√©finition'
                },
                announcement: {
                    title: 'ANNONCE',
                    subtitle: '√âv√©nement √† venir',
                    desc: 'Rejoignez-nous pour la d√©monstration'
                },
                quote: {
                    title: 'INNOVATION',
                    subtitle: "L'avenir de l'affichage",
                    desc: '"Transformez votre communication"'
                },
                stats: {
                    title: '+300%',
                    subtitle: 'Visibilit√©',
                    desc: 'Augmentez votre impact visuel'
                }
            };
            
            const t = templates[template];
            addTextLayer(t.title, { fontSize: 120, fontWeight: 900, y: 400, color: '#FFFFFF' });
            addTextLayer(t.subtitle, { fontSize: 60, fontWeight: 700, y: 500, color: '#FFD700' });
            addTextLayer(t.desc, { fontSize: 40, fontWeight: 400, y: 600, color: '#94a3b8' });
            
            showToast('Template appliqu√© !', 'success');
        }
        
        // Color presets
        function applyPreset(preset) {
            const presets = {
                vertex: { bg: '#020617', accent: '#FFD700' },
                luxe: { bg: '#1a1a1a', accent: '#C0C0C0' },
                tech: { bg: '#0f172a', accent: '#3b82f6' },
                elegant: { bg: '#fef3c7', accent: '#92400e' }
            };
            
            const p = presets[preset];
            
            const bgLayer = layers.find(l => l.type === 'background');
            if (bgLayer) {
                bgLayer.color = p.bg;
            }
            
            // Update accent colors
            layers.forEach(layer => {
                if (layer.type !== 'background' && layer.color === '#FFD700') {
                    layer.color = p.accent;
                }
            });
            
            updateCanvas();
            saveState();
            showToast('Preset appliqu√© !', 'success');
        }
        
        // AI Content Generation
        async function generateContent() {
            const topic = document.getElementById('aiTopic').value.trim();
            if (!topic) {
                showToast('Entrez un th√®me !', 'error');
                return;
            }
            
            const btn = document.getElementById('aiBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> G√©n√©ration...';
            
            const suggestionsDiv = document.getElementById('aiSuggestions');
            suggestionsDiv.style.display = 'block';
            suggestionsDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><span class="loading-spinner"></span></div>';
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `Tu es un expert en marketing digital pour VERTEX Monaco, soci√©t√© de luxe sp√©cialis√©e dans le digital signage premium.

G√©n√®re 3 variantes de contenu vid√©o pour: "${topic}"

Pour chaque variante:
- Titre percutant (2-3 mots MAX, MAJUSCULES)
- Sous-titre accrocheur (3-5 mots)
- Description courte (10-15 mots MAX)
- 4 hashtags pertinents

Format JSON uniquement:
{
  "variants": [
    {
      "title": "TITRE 1",
      "subtitle": "sous-titre 1",
      "description": "description courte 1",
      "hashtags": ["#tag1", "#tag2", "#tag3", "#tag4"]
    }
  ]
}

UNIQUEMENT le JSON, rien d'autre.`
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.content && data.content[0]) {
                    let jsonText = data.content[0].text;
                    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const content = JSON.parse(jsonText);
                    displayAISuggestions(content.variants);
                    showToast('Contenu g√©n√©r√© !', 'success');
                } else {
                    throw new Error('R√©ponse invalide');
                }
                
            } catch (error) {
                console.error('AI Error:', error);
                suggestionsDiv.innerHTML = `
                    <div style="padding: 1rem; color: #ef4444; font-size: 0.75rem;">
                        ‚ö†Ô∏è Erreur lors de la g√©n√©ration
                    </div>
                `;
                showToast('Erreur IA', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        function displayAISuggestions(variants) {
            const suggestionsDiv = document.getElementById('aiSuggestions');
            
            let html = '';
            variants.forEach((variant, index) => {
                html += `
                    <div class="ai-suggestion" onclick='applyAISuggestion(${JSON.stringify(variant).replace(/'/g, "&apos;")})'>
                        <strong>${variant.title}</strong><br>
                        <small style="color: var(--text-secondary);">${variant.subtitle}</small>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
        }
        
        function applyAISuggestion(variant) {
            // Clear non-background layers
            layers = layers.filter(l => l.type === 'background');
            
            addTextLayer(variant.title, { fontSize: 120, fontWeight: 900, y: 400, color: '#FFFFFF' });
            addTextLayer(variant.subtitle, { fontSize: 60, fontWeight: 700, y: 500, color: '#FFD700' });
            addTextLayer(variant.description, { fontSize: 40, fontWeight: 400, y: 600, color: '#94a3b8' });
            
            const hashtagsDiv = document.getElementById('hashtags');
            hashtagsDiv.innerHTML = variant.hashtags.map(tag => 
                `<span class="hashtag" onclick="copyHashtag(this)">${tag}</span>`
            ).join('');
            
            showToast('Suggestion appliqu√©e !', 'success');
        }
        
        function copyHashtag(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copi√©: ' + text, 'success');
            });
        }
        
        // Animation
        function playPreview() {
            const duration = parseFloat(document.getElementById('totalDuration').value) * 1000;
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                layers.forEach(layer => {
                    if (layer.visible) {
                        drawLayer(layer, progress);
                    }
                });
                
                if (showGrid) {
                    drawGrid();
                }
                
                if (progress < 1) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    updateCanvas();
                }
            }
            
            animate();
        }
        
        function updateTotalDuration() {
            const slider = document.getElementById('totalDuration');
            const input = document.getElementById('totalDurationValue');
            
            if (document.activeElement === input) {
                slider.value = input.value;
            } else {
                input.value = slider.value;
            }
        }
        
        // Recording
        async function startRecording() {
            const btn = document.getElementById('recordBtn');
            
            if (isRecording) {
                stopRecording();
                return;
            }
            
            try {
                const stream = canvas.captureStream(30);
                
                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm';
                }
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 8000000
                });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vertex-video-${Date.now()}.webm`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    document.getElementById('recordingIndicator').classList.remove('active');
                    document.getElementById('progressBar').classList.remove('active');
                    
                    showToast('Vid√©o export√©e !', 'success');
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                btn.textContent = '‚èπÔ∏è Stop';
                btn.classList.add('btn-danger');
                btn.classList.remove('btn');
                
                document.getElementById('recordingIndicator').classList.add('active');
                document.getElementById('progressBar').classList.add('active');
                
                const duration = parseFloat(document.getElementById('totalDuration').value) * 1000;
                const startTime = Date.now();
                
                function animate() {
                    if (!isRecording) return;
                    
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const seconds = Math.floor(elapsed / 1000);
                    const ms = Math.floor((elapsed % 1000) / 10);
                    document.getElementById('recordingTime').textContent = 
                        `${String(seconds).padStart(2, '0')}:${String(ms).padStart(2, '0')}`;
                    
                    document.getElementById('progressFill').style.width = (progress * 100) + '%';
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    layers.forEach(layer => {
                        if (layer.visible) {
                            drawLayer(layer, progress);
                        }
                    });
                    
                    if (progress < 1) {
                        animationId = requestAnimationFrame(animate);
                    } else {
                        stopRecording();
                    }
                }
                
                animate();
                
            } catch (err) {
                console.error('Recording error:', err);
                showToast('Erreur: ' + err.message, 'error');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                const btn = document.getElementById('recordBtn');
                btn.textContent = 'üé¨ WebM';
                btn.classList.add('btn');
                btn.classList.remove('btn-danger');
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                updateCanvas();
            }
        }
        
        function exportGIF() {
            showToast('G√©n√©ration GIF...', 'info');
            
            try {
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: canvas.width,
                    height: canvas.height,
                    workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
                });
                
                const duration = parseFloat(document.getElementById('totalDuration').value) * 1000;
                const fps = 15;
                const frames = Math.floor(duration / 1000 * fps);
                
                for (let i = 0; i < frames; i++) {
                    const progress = i / frames;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    layers.forEach(layer => {
                        if (layer.visible) {
                            drawLayer(layer, progress);
                        }
                    });
                    
                    gif.addFrame(canvas, { delay: 1000 / fps, copy: true });
                }
                
                gif.on('finished', (blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vertex-video-${Date.now()}.gif`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    updateCanvas();
                    showToast('GIF export√© !', 'success');
                });
                
                gif.on('progress', (progress) => {
                    showToast(`G√©n√©ration: ${Math.round(progress * 100)}%`, 'info');
                });
                
                gif.render();
            } catch (error) {
                console.error('GIF export error:', error);
                showToast('Erreur d\'export GIF', 'error');
            }
        }
        
        // History
        function saveState() {
            const state = {
                layers: JSON.parse(JSON.stringify(layers)),
                selectedLayerId,
                currentFormat,
                isDarkMode,
                showGrid,
                mediaLibrary,
                selectedMediaId,
                currentFilter
            };
            
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.stringify(state));
            historyIndex++;
            
            if (history.length > CONFIG.MAX_HISTORY) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                loadState(history[historyIndex]);
                showToast('Annul√©', 'info');
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                loadState(history[historyIndex]);
                showToast('Refait', 'info');
            }
        }
        
        function loadState(stateStr) {
            const state = JSON.parse(stateStr);
            
            layers = state.layers;
            selectedLayerId = state.selectedLayerId;
            currentFormat = state.currentFormat;
            isDarkMode = state.isDarkMode;
            showGrid = state.showGrid;
            mediaLibrary = state.mediaLibrary || [];
            selectedMediaId = state.selectedMediaId || null;
            currentFilter = state.currentFilter || 'none';
            
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('darkBtn').classList.toggle('active', isDarkMode);
            document.getElementById('lightBtn').classList.toggle('active', !isDarkMode);
            document.getElementById('gridBtn').classList.toggle('active', showGrid);
            
            setFormat(currentFormat);
            updateLayersPanel();
            updatePropertiesPanel();
            renderMediaLibrary();
            updateCanvas();
            updateHistoryButtons();
        }
        
        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = historyIndex <= 0;
            document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
        }
        
        // Project management
        function saveProject() {
            const name = prompt('Nom du projet:', `VERTEX-${Date.now()}`);
            if (!name) return;
            
            const project = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                state: {
                    layers,
                    currentFormat,
                    isDarkMode,
                    showGrid,
                    mediaLibrary,
                    selectedMediaId,
                    currentFilter
                }
            };
            
            let projects = JSON.parse(localStorage.getItem('vertex_projects_complete') || '[]');
            projects.unshift(project);
            
            if (projects.length > 20) {
                projects = projects.slice(0, 20);
            }
            
            localStorage.setItem('vertex_projects_complete', JSON.stringify(projects));
            
            loadProjects();
            showToast('Projet sauvegard√© !', 'success');
        }
        
        function loadProjects() {
            const projects = JSON.parse(localStorage.getItem('vertex_projects_complete') || '[]');
            const container = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.75rem;">Aucun projet sauvegard√©</div>';
                return;
            }
            
            container.innerHTML = projects.map(project => `
                <div class="project-item">
                    <div class="project-name">${project.name}</div>
                    <div class="project-date">${new Date(project.date).toLocaleDateString('fr-FR')}</div>
                    <div class="project-actions">
                        <button class="btn btn-secondary btn-small" onclick="loadProject(${project.id})">
                            üìÇ Charger
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="deleteProject(${project.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function loadProject(id) {
            const projects = JSON.parse(localStorage.getItem('vertex_projects_complete') || '[]');
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            const state = project.state;
            layers = state.layers;
            currentFormat = state.currentFormat;
            isDarkMode = state.isDarkMode;
            showGrid = state.showGrid;
            mediaLibrary = state.mediaLibrary || [];
            selectedMediaId = state.selectedMediaId || null;
            currentFilter = state.currentFilter || 'none';
            
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('darkBtn').classList.toggle('active', isDarkMode);
            document.getElementById('lightBtn').classList.toggle('active', !isDarkMode);
            
            setFormat(currentFormat);
            updateLayersPanel();
            updatePropertiesPanel();
            renderMediaLibrary();
            updateCanvas();
            saveState();
            
            showToast('Projet charg√© !', 'success');
        }
        
        function deleteProject(id) {
            if (!confirm('Supprimer ce projet ?')) return;
            
            let projects = JSON.parse(localStorage.getItem('vertex_projects_complete') || '[]');
            projects = projects.filter(p => p.id !== id);
            localStorage.setItem('vertex_projects_complete', JSON.stringify(projects));
            
            loadProjects();
            showToast('Projet supprim√©', 'info');
        }
        
        // Theme
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode');
            
            document.getElementById('darkBtn').classList.toggle('active', isDarkMode);
            document.getElementById('lightBtn').classList.toggle('active', !isDarkMode);
            
            const bgLayer = layers.find(l => l.type === 'background');
            if (bgLayer) {
                bgLayer.color = isDarkMode ? '#020617' : '#f8fafc';
            }
            
            updateCanvas();
            saveState();
        }
        
        // Tabs
        function switchLeftTab(index) {
            const tabs = document.querySelectorAll('.workspace > .panel:first-child .tabs .tab');
            const contents = document.querySelectorAll('.workspace > .panel:first-child .tab-content');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            
            toast.innerHTML = `
                <span style="font-size: 1.1rem;">${icon}</span>
                <span class="toast-text">${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });
            });
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
